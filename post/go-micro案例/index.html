<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>Go Micro案例 | abin の 成长之路</title>
    <meta property="og:title" content="Go Micro案例 - abin の 成长之路">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2022-03-27T16:34:46&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2022-03-27T16:34:46&#43;08:00'>
        
    <meta name="Keywords" content="golang,go语言,go语言笔记,博客,项目管理,软件架构">
    <meta name="description" content="Go Micro案例">
        
    <meta name="author" content="abin">
    <meta property="og:url" content="https://kevinbin123.github.io/post/go-micro%E6%A1%88%E4%BE%8B/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
        <link rel="stylesheet" href='/css/sidebar_menu.css'>
    
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://kevinbin123.github.io/">
                        abin の 成长之路
                    </a>
                
                <p class="description">冉冉升起的码神</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://kevinbin123.github.io/">首页</a>
                    
                    <a  href="https://kevinbin123.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="https://kevinbin123.github.io/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">Go Micro案例</h1>
        </header>
        
  <time datetime="2022-03-27T08:34:46Z" class="post-meta meta-date dt-published">
    2022年3月27日
  </time>


<div class="post-meta meta-category">
  <span>&nbsp;|</span>
  
    <a href='/categories/Golang' target="_blank">Golang</a>
  
</div>


        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">&nbsp;|
                <span id="busuanzi_value_page_pv"></span> <span>阅读</span>
            </span>
        </div>
        
        
        <div class="post-content">
            <h1 id="go-micro案例简单备忘录">go-micro案例：简单备忘录</h1>
<blockquote>
<p>案例来源：[小生凡一]的博文</p>
<p><a href="https://blog.csdn.net/weixin_45304503/article/details/122286980?spm=1001.2014.3001.5501">https://blog.csdn.net/weixin_45304503/article/details/122286980?spm=1001.2014.3001.5501</a></p>
</blockquote>
<p>案例的流程大概如下图所示：</p>
<p>
        <img class="mx-auto" alt="备忘录流程图" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/%E5%A4%87%E5%BF%98%E5%BD%95%E6%B5%81%E7%A8%8B%E5%9B%BE.png" />   
    </p>
<h2 id="准备工作">准备工作</h2>
<p>protoc相关：</p>
<p>1、protoc</p>
<p>用于生成序列化结构的数据格式</p>
<p>下载地址：https://github.com/protocolbuffers/protobuf/releases</p>
<p>
        <img class="mx-auto" alt="image-20220325142126253" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/image-20220325142126253.png" />   
    </p>
<p>并将protoc下的bin目录路径添加到环境变量path中</p>
<p>2、protobuf</p>
<p>protoc-gen-go是protobuf编译插件系列中的go版本；</p>
<p>通过<code>go get github.com/golang/protobuf</code> 进行下载；如果go get不下来，可以使用git clone源码；然后到protoc-gen-go目录下；<code>go build</code>生成protoc-gen-go.exe；然后将protoc-gen-go.exe复制到protoc下的bin目录中。</p>
<p>
        <img class="mx-auto" alt="image-20220325142702185" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/image-20220325142702185.png" />   
    </p>
<p>3、go-micro</p>
<p>使用的是v2这个版本；使用<code>go get github.com/micro/go-micro/v2</code> 进行下载</p>
<p>
        <img class="mx-auto" alt="image-20220325143240201" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/image-20220325143240201.png" />   
    </p>
<p>4、protoc-gen-micro</p>
<p>使用<code>go get -u github.com/micro/protoc-gen-micro</code> 进行下载；下载后进行build；然后将protoc-gen-micro.exe复制到protoc的bin目录下。</p>
<p>
        <img class="mx-auto" alt="image-20220325143635177" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/image-20220325143635177.png" />   
    </p>
<p>5、etcd</p>
<p>下载地址：https://github.com/etcd-io/etcd/releases</p>
<p>6、etcdkeeper</p>
<p>下载地址：https://github.com/evildecay/etcdkeeper/releases/tag/v0.7.6</p>
<p>7、rabbitmq</p>
<p>安装地址，参考https://blog.csdn.net/qq_47588845/article/details/107986373</p>
<p>使用命令，参考https://blog.csdn.net/a18679016236/article/details/84965212</p>
<p>rabbitmq的一些消息模型，参考https://blog.csdn.net/weixin_45304503/article/details/122405835?spm=1001.2014.3001.5502</p>
<h2 id="user模块用户模块">User模块（用户模块）</h2>
<h3 id="数据库相关配置">数据库相关配置</h3>
<p>1、准备配置文件user/conf/conf.ini</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#66d9ef">[service]</span>
<span style="color:#a6e22e">AppMode</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">debug</span>
<span style="color:#a6e22e">HttpPort</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">:3000</span>

<span style="color:#66d9ef">[mysql]</span>
<span style="color:#a6e22e">Db</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">mysql</span>
<span style="color:#a6e22e">DbHost</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">127.0.0.1</span>
<span style="color:#a6e22e">DbPort</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">3306</span>
<span style="color:#a6e22e">DbUser</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">root</span>
<span style="color:#a6e22e">DbPassWord</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">123456</span>
<span style="color:#a6e22e">DbName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">micro_todo_list</span>
</code></pre></div><p>2、读取配置文件</p>
<p>user/conf/conf.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">conf</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;gopkg.in/ini.v1&#34;</span>
	<span style="color:#e6db74">&#34;strings&#34;</span>
	<span style="color:#e6db74">&#34;user/model&#34;</span>
)

<span style="color:#66d9ef">var</span> (
	<span style="color:#a6e22e">Db</span>         <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">DbHost</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">DbPort</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">DbUser</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">DbPassWord</span> <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">DbName</span>     <span style="color:#66d9ef">string</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Init</span>() {
	<span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ini</span>.<span style="color:#a6e22e">Load</span>(<span style="color:#e6db74">&#34;./conf/conf.ini&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;配置文件读取错误，请检查：&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">LoadMysqlData</span>(<span style="color:#a6e22e">file</span>)
	<span style="color:#a6e22e">path</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Join</span>([]<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">DbUser</span>, <span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#a6e22e">DbPassWord</span>, <span style="color:#e6db74">&#34;@tcp(&#34;</span>, <span style="color:#a6e22e">DbHost</span>, <span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#a6e22e">DbPort</span>, <span style="color:#e6db74">&#34;)/&#34;</span>, <span style="color:#a6e22e">DbName</span>, <span style="color:#e6db74">&#34;?charset=utf8&amp;parseTime=true&#34;</span>}, <span style="color:#e6db74">&#34;&#34;</span>)
	<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Database</span>(<span style="color:#a6e22e">path</span>)
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">LoadMysqlData</span>(<span style="color:#a6e22e">file</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ini</span>.<span style="color:#a6e22e">File</span>) {
	<span style="color:#a6e22e">Db</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;Db&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">DbHost</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;DbHost&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">DbPort</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;DbPort&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">DbUser</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;DbUser&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">DbPassWord</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;DbPassWord&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">DbName</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;DbName&#34;</span>).<span style="color:#a6e22e">String</span>()
}
</code></pre></div><p>3、连接mysql数据库</p>
<p>user/model/init.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">model</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
	<span style="color:#e6db74">&#34;github.com/jinzhu/gorm&#34;</span>
	<span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;github.com/jinzhu/gorm/dialects/mysql&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">DB</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">DB</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Database</span>(<span style="color:#a6e22e">path</span> <span style="color:#66d9ef">string</span>) {
	<span style="color:#a6e22e">db</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>, <span style="color:#a6e22e">path</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">path</span>)
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#75715e">//输出详细信息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">LogMode</span>(<span style="color:#66d9ef">true</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Mode</span>() <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;release&#34;</span> {
		<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">LogMode</span>(<span style="color:#66d9ef">false</span>)
	}
	<span style="color:#75715e">//默认不加复数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">SingularTable</span>(<span style="color:#66d9ef">true</span>)
	<span style="color:#75715e">//设置连接池
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//空闲连接数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">DB</span>().<span style="color:#a6e22e">SetMaxIdleConns</span>(<span style="color:#ae81ff">20</span>)
	<span style="color:#75715e">//最多打开连接数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">DB</span>().<span style="color:#a6e22e">SetMaxOpenConns</span>(<span style="color:#ae81ff">100</span>)
	<span style="color:#75715e">//超时时间
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">DB</span>().<span style="color:#a6e22e">SetConnMaxLifetime</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">30</span>)
	<span style="color:#a6e22e">DB</span> = <span style="color:#a6e22e">db</span>
	<span style="color:#a6e22e">migration</span>()
}
</code></pre></div><p>4、定义user数据结构、并且实现密码加密和验证密码功能</p>
<p>user/model/user.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">model</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;github.com/jinzhu/gorm&#34;</span>
	<span style="color:#e6db74">&#34;golang.org/x/crypto/bcrypt&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">Model</span>
	<span style="color:#a6e22e">UserName</span>       <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`gorm:&#34;unique&#34;`</span>
	<span style="color:#a6e22e">PasswordDigest</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#75715e">// 密码加密难度
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">PasswordCost</span> = <span style="color:#ae81ff">12</span>

<span style="color:#75715e">//密码加密
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">user</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>) <span style="color:#a6e22e">SetPassword</span>(<span style="color:#a6e22e">password</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bcrypt</span>.<span style="color:#a6e22e">GenerateFromPassword</span>([]byte(<span style="color:#a6e22e">password</span>), <span style="color:#a6e22e">PasswordCost</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">PasswordDigest</span> = string(<span style="color:#a6e22e">bytes</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">//验证密码
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">user</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>) <span style="color:#a6e22e">CheckPassword</span>(<span style="color:#a6e22e">password</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bcrypt</span>.<span style="color:#a6e22e">CompareHashAndPassword</span>([]byte(<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">PasswordDigest</span>), []byte(<span style="color:#a6e22e">password</span>))
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span>
}

</code></pre></div><p>5、将表结构迁移到数据库</p>
<p>user/model/migration.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">model</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">migration</span>() {
	<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">`gorm:table_options`</span>, <span style="color:#e6db74">&#34;charset=utf8mb4&#34;</span>).<span style="color:#a6e22e">AutoMigrate</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">User</span>{})
}
</code></pre></div><h3 id="proto文件编译">proto文件编译</h3>
<p>1、编写proto文件</p>
<p>user/services/protos/userModels.proto</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">syntax<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;proto3&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> services;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">option</span> go_package<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./;protos&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">UserModel</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">uint32</span> ID<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> UserName<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">int64</span> CreatedAt<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">int64</span> UpdatedAt<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">int64</span> DeletedAt<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>user/services/protos/userService.proto</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">syntax<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;proto3&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> services;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#34;userModels.proto&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">option</span> go_package<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./;protos&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">UserRequest</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> UserName<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> Password<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> PasswordConfirm<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">UserDetaiResponse</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  UserModel UserDetail<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">uint32</span> Code<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">service</span> UserService{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">rpc</span> UserLogin(UserRequest) <span style="color:#66d9ef">returns</span> (UserDetaiResponse);<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">rpc</span> UserRegister(UserRequest) <span style="color:#66d9ef">returns</span> (UserDetaiResponse);<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>2、到protos目录下生成go文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">protoc</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">proto_path</span>=. <span style="color:#f92672">--</span><span style="color:#a6e22e">micro_out</span>=. <span style="color:#f92672">--</span><span style="color:#a6e22e">go_out</span>=. <span style="color:#f92672">*</span>.<span style="color:#a6e22e">proto</span>
</code></pre></div><p>3、将生成的文件移动到services目录下</p>
<p>
        <img class="mx-auto" alt="image-20220325171412251" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/image-20220325171412251.png" />   
    </p>
<h3 id="实现用户模块的逻辑">实现用户模块的逻辑</h3>
<p>1、定义UserService结构体，用来实现rpc中定义的登录和注册方法</p>
<p>user/core/pkg.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">core</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UserService</span> <span style="color:#66d9ef">struct</span> {
}
</code></pre></div><p>2、实现登录、注册方法</p>
<p>user/core/userService.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">core</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;errors&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/jinzhu/gorm&#34;</span>
	<span style="color:#e6db74">&#34;user/model&#34;</span>
	<span style="color:#e6db74">&#34;user/services&#34;</span>
)

<span style="color:#75715e">//构建usermodel
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BuildUser</span>(<span style="color:#a6e22e">u</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">User</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">UserModel</span> {
	<span style="color:#a6e22e">userModel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">UserModel</span>{
		<span style="color:#a6e22e">ID</span>:        uint32(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">ID</span>),
		<span style="color:#a6e22e">UserName</span>:  <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">UserName</span>,
		<span style="color:#a6e22e">CreatedAt</span>: <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">CreatedAt</span>.<span style="color:#a6e22e">Unix</span>(),
		<span style="color:#a6e22e">UpdatedAt</span>: <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">UpdatedAt</span>.<span style="color:#a6e22e">Unix</span>(),
	}
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">userModel</span>
}

<span style="color:#75715e">//实现注册方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">UserService</span>) <span style="color:#a6e22e">UserRegister</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">UserRequest</span>, <span style="color:#a6e22e">resp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">UserDetaiResponse</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Password</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">PasswordConfirm</span> {
		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;两次密码输入不一致&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">count</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">Model</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">User</span>{}).<span style="color:#a6e22e">Where</span>(<span style="color:#e6db74">&#34;user_name = ?&#34;</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">UserName</span>).<span style="color:#a6e22e">Count</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">count</span>).<span style="color:#a6e22e">Error</span>; <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">count</span> &gt; <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;用户已存在&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">user</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">User</span>{
		<span style="color:#a6e22e">UserName</span>: <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">UserName</span>,
	}
	<span style="color:#75715e">//加密密码
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">SetPassword</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Password</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>).<span style="color:#a6e22e">Error</span>; <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">UserDetail</span> = <span style="color:#a6e22e">BuildUser</span>(<span style="color:#a6e22e">user</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">//实现登录方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">UserService</span>) <span style="color:#a6e22e">UserLogin</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">UserRequest</span>, <span style="color:#a6e22e">resp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">UserDetaiResponse</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;已进入user/userLogin中&#34;</span>)
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">user</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">User</span>
	<span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Code</span> = <span style="color:#ae81ff">200</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">Where</span>(<span style="color:#e6db74">&#34;user_name = ?&#34;</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">UserName</span>).<span style="color:#a6e22e">First</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>).<span style="color:#a6e22e">Error</span>; <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">IsRecordNotFoundError</span>(<span style="color:#a6e22e">err</span>) {
			<span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Code</span> = <span style="color:#ae81ff">400</span>
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%s not found&#34;</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">UserName</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
		}
		<span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Code</span> = <span style="color:#ae81ff">500</span>
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">user</span>.<span style="color:#a6e22e">CheckPassword</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Password</span>) {
		<span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Code</span> = <span style="color:#ae81ff">400</span>
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%s password not right&#34;</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">UserName</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}
	<span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">UserDetail</span> = <span style="color:#a6e22e">BuildUser</span>(<span style="color:#a6e22e">user</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><h3 id="接入到etcd服务发现">接入到etcd服务发现</h3>
<p>user/main.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;github.com/micro/go-micro/v2&#34;</span>
	<span style="color:#e6db74">&#34;github.com/micro/go-micro/v2/registry&#34;</span>
	<span style="color:#e6db74">&#34;github.com/micro/go-micro/v2/registry/etcd&#34;</span>
	<span style="color:#e6db74">&#34;user/conf&#34;</span>
	<span style="color:#e6db74">&#34;user/core&#34;</span>
	<span style="color:#e6db74">&#34;user/services&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">conf</span>.<span style="color:#a6e22e">Init</span>()
	<span style="color:#75715e">//etcd注册
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">etcdReg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">etcd</span>.<span style="color:#a6e22e">NewRegistry</span>(<span style="color:#a6e22e">registry</span>.<span style="color:#a6e22e">Addrs</span>(<span style="color:#e6db74">&#34;127.0.0.1:2379&#34;</span>))
	<span style="color:#75715e">//得到微服务实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">microService</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">micro</span>.<span style="color:#a6e22e">NewService</span>(
		<span style="color:#a6e22e">micro</span>.<span style="color:#a6e22e">Name</span>(<span style="color:#e6db74">&#34;rpcUserService&#34;</span>), <span style="color:#75715e">//微服务名字
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">micro</span>.<span style="color:#a6e22e">Address</span>(<span style="color:#e6db74">&#34;127.0.0.1:8082&#34;</span>),
		<span style="color:#a6e22e">micro</span>.<span style="color:#a6e22e">Registry</span>(<span style="color:#a6e22e">etcdReg</span>), <span style="color:#75715e">//etcd注册件
</span><span style="color:#75715e"></span>	)
	<span style="color:#75715e">//初始化
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">microService</span>.<span style="color:#a6e22e">Init</span>()
	<span style="color:#75715e">//服务注册
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">RegisterUserServiceHandler</span>(<span style="color:#a6e22e">microService</span>.<span style="color:#a6e22e">Server</span>(), new(<span style="color:#a6e22e">core</span>.<span style="color:#a6e22e">UserService</span>))
	<span style="color:#75715e">//启动微服务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">microService</span>.<span style="color:#a6e22e">Run</span>()
}
</code></pre></div><h3 id="user模块文件目录结构">User模块文件目录结构</h3>
<pre tabindex="0"><code>user
    │  go.mod
    │  go.sum
    │  main.go
    │
    ├─conf
    │      conf.go
    │      conf.ini
    │
    ├─core
    │      pkg.go
    │      userService.go
    │
    ├─model
    │      init.go
    │      migration.go
    │      user.go
    │
    └─services
        │  userModels.pb.go
        │  userModels.pb.micro.go
        │  userService.pb.go
        │  userService.pb.micro.go
        │
        └─protos
                userModels.proto
                userService.proto
</code></pre><ul>
<li>conf：配置信息</li>
<li>core：业务逻辑</li>
<li>model：数据库模型</li>
<li>service：proto文件以及各服务</li>
</ul>
<h3 id="运行">运行</h3>
<p>1、连接到mysql中，创建micro_todo_list数据库</p>
<p>2、开启etcd和etcdkeeper</p>
<p>3、使用命令<code>go run main.go --registry=etcd --registry_address=127.0.0.1:2379</code> 运行</p>
<p>看到如下效果为正确</p>
<p>
        <img class="mx-auto" alt="image-20220321175627502" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/image-20220321175627502.png" />   
    </p>
<h2 id="task模块备忘录模块">Task模块（备忘录模块）</h2>
<h3 id="数据库相关配置-1">数据库相关配置</h3>
<p>1、准备配置文件</p>
<p>task/conf/conf.ini</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#66d9ef">[service]</span>
<span style="color:#a6e22e">AppMode</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">debug</span>
<span style="color:#a6e22e">HttpPort</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">:3000</span>

<span style="color:#66d9ef">[mysql]</span>
<span style="color:#a6e22e">Db</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">mysql</span>
<span style="color:#a6e22e">DbHost</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">127.0.0.1</span>
<span style="color:#a6e22e">DbPort</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">3306</span>
<span style="color:#a6e22e">DbUser</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">root</span>
<span style="color:#a6e22e">DbPassWord</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">123456</span>
<span style="color:#a6e22e">DbName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">micro_todo_list</span>

<span style="color:#66d9ef">[rabbitmq]</span>
<span style="color:#a6e22e">RabbitMQ</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">amqp</span>
<span style="color:#a6e22e">RabbitMQUser</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">guest</span>
<span style="color:#a6e22e">RabbitMQPassWord</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">guest</span>
<span style="color:#a6e22e">RabbitMQHost</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">localhost</span>
<span style="color:#a6e22e">RabbitMQPort</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">5672</span>
</code></pre></div><p>2、读取配置文件</p>
<p>task/conf/conf.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">conf</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;gopkg.in/ini.v1&#34;</span>
	<span style="color:#e6db74">&#34;strings&#34;</span>
	<span style="color:#e6db74">&#34;task/model&#34;</span>
)

<span style="color:#66d9ef">var</span> (
	<span style="color:#a6e22e">Db</span>         <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">DbHost</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">DbPort</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">DbUser</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">DbPassWord</span> <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">DbName</span>     <span style="color:#66d9ef">string</span>

	<span style="color:#a6e22e">RabbitMQ</span>         <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">RabbitMQUser</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">RabbitMQPassWord</span> <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">RabbitMQHost</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">RabbitMQPort</span>     <span style="color:#66d9ef">string</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Init</span>() {

	<span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ini</span>.<span style="color:#a6e22e">Load</span>(<span style="color:#e6db74">&#34;./conf/conf.ini&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;读取配置文件错误，err=&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">LoadMysql</span>(<span style="color:#a6e22e">file</span>)
	<span style="color:#75715e">//mysql连接格式root:password@tcp(&#34;127.0.0.1:3306&#34;)/库名?charset=utf8&amp;parseTime=true
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pathMySql</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Join</span>([]<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">DbUser</span>, <span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#a6e22e">DbPassWord</span>, <span style="color:#e6db74">&#34;@tcp(&#34;</span>, <span style="color:#a6e22e">DbHost</span>, <span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#a6e22e">DbPort</span>, <span style="color:#e6db74">&#34;)/&#34;</span>, <span style="color:#a6e22e">DbName</span>, <span style="color:#e6db74">&#34;?charset=utf8&amp;parseTime=true&#34;</span>}, <span style="color:#e6db74">&#34;&#34;</span>)
	<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Database</span>(<span style="color:#a6e22e">pathMySql</span>)
	<span style="color:#a6e22e">Loadrabbitmq</span>(<span style="color:#a6e22e">file</span>)
	<span style="color:#75715e">//rabbitmq连接格式amqp://guest:guest@127.0.0.1:5672/&#34;
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pathRabbitMQ</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Join</span>([]<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">RabbitMQ</span>, <span style="color:#e6db74">&#34;://&#34;</span>, <span style="color:#a6e22e">RabbitMQUser</span>, <span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#a6e22e">RabbitMQPassWord</span>, <span style="color:#e6db74">&#34;@&#34;</span>, <span style="color:#a6e22e">RabbitMQHost</span>, <span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#a6e22e">RabbitMQPort</span>, <span style="color:#e6db74">&#34;/&#34;</span>}, <span style="color:#e6db74">&#34;&#34;</span>)
	<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">RabbitMQ</span>(<span style="color:#a6e22e">pathRabbitMQ</span>)

}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">LoadMysql</span>(<span style="color:#a6e22e">file</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ini</span>.<span style="color:#a6e22e">File</span>) {
	<span style="color:#a6e22e">Db</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;Db&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">DbHost</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;DbHost&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">DbPort</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;DbPort&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">DbUser</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;DbUser&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">DbPassWord</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;DbPassWord&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">DbName</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;DbName&#34;</span>).<span style="color:#a6e22e">String</span>()
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Loadrabbitmq</span>(<span style="color:#a6e22e">file</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ini</span>.<span style="color:#a6e22e">File</span>) {
	<span style="color:#a6e22e">RabbitMQ</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;rabbitmq&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;RabbitMQ&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">RabbitMQUser</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;rabbitmq&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;RabbitMQUser&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">RabbitMQPassWord</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;rabbitmq&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;RabbitMQPassWord&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">RabbitMQHost</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;rabbitmq&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;RabbitMQHost&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">RabbitMQPort</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;rabbitmq&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;RabbitMQPort&#34;</span>).<span style="color:#a6e22e">String</span>()
}
</code></pre></div><p>3、连接mysql数据库</p>
<p>task/model/mysql_init.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">model</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
	<span style="color:#e6db74">&#34;github.com/jinzhu/gorm&#34;</span>
	<span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;github.com/jinzhu/gorm/dialects/mysql&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">DB</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">DB</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Database</span>(<span style="color:#a6e22e">path</span> <span style="color:#66d9ef">string</span>) {
	<span style="color:#a6e22e">db</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>, <span style="color:#a6e22e">path</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">LogMode</span>(<span style="color:#66d9ef">true</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Mode</span>() <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;release&#34;</span> {
		<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">LogMode</span>(<span style="color:#66d9ef">false</span>)
	}
	<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">SingularTable</span>(<span style="color:#66d9ef">true</span>)
	<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">DB</span>().<span style="color:#a6e22e">SetMaxIdleConns</span>(<span style="color:#ae81ff">20</span>)
	<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">DB</span>().<span style="color:#a6e22e">SetMaxOpenConns</span>(<span style="color:#ae81ff">100</span>)
	<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">DB</span>().<span style="color:#a6e22e">SetConnMaxLifetime</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">30</span>)
	<span style="color:#a6e22e">DB</span> = <span style="color:#a6e22e">db</span>
	<span style="color:#a6e22e">migration</span>()
}
</code></pre></div><p>4、连接rabbitmq消息队列</p>
<p>task/model/mq_init.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">model</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;github.com/streadway/amqp&#34;</span>

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">MQ</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">amqp</span>.<span style="color:#a6e22e">Connection</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">RabbitMQ</span>(<span style="color:#a6e22e">path</span> <span style="color:#66d9ef">string</span>) {
	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">amqp</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#a6e22e">path</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">MQ</span> = <span style="color:#a6e22e">conn</span>
}
</code></pre></div><p>5、定义task数据结构</p>
<p>task/model/task.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">model</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;github.com/jinzhu/gorm&#34;</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Task</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">Model</span>
	<span style="color:#a6e22e">Uid</span>       <span style="color:#66d9ef">uint</span>   <span style="color:#e6db74">`gorm:&#34;not null&#34;`</span>
	<span style="color:#a6e22e">Title</span>     <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`gorm:&#34;index; not null&#34;`</span>
	<span style="color:#a6e22e">Status</span>    <span style="color:#66d9ef">int</span>    <span style="color:#e6db74">`gorm:&#34;default:&#39;0&#39;&#34;`</span>
	<span style="color:#a6e22e">Content</span>   <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`gorm:&#34;type:longtext&#34;`</span>
	<span style="color:#a6e22e">StartTime</span> <span style="color:#66d9ef">int64</span>
	<span style="color:#a6e22e">EndTime</span>   <span style="color:#66d9ef">int64</span> <span style="color:#e6db74">`gorm:&#34;default:&#39;0&#39;&#34;`</span>
}
</code></pre></div><p>6、将task数据结构迁移到mysql中</p>
<p>task/model/migration.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">model</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">migration</span>() {
	<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;gorm:table_option&#34;</span>, <span style="color:#e6db74">&#34;charset=utf8mb4&#34;</span>).<span style="color:#a6e22e">AutoMigrate</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Task</span>{})
}
</code></pre></div><h3 id="proto文件编译-1">proto文件编译</h3>
<p>1、编写proto文件</p>
<p>task/services/protos/taskModels.proto</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">syntax<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;proto3&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> services;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">option</span> go_package <span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./;protos&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">TaskModel</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">uint64</span> Id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">//@inject_tag: json:&#34;Uid&#34; form:&#34;Uid&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">uint64</span> Uid <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">//@inject_tag: json:&#34;Title&#34; form:&#34;Title&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">string</span> Title <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">//@inject_tag: json:&#34;Content&#34; form:&#34;Content&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">string</span> Content <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">//@inject_tag: json:&#34;StartTime&#34; form:&#34;StartTime&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int64</span> StartTime <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">//@inject_tag: json:&#34;EndTime&#34; form:&#34;EndTime&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int64</span> EndTime <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">//@inject_tag: json:&#34;Status&#34; form:&#34;Status&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int64</span> Status <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">//@inject_tag: json:&#34;CreateTime&#34; form:&#34;CreateTime&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int64</span> CreateTime <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">//@inject_tag: json:&#34;UpdateTime&#34; form:&#34;UpdateTime&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int64</span> UpdateTime <span style="color:#f92672">=</span> <span style="color:#ae81ff">9</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>task/services/protos/taskService.proto</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">syntax<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;proto3&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> services;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#34;taskModels.proto&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">option</span> go_package <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./;protos&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">TaskRequest</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">//@inject_tag: json:&#34;Id&#34; form:&#34;Id&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">uint64</span> Id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">//@inject_tag: json:&#34;Uid&#34; form:&#34;Uid&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">uint64</span> Uid <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">//@inject_tag: json:&#34;Title&#34; form:&#34;Title&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">string</span> Title <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">//@inject_tag: json:&#34;Content&#34; form:&#34;Content&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">string</span> Content <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">//@inject_tag: json:&#34;StartTime&#34; form:&#34;StartTime&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int64</span> StartTime <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">//@inject_tag: json:&#34;EndTime&#34; form:&#34;EndTime&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int64</span> EndTime <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">//@inject_tag: json:&#34;Status&#34; form:&#34;Status&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int64</span> Status <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">// @inject_tag: json:&#34;Start&#34; form:&#34;Start&#34; uri:&#34;Start&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">uint32</span> Start <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">// @inject_tag: json:&#34;Limit&#34; form:&#34;Limit&#34; uri:&#34;Limit&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">uint32</span> Limit <span style="color:#f92672">=</span> <span style="color:#ae81ff">9</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">TaskListResponse</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">repeated</span> TaskModel TaskList<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">// @inject_tag: json:&#34;Count&#34;
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">uint32</span> Count<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">TaskDetailResponse</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  TaskModel TaskDetail<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">service</span> TaskService{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">rpc</span> CreateTask(TaskRequest) <span style="color:#66d9ef">returns</span>(TaskDetailResponse);<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">rpc</span> GetTasksList(TaskRequest) <span style="color:#66d9ef">returns</span>(TaskListResponse);<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">rpc</span> GetTask(TaskRequest) <span style="color:#66d9ef">returns</span>(TaskDetailResponse);<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">rpc</span> UpdateTask(TaskRequest) <span style="color:#66d9ef">returns</span>(TaskDetailResponse);<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">rpc</span> DeleteTask(TaskRequest) <span style="color:#66d9ef">returns</span>(TaskDetailResponse);<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>2、到protos目录下生成go文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">protoc</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">proto_path</span>=. <span style="color:#f92672">--</span><span style="color:#a6e22e">micro_out</span>=. <span style="color:#f92672">--</span><span style="color:#a6e22e">go_out</span>=. <span style="color:#f92672">*</span>.<span style="color:#a6e22e">proto</span>
</code></pre></div><p>3、将生成的文件移动到services目录下</p>
<p>
        <img class="mx-auto" alt="image-20220325173848412" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/image-20220325173848412.png" />   
    </p>
<h3 id="实现备忘录模块的逻辑">实现备忘录模块的逻辑</h3>
<p>1、定义TaskService实现，用来实现rpc中的创建、获取、修改、删除task的方法</p>
<p>task/core/pkg.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">core</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">TaskService</span> <span style="color:#66d9ef">struct</span> {
}
</code></pre></div><p>2、序列化taskModel</p>
<p>task/core/taskSerializer.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">core</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;task/model&#34;</span>
	<span style="color:#e6db74">&#34;task/services&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BuildTask</span>(<span style="color:#a6e22e">item</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Task</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskModel</span> {
	<span style="color:#a6e22e">taskModel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskModel</span>{
		<span style="color:#a6e22e">Id</span>:         uint64(<span style="color:#a6e22e">item</span>.<span style="color:#a6e22e">ID</span>),
		<span style="color:#a6e22e">Uid</span>:        uint64(<span style="color:#a6e22e">item</span>.<span style="color:#a6e22e">Uid</span>),
		<span style="color:#a6e22e">Title</span>:      <span style="color:#a6e22e">item</span>.<span style="color:#a6e22e">Title</span>,
		<span style="color:#a6e22e">Content</span>:    <span style="color:#a6e22e">item</span>.<span style="color:#a6e22e">Content</span>,
		<span style="color:#a6e22e">StartTime</span>:  <span style="color:#a6e22e">item</span>.<span style="color:#a6e22e">StartTime</span>,
		<span style="color:#a6e22e">EndTime</span>:    <span style="color:#a6e22e">item</span>.<span style="color:#a6e22e">EndTime</span>,
		<span style="color:#a6e22e">Status</span>:     int64(<span style="color:#a6e22e">item</span>.<span style="color:#a6e22e">Status</span>),
		<span style="color:#a6e22e">CreateTime</span>: <span style="color:#a6e22e">item</span>.<span style="color:#a6e22e">CreatedAt</span>.<span style="color:#a6e22e">Unix</span>(),
		<span style="color:#a6e22e">UpdateTime</span>: <span style="color:#a6e22e">item</span>.<span style="color:#a6e22e">UpdatedAt</span>.<span style="color:#a6e22e">Unix</span>(),
	}
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">taskModel</span>
}
</code></pre></div><p>3、实现创建、获取、修改、删除task的方法</p>
<p>task/core/taskService.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">core</span>

<span style="color:#f92672">import</span> (
   <span style="color:#e6db74">&#34;context&#34;</span>
   <span style="color:#e6db74">&#34;encoding/json&#34;</span>
   <span style="color:#e6db74">&#34;errors&#34;</span>
   <span style="color:#e6db74">&#34;github.com/streadway/amqp&#34;</span>
   <span style="color:#e6db74">&#34;task/model&#34;</span>
   <span style="color:#e6db74">&#34;task/services&#34;</span>
)

<span style="color:#75715e">// 创建备忘录，将备忘录信息生产，放到rabbitMQ消息队列中
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">TaskService</span>) <span style="color:#a6e22e">CreateTask</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskRequest</span>, <span style="color:#a6e22e">resp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskDetailResponse</span>) <span style="color:#66d9ef">error</span> {
   <span style="color:#75715e">//连接通道
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">ch</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">MQ</span>.<span style="color:#a6e22e">Channel</span>()
   <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
      <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;rabbitMq err:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
   }
   <span style="color:#75715e">//声明通道队列
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">q</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ch</span>.<span style="color:#a6e22e">QueueDeclare</span>(<span style="color:#e6db74">&#34;task_queue&#34;</span>, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>)
   <span style="color:#75715e">//将请求的参数序列化，发布到队列中
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">body</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">req</span>)
   <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">ch</span>.<span style="color:#a6e22e">Publish</span>(<span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">q</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">amqp</span>.<span style="color:#a6e22e">Publishing</span>{
      <span style="color:#a6e22e">DeliveryMode</span>: <span style="color:#a6e22e">amqp</span>.<span style="color:#a6e22e">Persistent</span>,
      <span style="color:#a6e22e">ContentType</span>:  <span style="color:#e6db74">&#34;application/json&#34;</span>,
      <span style="color:#a6e22e">Body</span>:         <span style="color:#a6e22e">body</span>,
   })
   <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
      <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;rabbitMq publish err:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
   }
   <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// 实现备忘录服务接口 获取备忘录列表
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">TaskService</span>) <span style="color:#a6e22e">GetTasksList</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskRequest</span>, <span style="color:#a6e22e">resp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskListResponse</span>) <span style="color:#66d9ef">error</span> {
   <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Limit</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
      <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Limit</span> = <span style="color:#ae81ff">6</span>
   }
   <span style="color:#75715e">//查找数据库
</span><span style="color:#75715e"></span>   <span style="color:#75715e">//查找备忘录数据
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">productData</span> []<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Task</span>
   <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">count</span> <span style="color:#66d9ef">uint32</span>
   <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">Offset</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Start</span>).<span style="color:#a6e22e">Limit</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Limit</span>).<span style="color:#a6e22e">Where</span>(<span style="color:#e6db74">&#34;uid = ?&#34;</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Uid</span>).<span style="color:#a6e22e">Find</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">productData</span>).<span style="color:#a6e22e">Error</span>
   <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
      <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;mysql find productData err：&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
   }
   <span style="color:#75715e">//统计数量
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">Model</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Task</span>{}).<span style="color:#a6e22e">Where</span>(<span style="color:#e6db74">&#34;uid=?&#34;</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Uid</span>).<span style="color:#a6e22e">Count</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">count</span>).<span style="color:#a6e22e">Error</span>
   <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
      <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;mysql find count err：&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
   }
   <span style="color:#75715e">//序列化备忘录列表
</span><span style="color:#75715e"></span>   <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">taskRes</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskModel</span>
   <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">item</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">productData</span> {
      <span style="color:#a6e22e">taskRes</span> = append(<span style="color:#a6e22e">taskRes</span>, <span style="color:#a6e22e">BuildTask</span>(<span style="color:#a6e22e">item</span>))
   }
   <span style="color:#75715e">//序列化后的结果返回给response
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">TaskList</span> = <span style="color:#a6e22e">taskRes</span>
   <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Count</span> = <span style="color:#a6e22e">count</span>
   <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// 获取详细的备忘录
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">TaskService</span>) <span style="color:#a6e22e">GetTask</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskRequest</span>, <span style="color:#a6e22e">resp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskDetailResponse</span>) <span style="color:#66d9ef">error</span> {
   <span style="color:#a6e22e">taskData</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Task</span>{}
   <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">First</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">taskData</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Id</span>)
   <span style="color:#a6e22e">taskRes</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">BuildTask</span>(<span style="color:#a6e22e">taskData</span>)
   <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">TaskDetail</span> = <span style="color:#a6e22e">taskRes</span>
   <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// 修改备忘录
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">TaskService</span>) <span style="color:#a6e22e">UpdateTask</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskRequest</span>, <span style="color:#a6e22e">resp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskDetailResponse</span>) <span style="color:#66d9ef">error</span> {
   <span style="color:#a6e22e">taskData</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Task</span>{}
   <span style="color:#75715e">//查找这条记录
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">Model</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Task</span>{}).<span style="color:#a6e22e">Where</span>(<span style="color:#e6db74">&#34;id = ? and  uid= ?&#34;</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Id</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Uid</span>).<span style="color:#a6e22e">First</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">taskData</span>)
   <span style="color:#75715e">//更新这条记录
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">taskData</span>.<span style="color:#a6e22e">Title</span> = <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Title</span>
   <span style="color:#a6e22e">taskData</span>.<span style="color:#a6e22e">Content</span> = <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Content</span>
   <span style="color:#a6e22e">taskData</span>.<span style="color:#a6e22e">Status</span> = int(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Status</span>)
   <span style="color:#75715e">//保存
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">Save</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">taskData</span>)
   <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">TaskDetail</span> = <span style="color:#a6e22e">BuildTask</span>(<span style="color:#a6e22e">taskData</span>)
   <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// 删除备忘录
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#f92672">*</span><span style="color:#a6e22e">TaskService</span>) <span style="color:#a6e22e">DeleteTask</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskRequest</span>, <span style="color:#a6e22e">resp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskDetailResponse</span>) <span style="color:#66d9ef">error</span> {
   <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">Model</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Task</span>{}).<span style="color:#a6e22e">Find</span>(<span style="color:#e6db74">&#34;id=? and uid=?&#34;</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Id</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Uid</span>).<span style="color:#a6e22e">Delete</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Task</span>{}).<span style="color:#a6e22e">Error</span>
   <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;删除失败:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
   }
   <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><h3 id="接入到etcd服务发现-1">接入到etcd服务发现</h3>
<p>task/main.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;github.com/micro/go-micro/v2&#34;</span>
	<span style="color:#e6db74">&#34;github.com/micro/go-micro/v2/registry&#34;</span>
	<span style="color:#e6db74">&#34;github.com/micro/go-micro/v2/registry/etcd&#34;</span>
	<span style="color:#e6db74">&#34;task/conf&#34;</span>
	<span style="color:#e6db74">&#34;task/core&#34;</span>
	<span style="color:#e6db74">&#34;task/services&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">conf</span>.<span style="color:#a6e22e">Init</span>()
	<span style="color:#75715e">//注册etcd
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">etcdReg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">etcd</span>.<span style="color:#a6e22e">NewRegistry</span>(
		<span style="color:#a6e22e">registry</span>.<span style="color:#a6e22e">Addrs</span>(<span style="color:#e6db74">&#34;127.0.0.1:2379&#34;</span>))
	<span style="color:#75715e">//得到一个微服务实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">microService</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">micro</span>.<span style="color:#a6e22e">NewService</span>(
		<span style="color:#a6e22e">micro</span>.<span style="color:#a6e22e">Name</span>(<span style="color:#e6db74">&#34;rpcTaskService&#34;</span>),
		<span style="color:#a6e22e">micro</span>.<span style="color:#a6e22e">Address</span>(<span style="color:#e6db74">&#34;127.0.0.1:8083&#34;</span>),
		<span style="color:#a6e22e">micro</span>.<span style="color:#a6e22e">Registry</span>(<span style="color:#a6e22e">etcdReg</span>),
	)
	<span style="color:#75715e">//结构命令行参数初始化
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">microService</span>.<span style="color:#a6e22e">Init</span>()
	<span style="color:#75715e">//服务注册
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">RegisterTaskServiceHandler</span>(<span style="color:#a6e22e">microService</span>.<span style="color:#a6e22e">Server</span>(), new(<span style="color:#a6e22e">core</span>.<span style="color:#a6e22e">TaskService</span>))
	<span style="color:#75715e">//启动微服务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">microService</span>.<span style="color:#a6e22e">Run</span>()
}
</code></pre></div><h3 id="task模块文件目录结构">Task模块文件目录结构</h3>
<pre tabindex="0"><code>task
│  go.mod
│  go.sum
│  main.go
│
├─conf
│      conf.go
│      conf.ini
│
├─core
│      pkg.go
│      taskSerializer.go
│      taskService.go
│
├─model
│      migration.go
│      mq_init.go
│      mysql_init.go
│      task.go
│
└─services
    │  taskModels.pb.go
    │  taskModels.pb.micro.go
    │  taskService.pb.go
    │  taskService.pb.micro.go
    │
    └─protos
            taskModels.proto
            taskService.proto
</code></pre><ul>
<li>conf：配置信息</li>
<li>core：业务逻辑</li>
<li>model：数据库模型</li>
<li>service：proto文件以及各服务</li>
</ul>
<h3 id="运行-1">运行</h3>
<p>1、连接到mysql中，创建micro_todo_list数据库(如果已经创建了，可以跳过)</p>
<p>2、开启etcd和etcdkeeper（如果已经开启了，可以跳过）</p>
<p>3、开启rabbitmq<code>rabbitmq-service start</code>(如果已经开启了，可以跳过)</p>
<p>4、使用命令<code>go run main.go --registry=etcd --registry_address=127.0.0.1:2379</code> 运行</p>
<p>看到如下效果为正确</p>
<p>
        <img class="mx-auto" alt="image-20220325175231141" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/image-20220325175231141.png" />   
    </p>
<h2 id="mq-serverrabbitmq消息队列消费数据">mq-server(rabbitmq消息队列消费数据)</h2>
<h3 id="数据库相关配置-2">数据库相关配置</h3>
<p>1、准备配置文件</p>
<p>mq-server/conf/conf.ini</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#66d9ef">[service]</span>
<span style="color:#a6e22e">AppMode</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">debug</span>
<span style="color:#a6e22e">HttpPort</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">:3000</span>

<span style="color:#66d9ef">[mysql]</span>
<span style="color:#a6e22e">Db</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">mysql</span>
<span style="color:#a6e22e">DbHost</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">127.0.0.1</span>
<span style="color:#a6e22e">DbPort</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">3306</span>
<span style="color:#a6e22e">DbUser</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">root</span>
<span style="color:#a6e22e">DbPassWord</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">123456</span>
<span style="color:#a6e22e">DbName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">micro_todo_list</span>

<span style="color:#66d9ef">[rabbitmq]</span>
<span style="color:#a6e22e">RabbitMQ</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">amqp</span>
<span style="color:#a6e22e">RabbitMQUser</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">guest</span>
<span style="color:#a6e22e">RabbitMQPassWord</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">guest</span>
<span style="color:#a6e22e">RabbitMQHost</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">localhost</span>
<span style="color:#a6e22e">RabbitMQPort</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">5672</span>
</code></pre></div><p>2、读取配置文件</p>
<p>mq-server/conf/conf.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">conf</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;gopkg.in/ini.v1&#34;</span>
	<span style="color:#e6db74">&#34;strings&#34;</span>
	<span style="color:#e6db74">&#34;task/model&#34;</span>
)

<span style="color:#66d9ef">var</span> (
	<span style="color:#a6e22e">Db</span>         <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">DbHost</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">DbPort</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">DbUser</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">DbPassWord</span> <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">DbName</span>     <span style="color:#66d9ef">string</span>

	<span style="color:#a6e22e">RabbitMQ</span>         <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">RabbitMQUser</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">RabbitMQPassWord</span> <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">RabbitMQHost</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">RabbitMQPort</span>     <span style="color:#66d9ef">string</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Init</span>() {

	<span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ini</span>.<span style="color:#a6e22e">Load</span>(<span style="color:#e6db74">&#34;./conf/conf.ini&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;读取配置文件错误，err=&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">LoadMysql</span>(<span style="color:#a6e22e">file</span>)
	<span style="color:#75715e">//mysql连接格式root:password@tcp(&#34;127.0.0.1:3306&#34;)/库名?charset=utf8&amp;parseTime=true
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pathMySql</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Join</span>([]<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">DbUser</span>, <span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#a6e22e">DbPassWord</span>, <span style="color:#e6db74">&#34;@tcp(&#34;</span>, <span style="color:#a6e22e">DbHost</span>, <span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#a6e22e">DbPort</span>, <span style="color:#e6db74">&#34;)/&#34;</span>, <span style="color:#a6e22e">DbName</span>, <span style="color:#e6db74">&#34;?charset=utf8&amp;parseTime=true&#34;</span>}, <span style="color:#e6db74">&#34;&#34;</span>)
	<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Database</span>(<span style="color:#a6e22e">pathMySql</span>)
	<span style="color:#a6e22e">Loadrabbitmq</span>(<span style="color:#a6e22e">file</span>)
	<span style="color:#75715e">//rabbitmq连接格式amqp://guest:guest@127.0.0.1:5672/&#34;
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pathRabbitMQ</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Join</span>([]<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">RabbitMQ</span>, <span style="color:#e6db74">&#34;://&#34;</span>, <span style="color:#a6e22e">RabbitMQUser</span>, <span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#a6e22e">RabbitMQPassWord</span>, <span style="color:#e6db74">&#34;@&#34;</span>, <span style="color:#a6e22e">RabbitMQHost</span>, <span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#a6e22e">RabbitMQPort</span>, <span style="color:#e6db74">&#34;/&#34;</span>}, <span style="color:#e6db74">&#34;&#34;</span>)
	<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">RabbitMQ</span>(<span style="color:#a6e22e">pathRabbitMQ</span>)

}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">LoadMysql</span>(<span style="color:#a6e22e">file</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ini</span>.<span style="color:#a6e22e">File</span>) {
	<span style="color:#a6e22e">Db</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;Db&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">DbHost</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;DbHost&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">DbPort</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;DbPort&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">DbUser</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;DbUser&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">DbPassWord</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;DbPassWord&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">DbName</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;DbName&#34;</span>).<span style="color:#a6e22e">String</span>()
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Loadrabbitmq</span>(<span style="color:#a6e22e">file</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ini</span>.<span style="color:#a6e22e">File</span>) {
	<span style="color:#a6e22e">RabbitMQ</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;rabbitmq&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;RabbitMQ&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">RabbitMQUser</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;rabbitmq&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;RabbitMQUser&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">RabbitMQPassWord</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;rabbitmq&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;RabbitMQPassWord&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">RabbitMQHost</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;rabbitmq&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;RabbitMQHost&#34;</span>).<span style="color:#a6e22e">String</span>()
	<span style="color:#a6e22e">RabbitMQPort</span> = <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Section</span>(<span style="color:#e6db74">&#34;rabbitmq&#34;</span>).<span style="color:#a6e22e">Key</span>(<span style="color:#e6db74">&#34;RabbitMQPort&#34;</span>).<span style="color:#a6e22e">String</span>()
}
</code></pre></div><p>3、连接mysql数据库</p>
<p>mq-server/model/mysql_init.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">model</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
	<span style="color:#e6db74">&#34;github.com/jinzhu/gorm&#34;</span>
	<span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;github.com/jinzhu/gorm/dialects/mysql&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">DB</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">DB</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Database</span>(<span style="color:#a6e22e">path</span> <span style="color:#66d9ef">string</span>) {
	<span style="color:#a6e22e">db</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;mysql&#34;</span>, <span style="color:#a6e22e">path</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">LogMode</span>(<span style="color:#66d9ef">true</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Mode</span>() <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;release&#34;</span> {
		<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">LogMode</span>(<span style="color:#66d9ef">false</span>)
	}
	<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">SingularTable</span>(<span style="color:#66d9ef">true</span>)
	<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">DB</span>().<span style="color:#a6e22e">SetMaxIdleConns</span>(<span style="color:#ae81ff">20</span>)
	<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">DB</span>().<span style="color:#a6e22e">SetMaxOpenConns</span>(<span style="color:#ae81ff">100</span>)
	<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">DB</span>().<span style="color:#a6e22e">SetConnMaxLifetime</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">30</span>)
	<span style="color:#a6e22e">DB</span> = <span style="color:#a6e22e">db</span>
}
</code></pre></div><p>4、连接rabbitmq消息队列</p>
<p>mq-server/model/mq_init.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">model</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;github.com/streadway/amqp&#34;</span>

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">MQ</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">amqp</span>.<span style="color:#a6e22e">Connection</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">RabbitMQ</span>(<span style="color:#a6e22e">path</span> <span style="color:#66d9ef">string</span>) {
	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">amqp</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#a6e22e">path</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">MQ</span> = <span style="color:#a6e22e">conn</span>
}
</code></pre></div><p>5、定义Task数据结构</p>
<p>mq-server/model/task</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">model</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;github.com/jinzhu/gorm&#34;</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Task</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">Model</span>
	<span style="color:#a6e22e">Uid</span>       <span style="color:#66d9ef">uint</span>   <span style="color:#e6db74">`gorm:&#34;not null&#34;`</span>
	<span style="color:#a6e22e">Title</span>     <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`gorm:&#34;index; not null&#34;`</span>
	<span style="color:#a6e22e">Status</span>    <span style="color:#66d9ef">int</span>    <span style="color:#e6db74">`gorm:&#34;default:&#39;0&#39;&#34;`</span>
	<span style="color:#a6e22e">Content</span>   <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`gorm:&#34;type:longtext&#34;`</span>
	<span style="color:#a6e22e">StartTime</span> <span style="color:#66d9ef">int64</span>
	<span style="color:#a6e22e">EndTime</span>   <span style="color:#66d9ef">int64</span> <span style="color:#e6db74">`gorm:&#34;default:&#39;0&#39;&#34;`</span>
}
</code></pre></div><h3 id="从rabbitmq中消费数据并存入到数据库中">从rabbitmq中消费数据，并存入到数据库中</h3>
<p>mq-server/service/task.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">service</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;encoding/json&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;mq-server/model&#34;</span>
)

<span style="color:#75715e">//从rabbitMq中接受信息，并存入数据库
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CreateTask</span>() {
	<span style="color:#75715e">//打开Channel
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ch</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">MQ</span>.<span style="color:#a6e22e">Channel</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#75715e">//从task_queue通道中获取消息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">q</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ch</span>.<span style="color:#a6e22e">QueueDeclare</span>(<span style="color:#e6db74">&#34;task_queue&#34;</span>, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>)
	<span style="color:#75715e">//公平分派消息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">ch</span>.<span style="color:#a6e22e">Qos</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">false</span>)
	<span style="color:#75715e">//读出数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ch</span>.<span style="color:#a6e22e">Consume</span>(<span style="color:#a6e22e">q</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">nil</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#75715e">//处于监听状态，一直监听生成端的生产，所以要阻塞主进程
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//从通道中读出数据
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//将通道的信息，反系列化，然后在数据库中创建
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">msg</span> {
			<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">t</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Task</span>
			<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Body</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">t</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				panic(<span style="color:#a6e22e">err</span>)
			}
			<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">t</span>)
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Done&#34;</span>)
			<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Ack</span>(<span style="color:#66d9ef">false</span>)
		}
	}()
}
</code></pre></div><h3 id="永久监听">永久监听</h3>
<p>mq-server/main.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;mq-server/conf&#34;</span>
	<span style="color:#e6db74">&#34;mq-server/service&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">conf</span>.<span style="color:#a6e22e">Init</span>()
	<span style="color:#a6e22e">forever</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>)
	<span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">CreateTask</span>()
	<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">forever</span>
}
</code></pre></div><h3 id="mq-server模块文件目录结构">mq-server模块文件目录结构</h3>
<pre tabindex="0"><code>─mq-server
│  go.mod
│  go.sum
│  main.go
│
├─conf
│      conf.go
│      conf.ini
│
├─model
│      mq_init.go
│      mysql_init.go
│      task.go
│
└─service
        task.go
</code></pre><ul>
<li>conf：配置信息</li>
<li>model：数据库模型</li>
<li>service：服务</li>
</ul>
<h3 id="运行-2">运行</h3>
<p>使用命令<code>go run main.go</code> 运行</p>
<h2 id="接入网关">接入网关</h2>
<h3 id="proto文件编译-2">proto文件编译</h3>
<p>1、复制user模块的userService.proto、userModels.proto和task模块的taskModels.proto、taskService.proto文件</p>
<p>
        <img class="mx-auto" alt="image-20220325200544599" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/image-20220325200544599.png" />   
    </p>
<p>2、生成go文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">protoc --proto_path<span style="color:#f92672">=</span>. --micro_out<span style="color:#f92672">=</span>. --go_out<span style="color:#f92672">=</span>. userModel.proto
</code></pre></div><p>3、将生成的文件移动到services目录下</p>
<p>
        <img class="mx-auto" alt="image-20220325200805946" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/image-20220325200805946.png" />   
    </p>
<h3 id="封装一些方法">封装一些方法</h3>
<p>1、写日志文件</p>
<p>gateway/pkg/logging/file.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">logging</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">var</span> (
	<span style="color:#a6e22e">LogSavePath</span> = <span style="color:#e6db74">&#34;runtime/logs/&#34;</span>
	<span style="color:#a6e22e">LogSaveName</span> = <span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#a6e22e">LogFileExt</span>  = <span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#a6e22e">TimeFormat</span>  = <span style="color:#e6db74">&#34;20060102&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getLogFilePath</span>() <span style="color:#66d9ef">string</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s&#34;</span>, <span style="color:#a6e22e">LogSavePath</span>)
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getLogFileFullPath</span>() <span style="color:#66d9ef">string</span> {
	<span style="color:#a6e22e">prefixPath</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getLogFilePath</span>()
	<span style="color:#a6e22e">suffixPath</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s%s.%s&#34;</span>, <span style="color:#a6e22e">LogSaveName</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Format</span>(<span style="color:#a6e22e">TimeFormat</span>), <span style="color:#a6e22e">LogFileExt</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s%s&#34;</span>, <span style="color:#a6e22e">prefixPath</span>, <span style="color:#a6e22e">suffixPath</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">openLogFile</span>(<span style="color:#a6e22e">filePath</span> <span style="color:#66d9ef">string</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">File</span> {
	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stat</span>(<span style="color:#a6e22e">filePath</span>)
	<span style="color:#66d9ef">switch</span> {
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">IsNotExist</span>(<span style="color:#a6e22e">err</span>):
		<span style="color:#a6e22e">mkDir</span>()
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">IsPermission</span>(<span style="color:#a6e22e">err</span>):
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Permission :%v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}

	<span style="color:#a6e22e">handle</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">OpenFile</span>(<span style="color:#a6e22e">filePath</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_APPEND</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_CREATE</span>|<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">O_WRONLY</span>, <span style="color:#ae81ff">0644</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Fail to OpenFile :%v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">handle</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">mkDir</span>() {
	<span style="color:#a6e22e">dir</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getwd</span>()
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">MkdirAll</span>(<span style="color:#a6e22e">dir</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">getLogFilePath</span>(), <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">ModePerm</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
}
</code></pre></div><p>2、日志级别定义</p>
<p>gateway/pkg/logging/log.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">logging</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
	<span style="color:#e6db74">&#34;path/filepath&#34;</span>
	<span style="color:#e6db74">&#34;runtime&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Level</span> <span style="color:#66d9ef">int</span>

<span style="color:#66d9ef">const</span> (
	<span style="color:#a6e22e">DEBUG</span> <span style="color:#a6e22e">Level</span> = <span style="color:#66d9ef">iota</span>
	<span style="color:#a6e22e">INFO</span>
	<span style="color:#a6e22e">WARRING</span>
	<span style="color:#a6e22e">ERROR</span>
	<span style="color:#a6e22e">FATAL</span>
)

<span style="color:#66d9ef">var</span> (
	<span style="color:#a6e22e">F</span>                  <span style="color:#f92672">*</span><span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">File</span>
	<span style="color:#a6e22e">DefaultPrefix</span>      = <span style="color:#e6db74">&#34;&#34;</span>
	<span style="color:#a6e22e">logger</span>             <span style="color:#f92672">*</span><span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Logger</span>
	<span style="color:#a6e22e">DefaultCallerDepth</span> = <span style="color:#ae81ff">2</span>
	<span style="color:#a6e22e">logPrefix</span>          = <span style="color:#e6db74">&#34;&#34;</span>
	<span style="color:#a6e22e">levelFlags</span>         = []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;DEBUG&#34;</span>, <span style="color:#e6db74">&#34;INFO&#34;</span>, <span style="color:#e6db74">&#34;WARN&#34;</span>, <span style="color:#e6db74">&#34;ERROR&#34;</span>, <span style="color:#e6db74">&#34;FATAL&#34;</span>}
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>() {
	<span style="color:#a6e22e">filepath</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getLogFileFullPath</span>()
	<span style="color:#a6e22e">F</span> = <span style="color:#a6e22e">openLogFile</span>(<span style="color:#a6e22e">filepath</span>)
	<span style="color:#a6e22e">logger</span> = <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">F</span>, <span style="color:#a6e22e">DefaultPrefix</span>, <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">LstdFlags</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Debug</span>(<span style="color:#a6e22e">v</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#a6e22e">setPrefix</span>(<span style="color:#a6e22e">DEBUG</span>)
	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">v</span><span style="color:#f92672">...</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Info</span>(<span style="color:#a6e22e">v</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#a6e22e">setPrefix</span>(<span style="color:#a6e22e">INFO</span>)
	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">v</span><span style="color:#f92672">...</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Warn</span>(<span style="color:#a6e22e">v</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#a6e22e">setPrefix</span>(<span style="color:#a6e22e">WARRING</span>)
	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">v</span><span style="color:#f92672">...</span>)
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">v</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#a6e22e">setPrefix</span>(<span style="color:#a6e22e">ERROR</span>)
	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">v</span><span style="color:#f92672">...</span>)
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">v</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#a6e22e">setPrefix</span>(<span style="color:#a6e22e">FATAL</span>)
	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">v</span><span style="color:#f92672">...</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">setPrefix</span>(<span style="color:#a6e22e">level</span> <span style="color:#a6e22e">Level</span>) {
	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">line</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Caller</span>(<span style="color:#a6e22e">DefaultCallerDepth</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span> {
		<span style="color:#a6e22e">logPrefix</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;[%s][%s:%d]&#34;</span>, <span style="color:#a6e22e">levelFlags</span>[<span style="color:#a6e22e">level</span>], <span style="color:#a6e22e">filepath</span>.<span style="color:#a6e22e">Base</span>(<span style="color:#a6e22e">file</span>), <span style="color:#a6e22e">line</span>)
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">logPrefix</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;[%s]&#34;</span>, <span style="color:#a6e22e">levelFlags</span>[<span style="color:#a6e22e">level</span>])
	}
	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">SetPrefix</span>(<span style="color:#a6e22e">logPrefix</span>)
}
</code></pre></div><p>3、包装错误的方法</p>
<p>gateway/weblib/handlers/pkg.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">handlers</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;errors&#34;</span>
	<span style="color:#e6db74">&#34;gateway/pkg/logging&#34;</span>
)

<span style="color:#75715e">//包装错误
</span><span style="color:#75715e">//包装user的错误
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">PanicIfUserError</span>(<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;userService--&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
		<span style="color:#a6e22e">logging</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#a6e22e">err</span>)
		panic(<span style="color:#a6e22e">err</span>)
	}
}
<span style="color:#75715e">//包装task的错误
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">PanicIfTaskError</span>(<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;taskService--&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
		<span style="color:#a6e22e">logging</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#a6e22e">err</span>)
		panic(<span style="color:#a6e22e">err</span>)
	}
}
</code></pre></div><h3 id="接入路由">接入路由</h3>
<p>1、在gin中接入user和task的路由</p>
<p>gateway/weblib/router.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">weblib</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;gateway/weblib/handlers&#34;</span>
	<span style="color:#e6db74">&#34;gateway/weblib/middleware&#34;</span>
	<span style="color:#e6db74">&#34;github.com/gin-contrib/sessions&#34;</span>
	<span style="color:#e6db74">&#34;github.com/gin-contrib/sessions/cookie&#34;</span>
	<span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewRouter</span>(<span style="color:#a6e22e">service</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">interface</span>{}) <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Engine</span> {
	<span style="color:#a6e22e">ginRouter</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Default</span>()
	<span style="color:#a6e22e">ginRouter</span>.<span style="color:#a6e22e">Use</span>(<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">Cors</span>(), <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">InitMiddleware</span>(<span style="color:#a6e22e">service</span>), <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">ErrorMiddleware</span>())
	<span style="color:#a6e22e">store</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cookie</span>.<span style="color:#a6e22e">NewStore</span>([]byte(<span style="color:#e6db74">&#34;something-every-secret&#34;</span>))
	<span style="color:#a6e22e">ginRouter</span>.<span style="color:#a6e22e">Use</span>(<span style="color:#a6e22e">sessions</span>.<span style="color:#a6e22e">Sessions</span>(<span style="color:#e6db74">&#34;mysession&#34;</span>, <span style="color:#a6e22e">store</span>))
	<span style="color:#a6e22e">v1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ginRouter</span>.<span style="color:#a6e22e">Group</span>(<span style="color:#e6db74">&#34;/api/v1&#34;</span>)
	{
		<span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;ping&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
			<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#ae81ff">200</span>, <span style="color:#e6db74">&#34;success&#34;</span>)
		})
		<span style="color:#75715e">//用户服务
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">POST</span>(<span style="color:#e6db74">&#34;/user/register&#34;</span>, <span style="color:#a6e22e">handlers</span>.<span style="color:#a6e22e">UserRegister</span>)
		<span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">POST</span>(<span style="color:#e6db74">&#34;/user/login&#34;</span>, <span style="color:#a6e22e">handlers</span>.<span style="color:#a6e22e">UserLogin</span>)
		<span style="color:#75715e">// 需要登录保护
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">authed</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Group</span>(<span style="color:#e6db74">&#34;/&#34;</span>)
		<span style="color:#a6e22e">authed</span>.<span style="color:#a6e22e">Use</span>(<span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">JWT</span>())
		{
			<span style="color:#a6e22e">authed</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;tasks&#34;</span>, <span style="color:#a6e22e">handlers</span>.<span style="color:#a6e22e">GetTaskList</span>)
			<span style="color:#a6e22e">authed</span>.<span style="color:#a6e22e">POST</span>(<span style="color:#e6db74">&#34;task&#34;</span>, <span style="color:#a6e22e">handlers</span>.<span style="color:#a6e22e">CreateTask</span>)
			<span style="color:#a6e22e">authed</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;task/:id&#34;</span>, <span style="color:#a6e22e">handlers</span>.<span style="color:#a6e22e">GetTaskDetail</span>) <span style="color:#75715e">// task_id
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">authed</span>.<span style="color:#a6e22e">PUT</span>(<span style="color:#e6db74">&#34;task/:id&#34;</span>, <span style="color:#a6e22e">handlers</span>.<span style="color:#a6e22e">UpdateTask</span>)    <span style="color:#75715e">// task_id
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">authed</span>.<span style="color:#a6e22e">DELETE</span>(<span style="color:#e6db74">&#34;task/:id&#34;</span>, <span style="color:#a6e22e">handlers</span>.<span style="color:#a6e22e">DeleteTask</span>) <span style="color:#75715e">// task_id
</span><span style="color:#75715e"></span>		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ginRouter</span>
}
</code></pre></div><p>2、实现core跨域中间件、初始化、错误等中间件</p>
<p>gateway/weblib/middleware/cors.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">middleware</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
	<span style="color:#e6db74">&#34;net/http&#34;</span>
	<span style="color:#e6db74">&#34;strings&#34;</span>
)

<span style="color:#75715e">//跨域设置
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Cors</span>() <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">HandlerFunc</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
		<span style="color:#75715e">//请求方法
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">method</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">Method</span>
		<span style="color:#75715e">//请求头部
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">origin</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;Origin&#34;</span>)
		<span style="color:#75715e">//声明请求头keys
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">headerKeys</span> []<span style="color:#66d9ef">string</span>
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">k</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">Header</span> {
			<span style="color:#a6e22e">headerKeys</span> = append(<span style="color:#a6e22e">headerKeys</span>, <span style="color:#a6e22e">k</span>)
		}
		<span style="color:#a6e22e">headerStr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">headerKeys</span>, <span style="color:#e6db74">&#34;, &#34;</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">headerStr</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
			<span style="color:#a6e22e">headerStr</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;access-control-allow-origin,access-control-allow-headers,%s&#34;</span>, <span style="color:#a6e22e">headerStr</span>)
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#a6e22e">headerStr</span> = <span style="color:#e6db74">&#34;access-control-allow-origin,access-control-allow-headers&#34;</span>
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">origin</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Writer</span>.<span style="color:#a6e22e">Header</span>().<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;Access-Control-Allow-Origin&#34;</span>, <span style="color:#e6db74">&#34;*&#34;</span>)
			<span style="color:#75715e">//允许访问所有域
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Header</span>(<span style="color:#e6db74">&#34;Access-Control-Allow-Origin&#34;</span>, <span style="color:#e6db74">&#34;*&#34;</span>)
			<span style="color:#75715e">//服务器支持的所有的跨域请求的方法，为了避免浏览器多次‘预检’请求
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Header</span>(<span style="color:#e6db74">&#34;Access-Control-Allow-Methods&#34;</span>, <span style="color:#e6db74">&#34;POST,GET,OPTIONS,PUT,DELETE,UPDATE&#34;</span>)
			<span style="color:#75715e">//header的类型
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Header</span>(<span style="color:#e6db74">&#34;Access-Control-Allow-Headers&#34;</span>, <span style="color:#e6db74">&#34;Authorization, Content-Length, X-CSRF-Token, Token,session,X_Requested_With,Accept, Origin, Host, Connection, Accept-Encoding, Accept-Language,DNT, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type, Pragma&#34;</span>)
			<span style="color:#75715e">// 允许跨域设置                                                                                                      可以返回其他子段
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Header</span>(<span style="color:#e6db74">&#34;Access-Control-Expose-Headers&#34;</span>, <span style="color:#e6db74">&#34;Content-Length, Access-Control-Allow-Origin, Access-Control-Allow-Headers,Cache-Control,Content-Language,Content-Type,Expires,Last-Modified,Pragma,FooBar&#34;</span>) <span style="color:#75715e">// 跨域关键设置 让浏览器可以解析
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Header</span>(<span style="color:#e6db74">&#34;Access-Control-Max-Age&#34;</span>, <span style="color:#e6db74">&#34;172800&#34;</span>)                                                                                                                                                           <span style="color:#75715e">// 缓存请求信息 单位为秒
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Header</span>(<span style="color:#e6db74">&#34;Access-Control-Allow-Credentials&#34;</span>, <span style="color:#e6db74">&#34;false&#34;</span>)                                                                                                                                                  <span style="color:#75715e">//  跨域请求是否需要带cookie信息 默认设置为true
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;content-type&#34;</span>, <span style="color:#e6db74">&#34;application/json&#34;</span>)                                                                                                                                                              <span style="color:#75715e">// 设置返回格式是json
</span><span style="color:#75715e"></span>		}
		<span style="color:#75715e">//放行所有的OPTIONS方法
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">method</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;OPTIONS&#34;</span> {
			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#e6db74">&#34;Options Request..&#34;</span>)
		}
		<span style="color:#75715e">//处理请求
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Next</span>()
	}
}
</code></pre></div><p>gateway/weblib/middleware/init.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">middleware</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
)

<span style="color:#75715e">//接受服务实例，保存到gin.Key中
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">InitMiddleware</span>(<span style="color:#a6e22e">service</span> []<span style="color:#66d9ef">interface</span>{}) <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">HandlerFunc</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
		<span style="color:#75715e">//将实例保存在gin.Key中
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Keys</span> = make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{})
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Keys</span>[<span style="color:#e6db74">&#34;userService&#34;</span>] = <span style="color:#a6e22e">service</span>[<span style="color:#ae81ff">0</span>]
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Keys</span>[<span style="color:#e6db74">&#34;taskService&#34;</span>] = <span style="color:#a6e22e">service</span>[<span style="color:#ae81ff">1</span>]
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Next</span>()
	}
}

<span style="color:#75715e">//错误中间件处理
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ErrorMiddleware2</span>() <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">HandlerFunc</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
		<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> recover(); <span style="color:#a6e22e">r</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;出错了：&#34;</span>, <span style="color:#a6e22e">r</span>)
				<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{
					<span style="color:#e6db74">&#34;code&#34;</span>: <span style="color:#ae81ff">400</span>,
					<span style="color:#e6db74">&#34;msg&#34;</span>:  <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s&#34;</span>, <span style="color:#a6e22e">r</span>),
				})
				<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Abort</span>()
			}
		}()
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Next</span>()
	}
}

<span style="color:#75715e">// 错误处理中间件
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ErrorMiddleware</span>() <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">HandlerFunc</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">context</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
		<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> recover(); <span style="color:#a6e22e">r</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{
					<span style="color:#e6db74">&#34;code&#34;</span>: <span style="color:#ae81ff">404</span>,
					<span style="color:#e6db74">&#34;msg&#34;</span>:  <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s&#34;</span>, <span style="color:#a6e22e">r</span>),
				})
				<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Abort</span>()
			}
		}()
		<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Next</span>()
	}
}
</code></pre></div><p>3、操作task需要登录鉴权，使用jwt实现</p>
<p>3.1 生成token、验证token</p>
<p>gateway/pkg/utils/jwt.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">utils</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;github.com/dgrijalva/jwt-go&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">jwtSecret</span> = []byte(<span style="color:#e6db74">&#34;TodoList&#34;</span>)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Claims</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Id</span> <span style="color:#66d9ef">uint</span> <span style="color:#e6db74">`json:&#34;id&#34;`</span>
	<span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">StandardClaims</span>
}

<span style="color:#75715e">//签发用户token
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GenerateToken</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">uint</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">nowTime</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
	<span style="color:#a6e22e">expireTime</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">nowTime</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">24</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Hour</span>)
	<span style="color:#a6e22e">claims</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Claims</span>{
		<span style="color:#a6e22e">Id</span>: <span style="color:#a6e22e">id</span>,
		<span style="color:#a6e22e">StandardClaims</span>: <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">StandardClaims</span>{
			<span style="color:#a6e22e">ExpiresAt</span>: <span style="color:#a6e22e">expireTime</span>.<span style="color:#a6e22e">Unix</span>(),
			<span style="color:#a6e22e">Issuer</span>:    <span style="color:#e6db74">&#34;todoList&#34;</span>,
		},
	}
	<span style="color:#a6e22e">tokenClaims</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">NewWithClaims</span>(<span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">SigningMethodHS256</span>, <span style="color:#a6e22e">claims</span>)
	<span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tokenClaims</span>.<span style="color:#a6e22e">SignedString</span>(<span style="color:#a6e22e">jwtSecret</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">err</span>
}

<span style="color:#75715e">//验证用户token
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ParseToken</span>(<span style="color:#a6e22e">token</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">Claims</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">tokenClaims</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">ParseWithClaims</span>(<span style="color:#a6e22e">token</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Claims</span>{}, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">token</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">jwt</span>.<span style="color:#a6e22e">Token</span>) (<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">e</span> <span style="color:#66d9ef">error</span>) {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">jwtSecret</span>, <span style="color:#66d9ef">nil</span>
	})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tokenClaims</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">claims</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tokenClaims</span>.<span style="color:#a6e22e">Claims</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">Claims</span>); <span style="color:#a6e22e">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">tokenClaims</span>.<span style="color:#a6e22e">Valid</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">claims</span>, <span style="color:#66d9ef">nil</span>
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
}
</code></pre></div><p>3.2 实现jwt鉴权中间件</p>
<p>gateway/weblib/middleware/jwt.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">middleware</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;gateway/pkg/utils&#34;</span>
	<span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
)

<span style="color:#75715e">//JWT token验证中间件
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">JWT</span>() <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">HandlerFunc</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">code</span> <span style="color:#66d9ef">uint32</span>
		<span style="color:#a6e22e">code</span> = <span style="color:#ae81ff">200</span>
		<span style="color:#a6e22e">token</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">GetHeader</span>(<span style="color:#e6db74">&#34;Authorization&#34;</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">token</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
			<span style="color:#a6e22e">code</span> = <span style="color:#ae81ff">404</span>
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">ParseToken</span>(<span style="color:#a6e22e">token</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">code</span> = <span style="color:#ae81ff">401</span>
			}
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">code</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">200</span> {
			<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#ae81ff">500</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{
				<span style="color:#e6db74">&#34;code&#34;</span>: <span style="color:#a6e22e">code</span>,
				<span style="color:#e6db74">&#34;msg&#34;</span>:  <span style="color:#e6db74">&#34;鉴权失败&#34;</span>,
			})
			<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Abort</span>()
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Next</span>()
	}
}
</code></pre></div><h3 id="编写接口">编写接口</h3>
<p>1、实现user的登录、注册</p>
<p>gateway/weblib/handler/user.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">handlers</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;gateway/pkg/utils&#34;</span>
	<span style="color:#e6db74">&#34;gateway/services&#34;</span>
	<span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
	<span style="color:#e6db74">&#34;net/http&#34;</span>
)

<span style="color:#75715e">//用户注册
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">UserRegister</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
    <span style="color:#75715e">//定义请求参数
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">userReq</span> <span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">UserRequest</span>
    <span style="color:#75715e">//绑定参数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PanicIfUserError</span>(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Bind</span>((<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">userReq</span>)))
	<span style="color:#75715e">//从gin.Key中取出服务实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">userService</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Keys</span>[<span style="color:#e6db74">&#34;userService&#34;</span>].(<span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">UserService</span>)
    <span style="color:#75715e">//调取服务对象
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">userResp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userService</span>.<span style="color:#a6e22e">UserRegister</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">userReq</span>)
	<span style="color:#a6e22e">PanicIfUserError</span>(<span style="color:#a6e22e">err</span>)
    <span style="color:#75715e">//返回数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;data&#34;</span>: <span style="color:#a6e22e">userResp</span>})
}

<span style="color:#75715e">//用户登录
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">UserLogin</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;已进入gateway/userLogin中&#34;</span>)
    <span style="color:#75715e">//定义请求参数
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">userReq</span> <span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">UserRequest</span>
    <span style="color:#75715e">//绑定参数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PanicIfUserError</span>(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Bind</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">userReq</span>))
	<span style="color:#75715e">//从gin.Key中取出服务实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">userService</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Keys</span>[<span style="color:#e6db74">&#34;userService&#34;</span>].(<span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">UserService</span>)
    <span style="color:#75715e">//调取服务对象
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">userResp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userService</span>.<span style="color:#a6e22e">UserLogin</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">userReq</span>)
	<span style="color:#a6e22e">PanicIfUserError</span>(<span style="color:#a6e22e">err</span>)
    <span style="color:#75715e">// 生成token
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">token</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GenerateToken</span>(uint(<span style="color:#a6e22e">userResp</span>.<span style="color:#a6e22e">UserDetail</span>.<span style="color:#a6e22e">ID</span>))
	<span style="color:#a6e22e">PanicIfUserError</span>(<span style="color:#a6e22e">err</span>)
    <span style="color:#75715e">//返回数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{
		<span style="color:#e6db74">&#34;code&#34;</span>: <span style="color:#a6e22e">userResp</span>.<span style="color:#a6e22e">Code</span>,
		<span style="color:#e6db74">&#34;msg&#34;</span>:  <span style="color:#e6db74">&#34;成功&#34;</span>,
		<span style="color:#e6db74">&#34;data&#34;</span>: <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{
			<span style="color:#e6db74">&#34;user&#34;</span>:  <span style="color:#a6e22e">userResp</span>.<span style="color:#a6e22e">UserDetail</span>,
			<span style="color:#e6db74">&#34;token&#34;</span>: <span style="color:#a6e22e">token</span>,
		},
	})
}
</code></pre></div><p>2、实现task的创建、查询、更新、修改</p>
<p>gateway/weblib/handler/task.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">handlers</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;gateway/pkg/utils&#34;</span>
	<span style="color:#e6db74">&#34;gateway/services&#34;</span>
	<span style="color:#e6db74">&#34;github.com/gin-gonic/gin&#34;</span>
	<span style="color:#e6db74">&#34;strconv&#34;</span>
)
<span style="color:#75715e">//获取备忘录列表
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetTaskList</span>(<span style="color:#a6e22e">ginCtx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
    <span style="color:#75715e">//定义请求参数
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">taskReq</span> <span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskRequest</span>
    <span style="color:#75715e">//绑定参数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PanicIfTaskError</span>(<span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">Bind</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">taskReq</span>))
    <span style="color:#75715e">//从gin.Key中取出服务实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">taskService</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">Keys</span>[<span style="color:#e6db74">&#34;taskService&#34;</span>].(<span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskService</span>)
	<span style="color:#a6e22e">claim</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">ParseToken</span>(<span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">GetHeader</span>(<span style="color:#e6db74">&#34;Authorization&#34;</span>)) <span style="color:#75715e">// 拿到的是当前访问的用户的id，拿到用户自己的备忘录信息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">taskReq</span>.<span style="color:#a6e22e">Uid</span> = uint64(<span style="color:#a6e22e">claim</span>.<span style="color:#a6e22e">Id</span>)
	<span style="color:#75715e">// 调用服务端的函数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">taskResp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">taskService</span>.<span style="color:#a6e22e">GetTasksList</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">taskReq</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">PanicIfTaskError</span>(<span style="color:#a6e22e">err</span>)
	}
    <span style="color:#75715e">//返回数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{
		<span style="color:#e6db74">&#34;data&#34;</span>: <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{
			<span style="color:#e6db74">&#34;task&#34;</span>:  <span style="color:#a6e22e">taskResp</span>.<span style="color:#a6e22e">TaskList</span>,
			<span style="color:#e6db74">&#34;count&#34;</span>: <span style="color:#a6e22e">taskResp</span>.<span style="color:#a6e22e">Count</span>,
		},
	})
}
<span style="color:#75715e">//创建备忘录
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CreateTask</span>(<span style="color:#a6e22e">ginCtx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
    <span style="color:#75715e">//定义请求参数
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">taskReq</span> <span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskRequest</span>
    <span style="color:#75715e">//绑定参数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PanicIfTaskError</span>(<span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">Bind</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">taskReq</span>))
	<span style="color:#75715e">//拿到的是当前访问的用户的id，拿到用户自己的备忘录信息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">claim</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">ParseToken</span>(<span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">GetHeader</span>(<span style="color:#e6db74">&#34;Authorization&#34;</span>))
	<span style="color:#a6e22e">taskReq</span>.<span style="color:#a6e22e">Uid</span> = uint64(<span style="color:#a6e22e">claim</span>.<span style="color:#a6e22e">Id</span>)
    <span style="color:#75715e">//从gin.keys取出服务实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">taskService</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">Keys</span>[<span style="color:#e6db74">&#34;taskService&#34;</span>].(<span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskService</span>)
    <span style="color:#75715e">//调用服务端的方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">taskRes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">taskService</span>.<span style="color:#a6e22e">CreateTask</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">taskReq</span>)
	<span style="color:#a6e22e">PanicIfTaskError</span>(<span style="color:#a6e22e">err</span>)
    <span style="color:#75715e">//返回数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;data&#34;</span>: <span style="color:#a6e22e">taskRes</span>.<span style="color:#a6e22e">TaskDetail</span>})
}
<span style="color:#75715e">//获取备忘录详情
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetTaskDetail</span>(<span style="color:#a6e22e">ginCtx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
     <span style="color:#75715e">//定义请求参数
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">taskReq</span> <span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskRequest</span>
    <span style="color:#75715e">//绑定参数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PanicIfTaskError</span>(<span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">BindUri</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">taskReq</span>))
    <span style="color:#75715e">//拿到的是当前访问的用户的id，拿到用户自己的备忘录信息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">claim</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">ParseToken</span>(<span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">GetHeader</span>(<span style="color:#e6db74">&#34;Authorization&#34;</span>))
	<span style="color:#a6e22e">taskReq</span>.<span style="color:#a6e22e">Uid</span> = uint64(<span style="color:#a6e22e">claim</span>.<span style="color:#a6e22e">Id</span>)
	<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Atoi</span>(<span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">Param</span>(<span style="color:#e6db74">&#34;id&#34;</span>)) <span style="color:#75715e">// 获取task_id
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">taskReq</span>.<span style="color:#a6e22e">Id</span> = uint64(<span style="color:#a6e22e">id</span>)
    <span style="color:#75715e">//从gin.keys取出服务实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">productService</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">Keys</span>[<span style="color:#e6db74">&#34;taskService&#34;</span>].(<span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskService</span>)
    <span style="color:#75715e">//调用服务端的方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">productRes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">productService</span>.<span style="color:#a6e22e">GetTask</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">taskReq</span>)
	<span style="color:#a6e22e">PanicIfTaskError</span>(<span style="color:#a6e22e">err</span>)
    <span style="color:#75715e">//返回数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;data&#34;</span>: <span style="color:#a6e22e">productRes</span>.<span style="color:#a6e22e">TaskDetail</span>})
}
<span style="color:#75715e">//更新备忘录
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">UpdateTask</span>(<span style="color:#a6e22e">ginCtx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
     <span style="color:#75715e">//定义请求参数
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">taskReq</span> <span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskRequest</span>
    <span style="color:#75715e">//绑定参数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PanicIfTaskError</span>(<span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">Bind</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">taskReq</span>))
    <span style="color:#75715e">//拿到的是当前访问的用户的id，拿到用户自己的备忘录信息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">claim</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">ParseToken</span>(<span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">GetHeader</span>(<span style="color:#e6db74">&#34;Authorization&#34;</span>))
	<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Atoi</span>(<span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">Param</span>(<span style="color:#e6db74">&#34;id&#34;</span>))
	<span style="color:#a6e22e">taskReq</span>.<span style="color:#a6e22e">Id</span> = uint64(<span style="color:#a6e22e">id</span>)
	<span style="color:#a6e22e">taskReq</span>.<span style="color:#a6e22e">Uid</span> = uint64(<span style="color:#a6e22e">claim</span>.<span style="color:#a6e22e">Id</span>)
    <span style="color:#75715e">//从gin.keys取出服务实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">taskService</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">Keys</span>[<span style="color:#e6db74">&#34;taskService&#34;</span>].(<span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskService</span>)
    <span style="color:#75715e">//调用服务端的方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">taskRes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">taskService</span>.<span style="color:#a6e22e">UpdateTask</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">taskReq</span>)
	<span style="color:#a6e22e">PanicIfTaskError</span>(<span style="color:#a6e22e">err</span>)
    <span style="color:#75715e">//返回数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;data&#34;</span>: <span style="color:#a6e22e">taskRes</span>.<span style="color:#a6e22e">TaskDetail</span>})
}
<span style="color:#75715e">//删除备忘录
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DeleteTask</span>(<span style="color:#a6e22e">ginCtx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
     <span style="color:#75715e">//定义请求参数
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">taskReq</span> <span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskRequest</span>
    <span style="color:#75715e">//绑定参数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PanicIfTaskError</span>(<span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">Bind</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">taskReq</span>))
    <span style="color:#75715e">//拿到的是当前访问的用户的id，拿到用户自己的备忘录信息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">claim</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">ParseToken</span>(<span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">GetHeader</span>(<span style="color:#e6db74">&#34;Authorization&#34;</span>))
	<span style="color:#a6e22e">taskReq</span>.<span style="color:#a6e22e">Uid</span> = uint64(<span style="color:#a6e22e">claim</span>.<span style="color:#a6e22e">Id</span>)
	<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Atoi</span>(<span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">Param</span>(<span style="color:#e6db74">&#34;id&#34;</span>))
	<span style="color:#a6e22e">taskReq</span>.<span style="color:#a6e22e">Id</span> = uint64(<span style="color:#a6e22e">id</span>)
    <span style="color:#75715e">//从gin.keys取出服务实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">taskService</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">Keys</span>[<span style="color:#e6db74">&#34;taskService&#34;</span>].(<span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskService</span>)
    <span style="color:#75715e">//调用服务端的方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">taskRes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">taskService</span>.<span style="color:#a6e22e">DeleteTask</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">taskReq</span>)
	<span style="color:#a6e22e">PanicIfTaskError</span>(<span style="color:#a6e22e">err</span>)
    <span style="color:#75715e">//返回数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ginCtx</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">H</span>{<span style="color:#e6db74">&#34;data&#34;</span>: <span style="color:#a6e22e">taskRes</span>.<span style="color:#a6e22e">TaskDetail</span>})
}

</code></pre></div><h3 id="熔断器">熔断器</h3>
<p>1、user的熔断器</p>
<p>gateway/wrappers/userWrapper.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">wrappers</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;github.com/afex/hystrix-go/hystrix&#34;</span>
	<span style="color:#e6db74">&#34;github.com/micro/go-micro/v2/client&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">userWrapper</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Client</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">wrapper</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">userWrapper</span>) <span style="color:#a6e22e">Call</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Request</span>, <span style="color:#a6e22e">resp</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">CallOption</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">cmdName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Service</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Endpoint</span>()
	<span style="color:#a6e22e">config</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">hystrix</span>.<span style="color:#a6e22e">CommandConfig</span>{
		<span style="color:#a6e22e">Timeout</span>:                <span style="color:#ae81ff">30000</span>,
		<span style="color:#a6e22e">RequestVolumeThreshold</span>: <span style="color:#ae81ff">20</span>,   <span style="color:#75715e">//熔断器请求阈值，默认20，意思是有20个请求才能进行错误百分比计算
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">ErrorPercentThreshold</span>:  <span style="color:#ae81ff">50</span>,   <span style="color:#75715e">//错误百分比，当错误超过百分比时，直接进行降级处理，直至熔断器再次 开启，默认50%
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">SleepWindow</span>:            <span style="color:#ae81ff">5000</span>, <span style="color:#75715e">//过多长时间，熔断器再次检测是否开启，单位毫秒ms（默认5秒）
</span><span style="color:#75715e"></span>	}
	<span style="color:#a6e22e">hystrix</span>.<span style="color:#a6e22e">ConfigureCommand</span>(<span style="color:#a6e22e">cmdName</span>, <span style="color:#a6e22e">config</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">hystrix</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">cmdName</span>, <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">error</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">wrapper</span>.<span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">Call</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">resp</span>)
	}, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) <span style="color:#66d9ef">error</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	})
}

<span style="color:#75715e">//NewUserWrapper 初始化Wrapper
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewUserWrapper</span>(<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Client</span>) <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Client</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">userWrapper</span>{<span style="color:#a6e22e">c</span>}
}
</code></pre></div><p>2、task的熔断器</p>
<p>gateway/wrappers/taskWrapper.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">wrappers</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;gateway/services&#34;</span>
	<span style="color:#e6db74">&#34;github.com/afex/hystrix-go/hystrix&#34;</span>
	<span style="color:#e6db74">&#34;github.com/micro/go-micro/v2/client&#34;</span>
	<span style="color:#e6db74">&#34;strconv&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewTask</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">uint64</span>, <span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskModel</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskModel</span>{
		<span style="color:#a6e22e">Id</span>:         <span style="color:#a6e22e">id</span>,
		<span style="color:#a6e22e">Title</span>:      <span style="color:#a6e22e">name</span>,
		<span style="color:#a6e22e">Content</span>:    <span style="color:#e6db74">&#34;响应超时&#34;</span>,
		<span style="color:#a6e22e">StartTime</span>:  <span style="color:#ae81ff">1000</span>,
		<span style="color:#a6e22e">EndTime</span>:    <span style="color:#ae81ff">1000</span>,
		<span style="color:#a6e22e">Status</span>:     <span style="color:#ae81ff">0</span>,
		<span style="color:#a6e22e">CreateTime</span>: <span style="color:#ae81ff">1000</span>,
		<span style="color:#a6e22e">UpdateTime</span>: <span style="color:#ae81ff">1000</span>,
	}
}

<span style="color:#75715e">// 降级函数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DefaultTasks</span>(<span style="color:#a6e22e">resp</span> <span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#a6e22e">models</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskModel</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">uint64</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> = <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">models</span> = append(<span style="color:#a6e22e">models</span>, <span style="color:#a6e22e">NewTask</span>(<span style="color:#a6e22e">i</span>, <span style="color:#e6db74">&#34;降级备忘录&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(<span style="color:#ae81ff">20</span><span style="color:#f92672">+</span>int(<span style="color:#a6e22e">i</span>))))
	}
	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">resp</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">TaskListResponse</span>)
	<span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">TaskList</span> = <span style="color:#a6e22e">models</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">TaskWrapper</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Client</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">wrapper</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TaskWrapper</span>) <span style="color:#a6e22e">Call</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Request</span>, <span style="color:#a6e22e">rsp</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">opts</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">CallOption</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">cmdName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Service</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Endpoint</span>()
	<span style="color:#a6e22e">config</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">hystrix</span>.<span style="color:#a6e22e">CommandConfig</span>{
		<span style="color:#a6e22e">Timeout</span>:                <span style="color:#ae81ff">3000</span>,
		<span style="color:#a6e22e">RequestVolumeThreshold</span>: <span style="color:#ae81ff">20</span>,   <span style="color:#75715e">//熔断器请求阈值，默认20，意思是有20个请求才能进行错误百分比计算
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">ErrorPercentThreshold</span>:  <span style="color:#ae81ff">50</span>,   <span style="color:#75715e">//错误百分比，当错误超过百分比时，直接进行降级处理，直至熔断器再次 开启，默认50%
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">SleepWindow</span>:            <span style="color:#ae81ff">5000</span>, <span style="color:#75715e">//过多长时间，熔断器再次检测是否开启，单位毫秒ms（默认5秒）
</span><span style="color:#75715e"></span>	}
	<span style="color:#a6e22e">hystrix</span>.<span style="color:#a6e22e">ConfigureCommand</span>(<span style="color:#a6e22e">cmdName</span>, <span style="color:#a6e22e">config</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">hystrix</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">cmdName</span>, <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">error</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">wrapper</span>.<span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">Call</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">rsp</span>)
	}, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) <span style="color:#66d9ef">error</span> {
		<span style="color:#a6e22e">DefaultTasks</span>(<span style="color:#a6e22e">rsp</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
	})
}

<span style="color:#75715e">//NewProductWrapper 初始化Wrapper
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewTaskWrapper</span>(<span style="color:#a6e22e">cli</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Client</span>) <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Client</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">TaskWrapper</span>{<span style="color:#a6e22e">cli</span>}
}
</code></pre></div><h3 id="接入etcd">接入etcd</h3>
<p>gateway/main.go</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;gateway/services&#34;</span>
	<span style="color:#e6db74">&#34;gateway/weblib&#34;</span>
	<span style="color:#e6db74">&#34;gateway/wrappers&#34;</span>
	<span style="color:#e6db74">&#34;github.com/micro/go-micro/v2&#34;</span>
	<span style="color:#e6db74">&#34;github.com/micro/go-micro/v2/registry&#34;</span>
	<span style="color:#e6db74">&#34;github.com/micro/go-micro/v2/registry/etcd&#34;</span>
	<span style="color:#e6db74">&#34;github.com/micro/go-micro/v2/web&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//etcd注册
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">etcdReg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">etcd</span>.<span style="color:#a6e22e">NewRegistry</span>(
		<span style="color:#a6e22e">registry</span>.<span style="color:#a6e22e">Addrs</span>(<span style="color:#e6db74">&#34;127.0.0.1:2379&#34;</span>))
	<span style="color:#75715e">//用户微服务实例
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">userMicroService</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">micro</span>.<span style="color:#a6e22e">NewService</span>(
		<span style="color:#a6e22e">micro</span>.<span style="color:#a6e22e">Name</span>(<span style="color:#e6db74">&#34;userService.Client&#34;</span>),
		<span style="color:#a6e22e">micro</span>.<span style="color:#a6e22e">WrapClient</span>(<span style="color:#a6e22e">wrappers</span>.<span style="color:#a6e22e">NewUserWrapper</span>),
	)
	<span style="color:#75715e">//用户微服务调用
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">userService</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">NewUserService</span>(<span style="color:#e6db74">&#34;rpcUserService&#34;</span>, <span style="color:#a6e22e">userMicroService</span>.<span style="color:#a6e22e">Client</span>())
	<span style="color:#75715e">// task
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">taskMicroService</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">micro</span>.<span style="color:#a6e22e">NewService</span>(
		<span style="color:#a6e22e">micro</span>.<span style="color:#a6e22e">Name</span>(<span style="color:#e6db74">&#34;taskService.client&#34;</span>),
		<span style="color:#a6e22e">micro</span>.<span style="color:#a6e22e">WrapClient</span>(<span style="color:#a6e22e">wrappers</span>.<span style="color:#a6e22e">NewTaskWrapper</span>),
	)
	<span style="color:#a6e22e">taskService</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">services</span>.<span style="color:#a6e22e">NewTaskService</span>(<span style="color:#e6db74">&#34;rpcTaskService&#34;</span>, <span style="color:#a6e22e">taskMicroService</span>.<span style="color:#a6e22e">Client</span>())

	<span style="color:#75715e">//创建微服务实例，使用gin暴露http接口并注册到etcd
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">server</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">web</span>.<span style="color:#a6e22e">NewService</span>(
		<span style="color:#a6e22e">web</span>.<span style="color:#a6e22e">Name</span>(<span style="color:#e6db74">&#34;httpService&#34;</span>),
		<span style="color:#a6e22e">web</span>.<span style="color:#a6e22e">Address</span>(<span style="color:#e6db74">&#34;127.0.0.1:4000&#34;</span>),
		<span style="color:#75715e">//将服务调用实例使用gin处理
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">web</span>.<span style="color:#a6e22e">Handler</span>(<span style="color:#a6e22e">weblib</span>.<span style="color:#a6e22e">NewRouter</span>(<span style="color:#a6e22e">userService</span>, <span style="color:#a6e22e">taskService</span>)),
		<span style="color:#a6e22e">web</span>.<span style="color:#a6e22e">Registry</span>(<span style="color:#a6e22e">etcdReg</span>),
		<span style="color:#a6e22e">web</span>.<span style="color:#a6e22e">RegisterTTL</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span><span style="color:#f92672">*</span><span style="color:#ae81ff">30</span>),
		<span style="color:#a6e22e">web</span>.<span style="color:#a6e22e">RegisterInterval</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span><span style="color:#f92672">*</span><span style="color:#ae81ff">15</span>),
		<span style="color:#a6e22e">web</span>.<span style="color:#a6e22e">Metadata</span>(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;protocol&#34;</span>: <span style="color:#e6db74">&#34;http&#34;</span>}),
	)

	<span style="color:#75715e">//接收命令行参数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Init</span>()
	<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">Run</span>()
}
</code></pre></div><h3 id="gateway模块文件目录结构">Gateway模块文件目录结构</h3>
<pre tabindex="0"><code>Gateway
│  go.mod
│  go.sum
│  main.go
│
├─pkg
│  ├─logging
│  │      file.go
│  │      log.go
│  │
│  └─utils
│          jwt.go
│
├─runtime
│  └─logs
│          log20220323.log
│          log20220324.log
│          log20220325.log
│
├─services
│  │  taskModels.pb.go
│  │  taskModels.pb.micro.go
│  │  taskService.pb.go
│  │  taskService.pb.micro.go
│  │  userModels.pb.go
│  │  userModels.pb.micro.go
│  │  userService.pb.go
│  │  userService.pb.micro.go
│  │
│  └─protos
│          taskModels.proto
│          taskService.proto
│          userModels.proto
│          userService.proto
│
├─weblib
│  │  router.go
│  │
│  ├─handlers
│  │      pkg.go
│  │      task.go
│  │      user.go
│  │
│  └─middleware
│          cors.go
│          init.go
│          jwt.go
│
└─wrappers
        taskWrapper.go
        userWrapper.go
</code></pre><ul>
<li>pkg/e : 封装错误码</li>
<li>pkg/logging : 日志文件</li>
<li>pkg/util : 工具函数</li>
<li>service/proto : 放置proto文件以及生成的pb文件</li>
<li>weblib/handlers : 各个服务的接口</li>
<li>weblib/middleware : http服务器的中间件</li>
<li>wrappers : 放置服务熔断的配置</li>
</ul>
<h3 id="运行-3">运行</h3>
<p>1、开启etcd和etcdkeeper（如果已经开启了，可以跳过）</p>
<p>2、使用命令<code>go run main.go --registry=etcd --registry_address=127.0.0.1:2379</code> 运行</p>
<p>看到如下效果为正确</p>
<p>
        <img class="mx-auto" alt="image-20220325203323717" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/image-20220325203323717.png" />   
    </p>
<h2 id="整体测试">整体测试</h2>
<p>1、用户注册：</p>
<p>使用post请求http://localhost:4000/api/v1/user/register</p>
<p>效果如下：</p>
<p>
        <img class="mx-auto" alt="image-20220323114234630" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/image-20220323114234630.png" />   
    </p>
<p>
        <img class="mx-auto" alt="image-20220323114328793" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/image-20220323114328793.png" />   
    </p>
<p>2、用户登录</p>
<p>使用post请求：http://{{url}}/api/v1/user/login（这边使用变量url代替localhost:4000；设置方法如下）</p>
<p>
        <img class="mx-auto" alt="image-20220323153054771" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/image-20220323153054771.png" />   
    </p>
<p>运行效果如下：</p>
<p>
        <img class="mx-auto" alt="image-20220323153127114" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/image-20220323153127114.png" />   
    </p>
<p>3、创建task</p>
<p>使用post方式请求：http://{{url}}/api/v1/task</p>
<p>效果如下：</p>
<p>
        <img class="mx-auto" alt="image-20220324175800368" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/image-20220324175800368.png" />   
    </p>
<p>5、查看task</p>
<p>使用get方式请求http://{{url}}/api/v1/tasks</p>
<p>效果如下：</p>
<p>
        <img class="mx-auto" alt="image-20220325091124912" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/image-20220325091124912.png" />   
    </p>
<p>6、修改task</p>
<p>使用put方式请求http://{{url}}/api/v1/task/1</p>
<p>效果如下：</p>
<p>
        <img class="mx-auto" alt="image-20220325203912335" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/image-20220325203912335.png" />   
    </p>
<h2 id="参考文献">参考文献</h2>
<blockquote>
<p>1、凡一B站  <a href="https://www.bilibili.com/video/BV1h44y1L7LN">https://www.bilibili.com/video/BV1h44y1L7LN</a></p>
<p>2、凡一博客上 <a href="https://blog.csdn.net/weixin_45304503/article/details/122286980">https://blog.csdn.net/weixin_45304503/article/details/122286980</a></p>
<p>​       凡一博客下 <a href="https://blog.csdn.net/weixin_45304503/article/details/122301707">https://blog.csdn.net/weixin_45304503/article/details/122301707</a></p>
<p>3、rabbitmq模型 <a href="https://blog.csdn.net/weixin_45304503/article/details/122405835">https://blog.csdn.net/weixin_45304503/article/details/122405835</a></p>
<p>4、rabbitmq安装 <a href="https://blog.csdn.net/qq_47588845/article/details/107986373">https://blog.csdn.net/qq_47588845/article/details/107986373</a></p>
<p>​      rabbitmq使用 <a href="https://blog.csdn.net/a18679016236/article/details/84965212">https://blog.csdn.net/a18679016236/article/details/84965212</a></p>
</blockquote>

        </div>

        


        

<div class="post-archive">
    <h2>相关文章</h2>
    <ul class="listing">
        
        <li><a href="/post/go-micro%E7%AC%94%E8%AE%B0/">Go Micro笔记</a></li>
        
        <li><a href="/post/grpc%E7%AC%94%E8%AE%B0/">Grpc笔记</a></li>
        
        <li><a href="/post/RPC%E7%AC%94%E8%AE%B0/">RPC笔记</a></li>
        
        <li><a href="/post/protobuf%E7%AC%94%E8%AE%B0/">Protobuf笔记</a></li>
        
        <li><a href="/post/Golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E9%80%89%E9%A1%B9%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">Golang设计模式 选项设计模式</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/Golang' target="_blank">Golang</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    
    

</div>

                    <footer id="footer">
    <div class="container">
        &copy; 2023 <a href="https://kevinbin123.github.io/">abin の 成长之路 By abin</a>.本站博客未经授权禁止转载.
		<br>
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="http://www.flysnow.org/" target="_blank">Theme</a> based on <a href="https://github.com/rujews/maupassant-hugo" target="_blank">maupassant</a>
		       
    </div>
</footer>


    
    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>
<style type="text/css">
div.highlight {
    position: relative;
    margin: 1em 0px;
}

.copy-code {
    display: none;
    position: absolute;
    top: 4px;
    right: 4px;
    color: rgba(255, 255, 255, 0.8);
    background: rgba(78, 78, 78, 0.8);
    border-radius: var(--radius);
    padding: 0 5px;
    font: inherit;
    user-select: none;
    cursor: pointer;
    border: 0;
    --radius: 8px;
}

div.highlight:hover .copy-code,pre:hover .copy-code {
    display: block;
}

</style>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>


    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




    <script src='/js/bootstrap.min.js'></script>

    <script src='/js/post_category.1.js'></script>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://kevinbin123.github.io/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://kevinbin123.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>

    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://kevinbin123.github.io/post/%E7%AE%80%E5%8D%95%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/" title="简单分布式系统" target="_blank">简单分布式系统</a>
    </li>
    
    <li>
        <a href="https://kevinbin123.github.io/post/fyne%E6%A1%88%E4%BE%8B%E4%B9%8B%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8/" title="Fyne案例之音乐播放器" target="_blank">Fyne案例之音乐播放器</a>
    </li>
    
    <li>
        <a href="https://kevinbin123.github.io/post/fyne%E6%A1%88%E4%BE%8B%E4%B9%8B%E6%8E%A5%E4%BD%8F%E4%BD%A0%E5%B0%8F%E6%B8%B8%E6%88%8F/" title="Fyne案例之接住你小游戏" target="_blank">Fyne案例之接住你小游戏</a>
    </li>
    
    <li>
        <a href="https://kevinbin123.github.io/post/gin&#43;vue2%E5%8D%9A%E5%AE%A2%E7%AC%94%E8%AE%B0%E5%89%8D%E7%AB%AF/" title="Gin&#43;vue2博客笔记（前端）" target="_blank">Gin&#43;vue2博客笔记（前端）</a>
    </li>
    
    <li>
        <a href="https://kevinbin123.github.io/post/gin&#43;vue2%E5%8D%9A%E5%AE%A2%E7%AC%94%E8%AE%B0%E5%90%8E%E7%AB%AF/" title="Gin&#43;vue2博客笔记（后端）" target="_blank">Gin&#43;vue2博客笔记（后端）</a>
    </li>
    
    <li>
        <a href="https://kevinbin123.github.io/post/PWA%E7%AC%94%E8%AE%B0/" title="PWA笔记" target="_blank">PWA笔记</a>
    </li>
    
    <li>
        <a href="https://kevinbin123.github.io/post/Golang%E6%A1%88%E4%BE%8B-zinx%E8%BD%BB%E9%87%8F%E7%BA%A7%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Golang案例 Zinx轻量级服务器框架学习笔记" target="_blank">Golang案例 Zinx轻量级服务器框架学习笔记</a>
    </li>
    
    <li>
        <a href="https://kevinbin123.github.io/post/Golang%E5%B0%8F%E6%A1%88%E4%BE%8B-%E7%88%AC%E5%8F%96%E8%B1%86%E7%93%A3%E7%94%B5%E5%BD%B1/" title="Golang小案例 爬取豆瓣电影" target="_blank">Golang小案例 爬取豆瓣电影</a>
    </li>
    
    <li>
        <a href="https://kevinbin123.github.io/post/go-micro%E6%A1%88%E4%BE%8B/" title="Go Micro案例" target="_blank">Go Micro案例</a>
    </li>
    
    <li>
        <a href="https://kevinbin123.github.io/post/go-micro%E7%AC%94%E8%AE%B0/" title="Go Micro笔记" target="_blank">Go Micro笔记</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://kevinbin123.github.io/categories/DB/">DB (2)</a></li>
    
    <li><a href="https://kevinbin123.github.io/categories/Golang/">Golang (19)</a></li>
    
    <li><a href="https://kevinbin123.github.io/categories/JavaScript/">JavaScript (1)</a></li>
    
    <li><a href="https://kevinbin123.github.io/categories/Network/">Network (1)</a></li>
    
    <li><a href="https://kevinbin123.github.io/categories/container/">container (1)</a></li>
    
    <li><a href="https://kevinbin123.github.io/categories/other/">other (5)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://kevinbin123.github.io/tags/DB/">DB</a>
    
    <a href="https://kevinbin123.github.io/tags/Golang/">Golang</a>
    
    <a href="https://kevinbin123.github.io/tags/JavaScript/">JavaScript</a>
    
    <a href="https://kevinbin123.github.io/tags/Network/">Network</a>
    
    <a href="https://kevinbin123.github.io/tags/container/">container</a>
    
    <a href="https://kevinbin123.github.io/tags/other/">other</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://www.liwenzhou.com/" title="go语言学习之路">李文周的博客</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://kevinbin123.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>
<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>Golang案例 Zinx轻量级服务器框架学习笔记 | abin の 成长之路</title>
    <meta property="og:title" content="Golang案例 Zinx轻量级服务器框架学习笔记 - abin の 成长之路">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2022-04-11T21:03:47&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2022-04-11T21:03:47&#43;08:00'>
        
    <meta name="Keywords" content="golang,go语言,go语言笔记,博客,项目管理,软件架构">
    <meta name="description" content="Golang案例 Zinx轻量级服务器框架学习笔记">
        
    <meta name="author" content="abin">
    <meta property="og:url" content="https://kevinbin123.github.io/post/Golang%E6%A1%88%E4%BE%8B-zinx%E8%BD%BB%E9%87%8F%E7%BA%A7%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
        <link rel="stylesheet" href='/css/sidebar_menu.css'>
    
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://kevinbin123.github.io/">
                        abin の 成长之路
                    </a>
                
                <p class="description">冉冉升起的码神</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://kevinbin123.github.io/">首页</a>
                    
                    <a  href="https://kevinbin123.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="https://kevinbin123.github.io/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">Golang案例 Zinx轻量级服务器框架学习笔记</h1>
        </header>
        
  <time datetime="2022-04-11T13:03:47Z" class="post-meta meta-date dt-published">
    2022年4月11日
  </time>


<div class="post-meta meta-category">
  <span>&nbsp;|</span>
  
    <a href='/categories/Golang' target="_blank">Golang</a>
  
</div>


        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">&nbsp;|
                <span id="busuanzi_value_page_pv"></span> <span>阅读</span>
            </span>
        </div>
        
        
        <div class="post-content">
            <h1 id="golang案例-zinx轻量级服务器框架学习笔记">Golang案例-zinx轻量级服务器框架学习笔记</h1>
<blockquote>
<p>案例来源：</p>
<p>《zinx-Golang轻量级TCP服务器框架(适合Go语言自学-深入浅出)》</p>
<p><a href="https://www.bilibili.com/video/BV1wE411d7th">https://www.bilibili.com/video/BV1wE411d7th</a></p>
</blockquote>
<h2 id="zinxv01-基础的server服务器">ZinxV0.1-基础的Server服务器</h2>
<p>Zinx分为ziface和znet模块；</p>
<p>ziface是抽象层接口，znet为具体的实现。</p>
<blockquote>
<p>zinx/ziface/IServer.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">ziface</span>

<span style="color:#75715e">//定义一个服务器接口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IServer</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">//启动服务器
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Start</span>()
	<span style="color:#75715e">//停止服务器
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Stop</span>()
	<span style="color:#75715e">//运行服务器
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Serve</span>()
}

</code></pre></div><blockquote>
<p>zinx/znet/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">//Iserver的接口实现，定义一个server的服务模块
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Server</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//服务器名称
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器绑定的ip版本
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IPVersion</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器监听的IP
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IP</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器监听的端口
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Port</span> <span style="color:#66d9ef">int</span>
}

<span style="color:#75715e">//启动服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;[Start] Server Listenner at IP:%s, Port %d, is starting\n&#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IP</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Port</span>)

	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#75715e">//1、获取一个TCP的addr
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ResolveTCPAddr</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s:%d&#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IP</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Port</span>))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;resolve tcp addr error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#75715e">//2、监听服务器地址
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">listenner</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ListenTCP</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#a6e22e">addr</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;listen &#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#e6db74">&#34;error :&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;start zinx Server succ &#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#e6db74">&#34; succ, Listenning...&#34;</span>)
		<span style="color:#75715e">//3、阻塞等待客户端连接，处理客户端连接业务（读写）
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> {
			<span style="color:#75715e">//如果有客户端连接过来，阻塞会返回
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listenner</span>.<span style="color:#a6e22e">Accept</span>()
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Accept err &#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">continue</span>
			}
			<span style="color:#75715e">//客户端连接已经建立，todosomething
</span><span style="color:#75715e"></span>			<span style="color:#75715e">//做一个最基本的最大512字节的长度的回显业务
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
				<span style="color:#66d9ef">for</span> {
					<span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">512</span>)
					<span style="color:#a6e22e">cnt</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">buf</span>)
					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
						<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;recv buf err :&#34;</span>, <span style="color:#a6e22e">err</span>)
						<span style="color:#66d9ef">continue</span>
					}
					<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;recv client buf %s,cnt %d\n&#34;</span>, <span style="color:#a6e22e">buf</span>, <span style="color:#a6e22e">cnt</span>)
					<span style="color:#75715e">//回显功能
</span><span style="color:#75715e"></span>					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">buf</span>[:<span style="color:#a6e22e">cnt</span>]); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
						<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;write back buf err &#34;</span>, <span style="color:#a6e22e">err</span>)
						<span style="color:#66d9ef">continue</span>
					}
				}
			}()
		}
	}()

}

<span style="color:#75715e">//停止服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Stop</span>() {
	<span style="color:#75715e">// TODO 将一些服务器的资源，状态或者一些已经开辟的链接信息，进行停止 或者回收
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">//运行服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Serve</span>() {
	<span style="color:#75715e">//启动server的服务功能
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Start</span>()

	<span style="color:#75715e">//TODO 做一些启动服务器之后的额外业务
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">//阻塞状态
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">select</span> {}
}

<span style="color:#75715e">/**
</span><span style="color:#75715e">初始化Server模块的方法
</span><span style="color:#75715e">*/</span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IServer</span> {
	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Server</span>{
		<span style="color:#a6e22e">Name</span>:      <span style="color:#a6e22e">name</span>,
		<span style="color:#a6e22e">IPVersion</span>: <span style="color:#e6db74">&#34;tcp4&#34;</span>,
		<span style="color:#a6e22e">IP</span>:        <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
		<span style="color:#a6e22e">Port</span>:      <span style="color:#ae81ff">8999</span>,
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>
}

</code></pre></div><p>编写demo进行测试</p>
<blockquote>
<p>myDemo/ZinxV0.1/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e">基于Zinx框架开发的 服务端应用程序
</span><span style="color:#75715e">*/</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//1、创建一个server句柄，使用Zinx的api
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#e6db74">&#34;[zinx V0.1]&#34;</span>)

	<span style="color:#75715e">//2、启动server
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Serve</span>()
}

</code></pre></div><blockquote>
<p>myDemo/ZinxV0.1/Client.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e">模拟客户端
</span><span style="color:#75715e">*/</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client start&#34;</span>)
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#75715e">//1、直接链接远程服务器，得到一个conn链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;127.0.0.1:8999&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client start err :&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//2、链接调用Write 写数据
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">&#34;hello zinx V0.1..&#34;</span>))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;write conn err :&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}

		<span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">512</span>)
		<span style="color:#a6e22e">cnt</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">buf</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read buf err :&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Server call back:%s, cnt=%d\n&#34;</span>, <span style="color:#a6e22e">buf</span>, <span style="color:#a6e22e">cnt</span>)

		<span style="color:#75715e">//cpu阻塞
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	}
}

</code></pre></div><p>注意：在myDemo项目中引用本地的项目的时候，需要在go.mod文件中使用replace关键字将本地的包进行替换，例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mod" data-lang="mod">module myDemo

go <span style="color:#ae81ff">1.13</span>

require zinx v0.<span style="color:#ae81ff">0.0</span>

replace zinx <span style="color:#f92672">=&gt;</span> ..<span style="color:#f92672">/</span>zinx
</code></pre></div><h2 id="zinxv02-链接封装和业务绑定">ZinxV0.2-链接封装和业务绑定</h2>
<p>在ziface中定义IConnection链接模块的抽象层</p>
<blockquote>
<p>zinx/ziface/iconnection.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">ziface</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;net&#34;</span>

<span style="color:#75715e">//定义链接模块的抽象层
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IConnection</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">//启动链接 让当前的链接准备开始工作
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Start</span>()
	<span style="color:#75715e">//停止链接 结束当前链接的工作
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Stop</span>()
	<span style="color:#75715e">//获取当前链接绑定socket conn
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetTCPConnection</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>
	<span style="color:#75715e">//获取当前链接模块的链接ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetConnId</span>() <span style="color:#66d9ef">uint32</span>
	<span style="color:#75715e">//获取远程客户端的TCP状态IP PORT
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">RemoteAddr</span>() <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Addr</span>
	<span style="color:#75715e">//发送数据，将数据发送给远程的客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Send</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#66d9ef">error</span>
}

<span style="color:#75715e">//定义一个处理业务的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HandleFunc</span> <span style="color:#66d9ef">func</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>, []<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">error</span>
</code></pre></div><blockquote>
<p>zinx/znet/connection.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">//链接模块
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Connection</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//当前链接的Socket TCP套接字
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>
	<span style="color:#75715e">//链接ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ConnId</span> <span style="color:#66d9ef">uint32</span>
	<span style="color:#75715e">//当前的链接状态
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">isClosed</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">//当前链接所绑定的处理业务方法API
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">handleAPi</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">HandleFunc</span>
	<span style="color:#75715e">//告知当前链接已经退出/停止 channle
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ExitChan</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>
}

<span style="color:#75715e">//初始化链接模块的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewConnection</span>(<span style="color:#a6e22e">conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>, <span style="color:#a6e22e">connId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">callback_api</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">HandleFunc</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span> {
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Connection</span>{
		<span style="color:#a6e22e">Conn</span>:      <span style="color:#a6e22e">conn</span>,
		<span style="color:#a6e22e">ConnId</span>:    <span style="color:#a6e22e">connId</span>,
		<span style="color:#a6e22e">handleAPi</span>: <span style="color:#a6e22e">callback_api</span>,
		<span style="color:#a6e22e">isClosed</span>:  <span style="color:#66d9ef">false</span>,
		<span style="color:#a6e22e">ExitChan</span>:  make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>, <span style="color:#ae81ff">1</span>),
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>
}

<span style="color:#75715e">//读数据的业务
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">StartReader</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Reader Goroutine is running...&#34;</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;connId = &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>, <span style="color:#e6db74">&#34; Reader is exit, remote addr is &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">RemoteAddr</span>().<span style="color:#a6e22e">String</span>())
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Stop</span>()
	<span style="color:#66d9ef">for</span> {
		<span style="color:#75715e">//读取客户端的数据到buf中，最大512字节
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">512</span>)
		<span style="color:#a6e22e">cnt</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">buf</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;recv buf err:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">continue</span>
		}
		<span style="color:#75715e">//调用当前链接所绑定的HandleAPI
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">handleAPi</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>, <span style="color:#a6e22e">buf</span>, <span style="color:#a6e22e">cnt</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;ConnId = &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>, <span style="color:#e6db74">&#34; handle is error &#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}

	}

}

<span style="color:#75715e">//实现接口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Conn Start().. ConnId=&#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>)

	<span style="color:#75715e">//启动从当前链接的读数据的业务
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">StartReader</span>()

	<span style="color:#75715e">//TODO 启动从当前链接写数据的业务
</span><span style="color:#75715e"></span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Stop</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Conn Stop() .. ConnId = &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>)

	<span style="color:#75715e">//如果当前链接已经关闭
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> = <span style="color:#66d9ef">true</span>
	<span style="color:#75715e">//关闭socket链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#75715e">//回收资源
</span><span style="color:#75715e"></span>	close(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ExitChan</span>)
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">GetTCPConnection</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">GetConnId</span>() <span style="color:#66d9ef">uint32</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">RemoteAddr</span>() <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Addr</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">RemoteAddr</span>()
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Send</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><blockquote>
<p>zinx/znet/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;errors&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">//Iserver的接口实现，定义一个server的服务模块
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Server</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//服务器名称
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器绑定的ip版本
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IPVersion</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器监听的IP
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IP</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器监听的端口
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Port</span> <span style="color:#66d9ef">int</span>
}

<span style="color:#75715e">//定义当前客户端连接的所绑定handle_api（目前是写死的，后续应该由用户自定义）
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CallBackToClient</span>(<span style="color:#a6e22e">conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>, <span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">cnt</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#75715e">//回显的业务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;[Conn Handle] CallBackToClient...&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">data</span>[:<span style="color:#a6e22e">cnt</span>]); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;write back buf err &#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;CallBackToClient error&#34;</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">//启动服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;[Start] Server Listenner at IP:%s, Port %d, is starting\n&#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IP</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Port</span>)

	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#75715e">//1、获取一个TCP的addr
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ResolveTCPAddr</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s:%d&#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IP</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Port</span>))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;resolve tcp addr error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#75715e">//2、监听服务器地址
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">listenner</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ListenTCP</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#a6e22e">addr</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;listen &#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#e6db74">&#34;error :&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;start zinx Server succ &#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#e6db74">&#34; succ, Listenning...&#34;</span>)
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cid</span> <span style="color:#66d9ef">uint32</span>
		<span style="color:#a6e22e">cid</span> = <span style="color:#ae81ff">0</span>
		<span style="color:#75715e">//3、阻塞等待客户端连接，处理客户端连接业务（读写）
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> {
			<span style="color:#75715e">//如果有客户端连接过来，阻塞会返回
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listenner</span>.<span style="color:#a6e22e">AcceptTCP</span>()
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Accept err &#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">continue</span>
			}
			<span style="color:#75715e">//客户端连接已经建立，todosomething
</span><span style="color:#75715e"></span>			<span style="color:#75715e">//将处理新连接的业务方法 和 conn进行绑定 得到我们的链接模块
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">dealConn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewConnection</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">cid</span>, <span style="color:#a6e22e">CallBackToClient</span>)
			<span style="color:#a6e22e">cid</span><span style="color:#f92672">++</span>

			<span style="color:#75715e">//启动当前的链接业务
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">dealConn</span>.<span style="color:#a6e22e">Start</span>()
		}
	}()

}

<span style="color:#75715e">//停止服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Stop</span>() {
	<span style="color:#75715e">// TODO 将一些服务器的资源，状态或者一些已经开辟的链接信息，进行停止 或者回收
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">//运行服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Serve</span>() {
	<span style="color:#75715e">//启动server的服务功能
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Start</span>()

	<span style="color:#75715e">//TODO 做一些启动服务器之后的额外业务
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">//阻塞状态
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">select</span> {}
}

<span style="color:#75715e">/**
</span><span style="color:#75715e">初始化Server模块的方法
</span><span style="color:#75715e">*/</span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IServer</span> {
	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Server</span>{
		<span style="color:#a6e22e">Name</span>:      <span style="color:#a6e22e">name</span>,
		<span style="color:#a6e22e">IPVersion</span>: <span style="color:#e6db74">&#34;tcp4&#34;</span>,
		<span style="color:#a6e22e">IP</span>:        <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
		<span style="color:#a6e22e">Port</span>:      <span style="color:#ae81ff">8999</span>,
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>
}
</code></pre></div><p>编写Demo进行测试</p>
<blockquote>
<p>myDemo/zinxv0.2/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e">基于Zinx框架开发的 服务端应用程序
</span><span style="color:#75715e">*/</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//1、创建一个server句柄，使用Zinx的api
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#e6db74">&#34;[zinx V0.1]&#34;</span>)

	<span style="color:#75715e">//2、启动server
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Serve</span>()
}
</code></pre></div><blockquote>
<p>myDemo/zinxv0.2/Client.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e">模拟客户端
</span><span style="color:#75715e">*/</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client start&#34;</span>)
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#75715e">//1、直接链接远程服务器，得到一个conn链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;127.0.0.1:8999&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client start err :&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//2、链接调用Write 写数据
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">&#34;hello zinx V0.1..&#34;</span>))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;write conn err :&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}

		<span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">512</span>)
		<span style="color:#a6e22e">cnt</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">buf</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read buf err :&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Server call back:%s, cnt=%d\n&#34;</span>, <span style="color:#a6e22e">buf</span>, <span style="color:#a6e22e">cnt</span>)

		<span style="color:#75715e">//cpu阻塞
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	}
}
</code></pre></div><h2 id="zinxv03-框架基础路由模块">ZinxV0.3-框架基础路由模块</h2>
<p>给用户添加自定义处理业务的接口</p>
<blockquote>
<p>zinx/ziface/irequest.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">ziface</span>

<span style="color:#75715e">/**
</span><span style="color:#75715e">IRequest接口：
</span><span style="color:#75715e">实际上是把客户端请求的链接信息 和 请求的数据 包装到一个Request中
</span><span style="color:#75715e">*/</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IRequest</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">//得到当前链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetConnection</span>() <span style="color:#a6e22e">IConnection</span>
	<span style="color:#75715e">//得到请求的消息数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetData</span>() []<span style="color:#66d9ef">byte</span>
}
</code></pre></div><blockquote>
<p>zinx/znet/request.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;zinx/ziface&#34;</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Request</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//已经和客户端建立好的链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>
	<span style="color:#75715e">//客户端请求的数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>
}

<span style="color:#75715e">//实现接口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Request</span>) <span style="color:#a6e22e">GetConnection</span>() <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">conn</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Request</span>) <span style="color:#a6e22e">GetData</span>() []<span style="color:#66d9ef">byte</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">data</span>
}
</code></pre></div><blockquote>
<p>zinx/ziface/irouter.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">ziface</span>

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 路由抽象接口：
</span><span style="color:#75715e"> * 路由里面的数据都是IRequest
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IRouter</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">//在处理conn业务之前的方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PreHandle</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">IRequest</span>)
	<span style="color:#75715e">//在处理conn业务的主方法hook
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">IRequest</span>)
	<span style="color:#75715e">//在处理conn业务之后的方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PostHandle</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">IRequest</span>)
}
</code></pre></div><blockquote>
<p>zinx/znet/router.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;zinx/ziface&#34;</span>

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 实现router时，先嵌入这个BaseRouter基类，然后根据需要对这个基类的方法进行重写就好了
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">BaseRouter</span> <span style="color:#66d9ef">struct</span> {
}

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 这里之所以BaseRouter的方法都为空
</span><span style="color:#75715e"> * 是因为有的Router不希望实现Pre或者Post的方法
</span><span style="color:#75715e"> * 所以BaseRouter都实现，只需要继承BaseRouter就可以了，而不需要去实现Pre和Post方法
</span><span style="color:#75715e"> */</span>
<span style="color:#75715e">//实现接口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">br</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">BaseRouter</span>) <span style="color:#a6e22e">PreHandle</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>)  {}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">br</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">BaseRouter</span>) <span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>)     {}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">br</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">BaseRouter</span>) <span style="color:#a6e22e">PostHandle</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>) {}
</code></pre></div><p>集成路由功能</p>
<blockquote>
<p>zinx/ziface/iserver.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">ziface</span>

<span style="color:#75715e">//定义一个服务器接口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IServer</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">//启动服务器
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Start</span>()
	<span style="color:#75715e">//停止服务器
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Stop</span>()
	<span style="color:#75715e">//运行服务器
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Serve</span>()
	<span style="color:#75715e">//路由功能：给当前的服务注册一个路由方法，供客户端的链接处理使用
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">AddRouter</span>(<span style="color:#a6e22e">router</span> <span style="color:#a6e22e">IRouter</span>)
}
</code></pre></div><blockquote>
<p>zinx/znet/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">//Iserver的接口实现，定义一个server的服务模块
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Server</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//服务器名称
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器绑定的ip版本
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IPVersion</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器监听的IP
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IP</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器监听的端口
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Port</span> <span style="color:#66d9ef">int</span>
	<span style="color:#75715e">//当前的Server添加一个router,server注册的链接对应的业务处理
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Router</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>
}

<span style="color:#75715e">//启动服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;[Start] Server Listenner at IP:%s, Port %d, is starting\n&#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IP</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Port</span>)

	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#75715e">//1、获取一个TCP的addr
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ResolveTCPAddr</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s:%d&#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IP</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Port</span>))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;resolve tcp addr error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#75715e">//2、监听服务器地址
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">listenner</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ListenTCP</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#a6e22e">addr</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;listen &#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#e6db74">&#34;error :&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;start zinx Server succ &#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#e6db74">&#34; succ, Listenning...&#34;</span>)
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cid</span> <span style="color:#66d9ef">uint32</span>
		<span style="color:#a6e22e">cid</span> = <span style="color:#ae81ff">0</span>
		<span style="color:#75715e">//3、阻塞等待客户端连接，处理客户端连接业务（读写）
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> {
			<span style="color:#75715e">//如果有客户端连接过来，阻塞会返回
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listenner</span>.<span style="color:#a6e22e">AcceptTCP</span>()
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Accept err &#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">continue</span>
			}
			<span style="color:#75715e">//客户端连接已经建立，todosomething
</span><span style="color:#75715e"></span>			<span style="color:#75715e">//将处理新连接的业务方法 和 conn进行绑定 得到我们的链接模块
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">dealConn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewConnection</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">cid</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Router</span>)
			<span style="color:#a6e22e">cid</span><span style="color:#f92672">++</span>

			<span style="color:#75715e">//启动当前的链接业务
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">dealConn</span>.<span style="color:#a6e22e">Start</span>()
		}
	}()

}

<span style="color:#75715e">//停止服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Stop</span>() {
	<span style="color:#75715e">// TODO 将一些服务器的资源，状态或者一些已经开辟的链接信息，进行停止 或者回收
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">//运行服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Serve</span>() {
	<span style="color:#75715e">//启动server的服务功能
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Start</span>()

	<span style="color:#75715e">//TODO 做一些启动服务器之后的额外业务
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">//阻塞状态
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">select</span> {}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">AddRouter</span>(<span style="color:#a6e22e">router</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>) {
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Router</span> = <span style="color:#a6e22e">router</span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Add Router Succ!!&#34;</span>)
}

<span style="color:#75715e">/**
</span><span style="color:#75715e">初始化Server模块的方法
</span><span style="color:#75715e">*/</span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IServer</span> {
	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Server</span>{
		<span style="color:#a6e22e">Name</span>:      <span style="color:#a6e22e">name</span>,
		<span style="color:#a6e22e">IPVersion</span>: <span style="color:#e6db74">&#34;tcp4&#34;</span>,
		<span style="color:#a6e22e">IP</span>:        <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
		<span style="color:#a6e22e">Port</span>:      <span style="color:#ae81ff">8999</span>,
		<span style="color:#a6e22e">Router</span>:    <span style="color:#66d9ef">nil</span>,
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>
}
</code></pre></div><blockquote>
<p>zinx/znet/connection.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">//链接模块
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Connection</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//当前链接的Socket TCP套接字
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>
	<span style="color:#75715e">//链接ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ConnId</span> <span style="color:#66d9ef">uint32</span>
	<span style="color:#75715e">//当前的链接状态
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">isClosed</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">//告知当前链接已经退出/停止 channle
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ExitChan</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">//该链接处理的方法Router
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Router</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>
}

<span style="color:#75715e">//初始化链接模块的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewConnection</span>(<span style="color:#a6e22e">conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>, <span style="color:#a6e22e">connId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">router</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span> {
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Connection</span>{
		<span style="color:#a6e22e">Conn</span>:     <span style="color:#a6e22e">conn</span>,
		<span style="color:#a6e22e">ConnId</span>:   <span style="color:#a6e22e">connId</span>,
		<span style="color:#a6e22e">Router</span>:   <span style="color:#a6e22e">router</span>,
		<span style="color:#a6e22e">isClosed</span>: <span style="color:#66d9ef">false</span>,
		<span style="color:#a6e22e">ExitChan</span>: make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>, <span style="color:#ae81ff">1</span>),
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>
}

<span style="color:#75715e">//读数据的业务
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">StartReader</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Reader Goroutine is running...&#34;</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;connId = &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>, <span style="color:#e6db74">&#34; Reader is exit, remote addr is &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">RemoteAddr</span>().<span style="color:#a6e22e">String</span>())
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Stop</span>()
	<span style="color:#66d9ef">for</span> {
		<span style="color:#75715e">//读取客户端的数据到buf中，最大512字节
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">512</span>)
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">buf</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;recv buf err:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">continue</span>
		}
		<span style="color:#75715e">//得到当前conn数据的Request请求数据
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Request</span>{
			<span style="color:#a6e22e">conn</span>: <span style="color:#a6e22e">c</span>,
			<span style="color:#a6e22e">data</span>: <span style="color:#a6e22e">buf</span>,
		}
		<span style="color:#75715e">//从路由中，找到注册绑定的Conn对应的Router调用
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>) {
			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Router</span>.<span style="color:#a6e22e">PreHandle</span>(<span style="color:#a6e22e">request</span>)
			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Router</span>.<span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">request</span>)
			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Router</span>.<span style="color:#a6e22e">PostHandle</span>(<span style="color:#a6e22e">request</span>)
		}(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">req</span>)

	}

}

<span style="color:#75715e">//实现接口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Conn Start().. ConnId=&#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>)

	<span style="color:#75715e">//启动从当前链接的读数据的业务
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">StartReader</span>()

	<span style="color:#75715e">//TODO 启动从当前链接写数据的业务
</span><span style="color:#75715e"></span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Stop</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Conn Stop() .. ConnId = &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>)

	<span style="color:#75715e">//如果当前链接已经关闭
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> = <span style="color:#66d9ef">true</span>
	<span style="color:#75715e">//关闭socket链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#75715e">//回收资源
</span><span style="color:#75715e"></span>	close(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ExitChan</span>)
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">GetTCPConnection</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">GetConnId</span>() <span style="color:#66d9ef">uint32</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">RemoteAddr</span>() <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Addr</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">RemoteAddr</span>()
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Send</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>使用Demo进行测试</p>
<blockquote>
<p>myDemo/zinxv0.3/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e">基于Zinx框架开发的 服务端应用程序
</span><span style="color:#75715e">*/</span>

<span style="color:#75715e">//ping test自定义路由
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PingRouter</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">BaseRouter</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">pr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PingRouter</span>) <span style="color:#a6e22e">PreHandle</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Call Router PreHandle...&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetConnection</span>().<span style="color:#a6e22e">GetTCPConnection</span>().<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">&#34;before ping...\n&#34;</span>)); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;call back before ping error&#34;</span>)
	}
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">pr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PingRouter</span>) <span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Call Router Handle...&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetConnection</span>().<span style="color:#a6e22e">GetTCPConnection</span>().<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">&#34;ping ping ping...\n&#34;</span>)); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;call back ping ping ping error&#34;</span>)
	}
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">pr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PingRouter</span>) <span style="color:#a6e22e">PostHandle</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Call Router PostHandle...&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetConnection</span>().<span style="color:#a6e22e">GetTCPConnection</span>().<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">&#34;after ping...\n&#34;</span>)); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;call back after ping error&#34;</span>)
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//1、创建一个server句柄，使用Zinx的api
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#e6db74">&#34;[zinx V0.1]&#34;</span>)
	<span style="color:#75715e">//2、给当前zinx框架添加一个自定义的router
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">AddRouter</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">PingRouter</span>{})
	<span style="color:#75715e">//3、启动server
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Serve</span>()
}
</code></pre></div><blockquote>
<p>myDemo/zinxv0.3/Client.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e">模拟客户端
</span><span style="color:#75715e">*/</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client start&#34;</span>)
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#75715e">//1、直接链接远程服务器，得到一个conn链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;127.0.0.1:8999&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client start err :&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//2、链接调用Write 写数据
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">&#34;hello zinx V0.1..&#34;</span>))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;write conn err :&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}

		<span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">512</span>)
		<span style="color:#a6e22e">cnt</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">buf</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read buf err :&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Server call back:%s, cnt=%d\n&#34;</span>, <span style="color:#a6e22e">buf</span>, <span style="color:#a6e22e">cnt</span>)

		<span style="color:#75715e">//cpu阻塞
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	}
}
</code></pre></div><h2 id="zinxv04-从配置文件中读取配置">ZinxV0.4-从配置文件中读取配置</h2>
<p>为避免后续频繁修改参数的麻烦，设计一个加载配置的模块</p>
<blockquote>
<p>zinx/utils/globalobj.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">utils</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;bufio&#34;</span>
	<span style="color:#e6db74">&#34;encoding/json&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 存储一切有关Zinx框架的全局参数，供其他模块使用
</span><span style="color:#75715e"> * 一些参数是可以通过zinx.json由用户进行配置
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">GlobalObj</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//server
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">TcpServer</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IServer</span> <span style="color:#75715e">//当前Zinx全局的Server对象
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Host</span>      <span style="color:#66d9ef">string</span>         <span style="color:#75715e">//当前服务器主机监听的IP
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">TcpPort</span>   <span style="color:#66d9ef">int</span>            <span style="color:#75715e">//当前服务器主机监听的端口
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Name</span>      <span style="color:#66d9ef">string</span>         <span style="color:#75715e">//当前服务器的名称
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">//Zinx
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Version</span>        <span style="color:#66d9ef">string</span> <span style="color:#75715e">//当前Zinx的版本号
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MaxConn</span>        <span style="color:#66d9ef">int</span>    <span style="color:#75715e">//当前服务器主机允许的最大连接数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MaxPackageSize</span> <span style="color:#66d9ef">uint32</span> <span style="color:#75715e">//当前Zinx框架数据包的最大值
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">//定义一个全局的对外的GlobalObj
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">GlobalObject</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">GlobalObj</span>

<span style="color:#75715e">// 从zinx.json去加载用于自定义的参数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">g</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">GlobalObj</span>) <span style="color:#a6e22e">Reload</span>() {
	<span style="color:#75715e">/*
</span><span style="color:#75715e">		data, err := ioutil.ReadFile(&#34;./conf/zinx.json&#34;)
</span><span style="color:#75715e">		if err != nil {
</span><span style="color:#75715e">			fmt.Println(&#34;read zinx.json err &#34;, err)
</span><span style="color:#75715e">			return
</span><span style="color:#75715e">		}
</span><span style="color:#75715e">		err = json.Unmarshal(data, &amp;GlobalObject)
</span><span style="color:#75715e">		if err != nil {
</span><span style="color:#75715e">			panic(err)
</span><span style="color:#75715e">		}
</span><span style="color:#75715e">	*/</span>
	<span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;C:\\MySoft\\gocode\\src\\myDemo\\ZinxV0.4\\conf\\zinx.json&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Close</span>()

	<span style="color:#a6e22e">reader</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">file</span>)
	<span style="color:#a6e22e">decoder</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">NewDecoder</span>(<span style="color:#a6e22e">reader</span>)
	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">decoder</span>.<span style="color:#a6e22e">Decode</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">GlobalObject</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
}

<span style="color:#75715e">//提供一个Init方法，初始化当前的GlobalObject
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>() {
	<span style="color:#a6e22e">GlobalObject</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">GlobalObj</span>{
		<span style="color:#a6e22e">Name</span>:           <span style="color:#e6db74">&#34;ZinxServerApp&#34;</span>,
		<span style="color:#a6e22e">Version</span>:        <span style="color:#e6db74">&#34;V0.4&#34;</span>,
		<span style="color:#a6e22e">TcpPort</span>:        <span style="color:#ae81ff">8999</span>,
		<span style="color:#a6e22e">Host</span>:           <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
		<span style="color:#a6e22e">MaxConn</span>:        <span style="color:#ae81ff">1000</span>,
		<span style="color:#a6e22e">MaxPackageSize</span>: <span style="color:#ae81ff">4096</span>,
	}
	<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Reload</span>()
}
</code></pre></div><p>对文件中写死的参数进行修改</p>
<blockquote>
<p>zinx/znet/connection.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;zinx/utils&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">//链接模块
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Connection</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//当前链接的Socket TCP套接字
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>
	<span style="color:#75715e">//链接ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ConnId</span> <span style="color:#66d9ef">uint32</span>
	<span style="color:#75715e">//当前的链接状态
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">isClosed</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">//告知当前链接已经退出/停止 channle
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ExitChan</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">//该链接处理的方法Router
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Router</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>
}

<span style="color:#75715e">//初始化链接模块的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewConnection</span>(<span style="color:#a6e22e">conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>, <span style="color:#a6e22e">connId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">router</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span> {
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Connection</span>{
		<span style="color:#a6e22e">Conn</span>:     <span style="color:#a6e22e">conn</span>,
		<span style="color:#a6e22e">ConnId</span>:   <span style="color:#a6e22e">connId</span>,
		<span style="color:#a6e22e">Router</span>:   <span style="color:#a6e22e">router</span>,
		<span style="color:#a6e22e">isClosed</span>: <span style="color:#66d9ef">false</span>,
		<span style="color:#a6e22e">ExitChan</span>: make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>, <span style="color:#ae81ff">1</span>),
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>
}

<span style="color:#75715e">//读数据的业务
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">StartReader</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Reader Goroutine is running...&#34;</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;connId = &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>, <span style="color:#e6db74">&#34; Reader is exit, remote addr is &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">RemoteAddr</span>().<span style="color:#a6e22e">String</span>())
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Stop</span>()
	<span style="color:#66d9ef">for</span> {
		<span style="color:#75715e">//读取客户端的数据到buf中，最大512字节
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">MaxPackageSize</span>)
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">buf</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;recv buf err:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">continue</span>
		}
		<span style="color:#75715e">//得到当前conn数据的Request请求数据
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Request</span>{
			<span style="color:#a6e22e">conn</span>: <span style="color:#a6e22e">c</span>,
			<span style="color:#a6e22e">data</span>: <span style="color:#a6e22e">buf</span>,
		}
		<span style="color:#75715e">//从路由中，找到注册绑定的Conn对应的Router调用
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>) {
			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Router</span>.<span style="color:#a6e22e">PreHandle</span>(<span style="color:#a6e22e">request</span>)
			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Router</span>.<span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">request</span>)
			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Router</span>.<span style="color:#a6e22e">PostHandle</span>(<span style="color:#a6e22e">request</span>)
		}(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">req</span>)

	}

}

<span style="color:#75715e">//实现接口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Conn Start().. ConnId=&#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>)

	<span style="color:#75715e">//启动从当前链接的读数据的业务
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">StartReader</span>()

	<span style="color:#75715e">//TODO 启动从当前链接写数据的业务
</span><span style="color:#75715e"></span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Stop</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Conn Stop() .. ConnId = &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>)

	<span style="color:#75715e">//如果当前链接已经关闭
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> = <span style="color:#66d9ef">true</span>
	<span style="color:#75715e">//关闭socket链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#75715e">//回收资源
</span><span style="color:#75715e"></span>	close(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ExitChan</span>)
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">GetTCPConnection</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">GetConnId</span>() <span style="color:#66d9ef">uint32</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">RemoteAddr</span>() <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Addr</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">RemoteAddr</span>()
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Send</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><blockquote>
<p>zinx/znet/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;zinx/utils&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">//Iserver的接口实现，定义一个server的服务模块
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Server</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//服务器名称
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器绑定的ip版本
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IPVersion</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器监听的IP
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IP</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器监听的端口
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Port</span> <span style="color:#66d9ef">int</span>
	<span style="color:#75715e">//当前的Server添加一个router,server注册的链接对应的业务处理
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Router</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>
}

<span style="color:#75715e">//启动服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;[Zinx] Server Name:%s, listenner at Ip:%s , Port:%d is starting\n&#34;</span>,
		<span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Host</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">TcpPort</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;[Zinx] Version %s, MaxConn:%d, MaxPacketSize:%d\n&#34;</span>,
		<span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Version</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">MaxConn</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">MaxPackageSize</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;[Start] Server Listenner at IP:%s, Port %d, is starting\n&#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IP</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Port</span>)

	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#75715e">//1、获取一个TCP的addr
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ResolveTCPAddr</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s:%d&#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IP</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Port</span>))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;resolve tcp addr error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#75715e">//2、监听服务器地址
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">listenner</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ListenTCP</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#a6e22e">addr</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;listen &#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#e6db74">&#34;error :&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;start zinx Server succ &#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#e6db74">&#34; succ, Listenning...&#34;</span>)
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cid</span> <span style="color:#66d9ef">uint32</span>
		<span style="color:#a6e22e">cid</span> = <span style="color:#ae81ff">0</span>
		<span style="color:#75715e">//3、阻塞等待客户端连接，处理客户端连接业务（读写）
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> {
			<span style="color:#75715e">//如果有客户端连接过来，阻塞会返回
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listenner</span>.<span style="color:#a6e22e">AcceptTCP</span>()
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Accept err &#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">continue</span>
			}
			<span style="color:#75715e">//客户端连接已经建立，todosomething
</span><span style="color:#75715e"></span>			<span style="color:#75715e">//将处理新连接的业务方法 和 conn进行绑定 得到我们的链接模块
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">dealConn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewConnection</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">cid</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Router</span>)
			<span style="color:#a6e22e">cid</span><span style="color:#f92672">++</span>

			<span style="color:#75715e">//启动当前的链接业务
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">dealConn</span>.<span style="color:#a6e22e">Start</span>()
		}
	}()

}

<span style="color:#75715e">//停止服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Stop</span>() {
	<span style="color:#75715e">// TODO 将一些服务器的资源，状态或者一些已经开辟的链接信息，进行停止 或者回收
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">//运行服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Serve</span>() {
	<span style="color:#75715e">//启动server的服务功能
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Start</span>()

	<span style="color:#75715e">//TODO 做一些启动服务器之后的额外业务
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">//阻塞状态
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">select</span> {}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">AddRouter</span>(<span style="color:#a6e22e">router</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>) {
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Router</span> = <span style="color:#a6e22e">router</span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Add Router Succ!!&#34;</span>)
}

<span style="color:#75715e">/**
</span><span style="color:#75715e">初始化Server模块的方法
</span><span style="color:#75715e">*/</span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IServer</span> {
	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Server</span>{
		<span style="color:#a6e22e">Name</span>:      <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Name</span>,
		<span style="color:#a6e22e">IPVersion</span>: <span style="color:#e6db74">&#34;tcp4&#34;</span>,
		<span style="color:#a6e22e">IP</span>:        <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Host</span>,
		<span style="color:#a6e22e">Port</span>:      <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">TcpPort</span>,
		<span style="color:#a6e22e">Router</span>:    <span style="color:#66d9ef">nil</span>,
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>
}
</code></pre></div><p>测试Demo如同zinxV0.3的一样，能够正常发送数据并相应数据即为正常。</p>
<p>新增zinx.json文件</p>
<blockquote>
<p>myDemo/ZinxV0.4/conf/zinx.json</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;Zinx v0.4 demoServerApp&#34;</span>,
  <span style="color:#f92672">&#34;Host&#34;</span>: <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>,
  <span style="color:#f92672">&#34;TcpPort&#34;</span>: <span style="color:#ae81ff">7777</span>,
  <span style="color:#f92672">&#34;MaxConn&#34;</span>: <span style="color:#ae81ff">3</span>
}
</code></pre></div><h2 id="zinxv05-消息封装">ZinxV0.5-消息封装</h2>
<p>创建消息分装的类型</p>
<blockquote>
<p>zinx/ziface/imessage.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">ziface</span>

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 将请求的消息封装到一个Message中，定义抽象的结构
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IMessage</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">//获取消息ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetMsgId</span>() <span style="color:#66d9ef">uint32</span>
	<span style="color:#75715e">//获取消息长度
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetMsgLen</span>() <span style="color:#66d9ef">uint32</span>
	<span style="color:#75715e">//获取消息内容
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetData</span>() []<span style="color:#66d9ef">byte</span>

	<span style="color:#75715e">//设置消息ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SetMsgId</span>(<span style="color:#66d9ef">uint32</span>)
	<span style="color:#75715e">//设置消息长度
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SetMsgLen</span>(<span style="color:#66d9ef">uint32</span>)
	<span style="color:#75715e">//设置消息内容
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SetData</span>([]<span style="color:#66d9ef">byte</span>)
}
</code></pre></div><blockquote>
<p>zinx/znet/message.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 消息结构体
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Message</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Id</span>      <span style="color:#66d9ef">uint32</span> <span style="color:#75715e">//消息ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">DataLen</span> <span style="color:#66d9ef">uint32</span> <span style="color:#75715e">//消息长度
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Data</span>    []<span style="color:#66d9ef">byte</span> <span style="color:#75715e">//消息内容
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">//创建Message消息包的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewMsgPackage</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Message</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Message</span>{
		<span style="color:#a6e22e">Id</span>:      <span style="color:#a6e22e">id</span>,
		<span style="color:#a6e22e">DataLen</span>: uint32(len(<span style="color:#a6e22e">data</span>)),
		<span style="color:#a6e22e">Data</span>:    <span style="color:#a6e22e">data</span>,
	}
}

<span style="color:#75715e">//实现结构
</span><span style="color:#75715e">//获取消息ID
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Message</span>) <span style="color:#a6e22e">GetMsgId</span>() <span style="color:#66d9ef">uint32</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Id</span>
}

<span style="color:#75715e">//获取消息长度
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Message</span>) <span style="color:#a6e22e">GetMsgLen</span>() <span style="color:#66d9ef">uint32</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">DataLen</span>
}

<span style="color:#75715e">//获取消息内容
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Message</span>) <span style="color:#a6e22e">GetData</span>() []<span style="color:#66d9ef">byte</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Data</span>
}

<span style="color:#75715e">//设置消息ID
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Message</span>) <span style="color:#a6e22e">SetMsgId</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">uint32</span>) {
	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Id</span> = <span style="color:#a6e22e">id</span>
}

<span style="color:#75715e">//设置消息长度
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Message</span>) <span style="color:#a6e22e">SetMsgLen</span>(<span style="color:#a6e22e">len</span> <span style="color:#66d9ef">uint32</span>) {
	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">DataLen</span> = <span style="color:#a6e22e">len</span>
}

<span style="color:#75715e">//设置消息内容
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Message</span>) <span style="color:#a6e22e">SetData</span>(<span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) {
	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Data</span> = <span style="color:#a6e22e">data</span>
}
</code></pre></div><p>为解决粘包问题，使用TLV(Type-Len-Value)格式来解决。</p>
<blockquote>
<p>zinx/ziface/idatapack.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">ziface</span>

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 封包、拆包模块，
</span><span style="color:#75715e"> * 直接面向TCP连接中的数据流，用于处理TCP黏包问题
</span><span style="color:#75715e"> * 解决tcp黏包问题的封包拆包的模块；
</span><span style="color:#75715e"> * 针对TLV格式的Message进行封包和拆包
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IDataPack</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">//获取包的头的长度
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetHeadLen</span>() <span style="color:#66d9ef">uint32</span>
	<span style="color:#75715e">//封包的方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Pack</span>(<span style="color:#a6e22e">msg</span> <span style="color:#a6e22e">IMessage</span>) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#75715e">//拆包的方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">UnPack</span>([]<span style="color:#66d9ef">byte</span>) (<span style="color:#a6e22e">IMessage</span>, <span style="color:#66d9ef">error</span>)
}
</code></pre></div><blockquote>
<p>zinx/znet/datapack.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;bytes&#34;</span>
	<span style="color:#e6db74">&#34;encoding/binary&#34;</span>
	<span style="color:#e6db74">&#34;errors&#34;</span>
	<span style="color:#e6db74">&#34;zinx/utils&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 具体封包、拆包实现
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DataPack</span> <span style="color:#66d9ef">struct</span> {
}

<span style="color:#75715e">//初始化实例
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewDataPack</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">DataPack</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">DataPack</span>{}
}

<span style="color:#75715e">//接口实现
</span><span style="color:#75715e">//获取包的头的长度
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">dp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DataPack</span>) <span style="color:#a6e22e">GetHeadLen</span>() <span style="color:#66d9ef">uint32</span> {
	<span style="color:#75715e">//DataLen uint32(4字节) + Id uint32(4字节)
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">8</span>
}

<span style="color:#75715e">//封包的方法
</span><span style="color:#75715e">//数据格式为： dataLen|Id|data
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">dp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DataPack</span>) <span style="color:#a6e22e">Pack</span>(<span style="color:#a6e22e">msg</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IMessage</span>) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#75715e">//创建一个存放bytes字节的缓冲
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dataBuff</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">NewBuffer</span>([]<span style="color:#66d9ef">byte</span>{})
	<span style="color:#75715e">//将datalen写进dataBuff中
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">dataBuff</span>, <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">LittleEndian</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgLen</span>())
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#75715e">//将id写进dataBuff中
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">dataBuff</span>, <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">LittleEndian</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgId</span>())
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#75715e">//将data写进dataBuff中
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">dataBuff</span>, <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">LittleEndian</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetData</span>())
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">dataBuff</span>.<span style="color:#a6e22e">Bytes</span>(), <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">//拆包的方法
</span><span style="color:#75715e">//将包的Head的信息读出来，得到dataLen和ID；之后再根据dataLen去读
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">dp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DataPack</span>) <span style="color:#a6e22e">UnPack</span>(<span style="color:#a6e22e">binarydata</span> []<span style="color:#66d9ef">byte</span>) (<span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IMessage</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#75715e">//创建一个输入二进制数据的ioReader
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dataBuff</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">binarydata</span>)
	<span style="color:#75715e">//只解压head信息，得到datalen和id
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Message</span>{}
	<span style="color:#75715e">//读取datalen
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">dataBuff</span>, <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">LittleEndian</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">DataLen</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#75715e">//读取id
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">dataBuff</span>, <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">LittleEndian</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Id</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#75715e">//判断datalen是否已经超过最大的设置
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">MaxPackageSize</span> &gt; <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">DataLen</span> &gt; <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">MaxPackageSize</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;too Large msg data recv!&#34;</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">msg</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>测试拆包封包能力</p>
<blockquote>
<p>zinx/znet/datapack-test.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;io&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;testing&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestDataPack</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#75715e">//创建一个服务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">listener</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;127.0.0.1:7777&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;listen tcp err:&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#75715e">//监听
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> {
			<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">Accept</span>()
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;accept tcp err:&#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">continue</span>
			}
			<span style="color:#75715e">//处理客户端请求
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>) {
				<span style="color:#75715e">//拆包
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDataPack</span>()
				<span style="color:#66d9ef">for</span> {
					<span style="color:#75715e">//1、第一次从conn读取，把header读出来
</span><span style="color:#75715e"></span>					<span style="color:#a6e22e">headData</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">GetHeadLen</span>())
					<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">headData</span>)
					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
						<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read head error&#34;</span>)
						<span style="color:#66d9ef">return</span>
					}

					<span style="color:#a6e22e">msgHead</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">UnPack</span>(<span style="color:#a6e22e">headData</span>)
					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
						<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;unpack head error:&#34;</span>, <span style="color:#a6e22e">err</span>)
						<span style="color:#66d9ef">return</span>
					}
					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">msgHead</span>.<span style="color:#a6e22e">GetMsgLen</span>() &gt; <span style="color:#ae81ff">0</span> {
						<span style="color:#75715e">//2、第二次从conn读取，把内容读出来
</span><span style="color:#75715e"></span>						<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">msgHead</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">Message</span>)
						<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Data</span> = make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgLen</span>())
						<span style="color:#75715e">//根据datalen读取数据
</span><span style="color:#75715e"></span>						<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Data</span>)
						<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
							<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read data error&#34;</span>)
							<span style="color:#66d9ef">return</span>
						}

						<span style="color:#75715e">//一个完整的消息已经读完了
</span><span style="color:#75715e"></span>						<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Recv MsgId:&#34;</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Id</span>, <span style="color:#e6db74">&#34; MsgLen:&#34;</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">DataLen</span>, <span style="color:#e6db74">&#34; MsgData:&#34;</span>, string(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Data</span>))
					}

				}
			}(<span style="color:#a6e22e">conn</span>)
		}
	}()

	<span style="color:#75715e">/**
</span><span style="color:#75715e">	 * 创建一个客户端端
</span><span style="color:#75715e">	 */</span>
	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;127.0.0.1:7777&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;net dial err:&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDataPack</span>()
	<span style="color:#75715e">//创建一个msg1
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">msg1</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Message</span>{
		<span style="color:#a6e22e">Id</span>:      <span style="color:#ae81ff">1</span>,
		<span style="color:#a6e22e">DataLen</span>: <span style="color:#ae81ff">4</span>,
		<span style="color:#a6e22e">Data</span>:    []<span style="color:#66d9ef">byte</span>{<span style="color:#e6db74">&#39;z&#39;</span>, <span style="color:#e6db74">&#39;i&#39;</span>, <span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;x&#39;</span>},
	}
	<span style="color:#a6e22e">sendData1</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">Pack</span>(<span style="color:#a6e22e">msg1</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client send pack1 err:&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//创建一个msg2
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">msg2</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Message</span>{
		<span style="color:#a6e22e">Id</span>:      <span style="color:#ae81ff">2</span>,
		<span style="color:#a6e22e">DataLen</span>: <span style="color:#ae81ff">5</span>,
		<span style="color:#a6e22e">Data</span>:    []<span style="color:#66d9ef">byte</span>{<span style="color:#e6db74">&#39;h&#39;</span>, <span style="color:#e6db74">&#39;e&#39;</span>, <span style="color:#e6db74">&#39;l&#39;</span>, <span style="color:#e6db74">&#39;l&#39;</span>, <span style="color:#e6db74">&#39;o&#39;</span>},
	}
	<span style="color:#a6e22e">sendData2</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">Pack</span>(<span style="color:#a6e22e">msg2</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client send pack1 err:&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">sendData1</span> = append(<span style="color:#a6e22e">sendData1</span>, <span style="color:#a6e22e">sendData2</span><span style="color:#f92672">...</span>)
	<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">sendData1</span>)

	<span style="color:#75715e">//阻塞
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">select</span> {}
}
</code></pre></div><p>集成拆包封包功能到zinx中</p>
<blockquote>
<p>zinx/znet/request.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;zinx/ziface&#34;</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Request</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//已经和客户端建立好的链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>
	<span style="color:#75715e">//客户端请求的数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">msg</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IMessage</span>
}

<span style="color:#75715e">//实现接口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Request</span>) <span style="color:#a6e22e">GetConnection</span>() <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">conn</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Request</span>) <span style="color:#a6e22e">GetData</span>() []<span style="color:#66d9ef">byte</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetData</span>()
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Request</span>) <span style="color:#a6e22e">GetMsgId</span>() <span style="color:#66d9ef">uint32</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgId</span>()
}
</code></pre></div><blockquote>
<p>zinx/ziface/iconnection.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">ziface</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;net&#34;</span>

<span style="color:#75715e">//定义链接模块的抽象层
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IConnection</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">//启动链接 让当前的链接准备开始工作
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Start</span>()
	<span style="color:#75715e">//停止链接 结束当前链接的工作
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Stop</span>()
	<span style="color:#75715e">//获取当前链接绑定socket conn
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetTCPConnection</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>
	<span style="color:#75715e">//获取当前链接模块的链接ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetConnId</span>() <span style="color:#66d9ef">uint32</span>
	<span style="color:#75715e">//获取远程客户端的TCP状态IP PORT
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">RemoteAddr</span>() <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Addr</span>
	<span style="color:#75715e">//发送数据，将数据发送给远程的客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SendMsg</span>(<span style="color:#a6e22e">msgid</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#66d9ef">error</span>
}

<span style="color:#75715e">//定义一个处理业务的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HandleFunc</span> <span style="color:#66d9ef">func</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>, []<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">error</span>
</code></pre></div><blockquote>
<p>zinx/znet/connection.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;errors&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;io&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">//链接模块
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Connection</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//当前链接的Socket TCP套接字
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>
	<span style="color:#75715e">//链接ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ConnId</span> <span style="color:#66d9ef">uint32</span>
	<span style="color:#75715e">//当前的链接状态
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">isClosed</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">//告知当前链接已经退出/停止 channle
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ExitChan</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">//该链接处理的方法Router
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Router</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>
}

<span style="color:#75715e">//初始化链接模块的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewConnection</span>(<span style="color:#a6e22e">conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>, <span style="color:#a6e22e">connId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">router</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span> {
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Connection</span>{
		<span style="color:#a6e22e">Conn</span>:     <span style="color:#a6e22e">conn</span>,
		<span style="color:#a6e22e">ConnId</span>:   <span style="color:#a6e22e">connId</span>,
		<span style="color:#a6e22e">Router</span>:   <span style="color:#a6e22e">router</span>,
		<span style="color:#a6e22e">isClosed</span>: <span style="color:#66d9ef">false</span>,
		<span style="color:#a6e22e">ExitChan</span>: make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>, <span style="color:#ae81ff">1</span>),
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>
}

<span style="color:#75715e">//读数据的业务
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">StartReader</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Reader Goroutine is running...&#34;</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;connId = &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>, <span style="color:#e6db74">&#34; Reader is exit, remote addr is &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">RemoteAddr</span>().<span style="color:#a6e22e">String</span>())
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Stop</span>()
	<span style="color:#66d9ef">for</span> {
		<span style="color:#75715e">//读取客户端的数据到buf中，最大512字节
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//buf := make([]byte, utils.GlobalObject.MaxPackageSize)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//_, err := c.Conn.Read(buf)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//if err != nil {
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	fmt.Println(&#34;recv buf err:&#34;, err)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	continue
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//}
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//创建一个拆包解包对象
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDataPack</span>()
		<span style="color:#75715e">//读取客户端的Msg Head 二进制流 8个字节
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">headData</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">GetHeadLen</span>())
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">GetTCPConnection</span>(), <span style="color:#a6e22e">headData</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read msg head error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//拆包，得到MsgId和msgDataLen 放在msg消息中
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">UnPack</span>(<span style="color:#a6e22e">headData</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;unpack error&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//根据DataLen，再次读取Data,放在msg.Data中
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgLen</span>() &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">data</span> = make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgLen</span>())
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">GetTCPConnection</span>(), <span style="color:#a6e22e">data</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read msg data error&#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">break</span>
			}
		}
		<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">SetData</span>(<span style="color:#a6e22e">data</span>)

		<span style="color:#75715e">//得到当前conn数据的Request请求数据
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Request</span>{
			<span style="color:#a6e22e">conn</span>: <span style="color:#a6e22e">c</span>,
			<span style="color:#a6e22e">msg</span>:  <span style="color:#a6e22e">msg</span>,
		}
		<span style="color:#75715e">//从路由中，找到注册绑定的Conn对应的Router调用
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>) {
			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Router</span>.<span style="color:#a6e22e">PreHandle</span>(<span style="color:#a6e22e">request</span>)
			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Router</span>.<span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">request</span>)
			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Router</span>.<span style="color:#a6e22e">PostHandle</span>(<span style="color:#a6e22e">request</span>)
		}(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">req</span>)

	}

}

<span style="color:#75715e">//实现接口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Conn Start().. ConnId=&#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>)

	<span style="color:#75715e">//启动从当前链接的读数据的业务
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">StartReader</span>()

	<span style="color:#75715e">//TODO 启动从当前链接写数据的业务
</span><span style="color:#75715e"></span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Stop</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Conn Stop() .. ConnId = &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>)

	<span style="color:#75715e">//如果当前链接已经关闭
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> = <span style="color:#66d9ef">true</span>
	<span style="color:#75715e">//关闭socket链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#75715e">//回收资源
</span><span style="color:#75715e"></span>	close(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ExitChan</span>)
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">GetTCPConnection</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">GetConnId</span>() <span style="color:#66d9ef">uint32</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">RemoteAddr</span>() <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Addr</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">RemoteAddr</span>()
}

<span style="color:#75715e">// 先将要发送给客户端的数据先进行封包，再发送
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">SendMsg</span>(<span style="color:#a6e22e">msgId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Connection closed when send msg&#34;</span>)
	}
	<span style="color:#75715e">//将data进行封包，格式：msgDatalen|msgId|msgData
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDataPack</span>()

	<span style="color:#a6e22e">binaryMsg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">Pack</span>(<span style="color:#a6e22e">NewMsgPackage</span>(<span style="color:#a6e22e">msgId</span>, <span style="color:#a6e22e">data</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;pack error msg id =&#34;</span>, <span style="color:#a6e22e">msgId</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Pack error msg&#34;</span>)
	}
	<span style="color:#75715e">//将数据发送给客户端
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">binaryMsg</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Write msg id&#34;</span>, <span style="color:#a6e22e">msgId</span>, <span style="color:#e6db74">&#34; error&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;conn Write error&#34;</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>使用Demo进行测试</p>
<blockquote>
<p>myDemo/zinxv0.5/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e">基于Zinx框架开发的 服务端应用程序
</span><span style="color:#75715e">*/</span>

<span style="color:#75715e">//ping test自定义路由
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PingRouter</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">BaseRouter</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">pr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PingRouter</span>) <span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Call Router Handle...&#34;</span>)
	<span style="color:#75715e">//先读取客户端的数据，在回写ping...ping...ping
</span><span style="color:#75715e"></span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Recv from client:msgId =&#34;</span>, <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetMsgId</span>(), <span style="color:#e6db74">&#34; data = &#34;</span>, string(<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetData</span>()))
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetConnection</span>().<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">1</span>, []byte(<span style="color:#e6db74">&#34;ping...ping...ping&#34;</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//1、创建一个server句柄，使用Zinx的api
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#e6db74">&#34;[zinx V0.5]&#34;</span>)
	<span style="color:#75715e">//2、给当前zinx框架添加一个自定义的router
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">AddRouter</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">PingRouter</span>{})
	<span style="color:#75715e">//3、启动server
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Serve</span>()
}
</code></pre></div><blockquote>
<p>myDemo/zinxv0.5/Client.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;io&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e">模拟客户端
</span><span style="color:#75715e">*/</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client start&#34;</span>)
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#75715e">//1、直接链接远程服务器，得到一个conn链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;127.0.0.1:7777&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client start err :&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//2、链接调用Write 写数据
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> {
		<span style="color:#75715e">//发送封包的Message消息
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewDataPack</span>()
		<span style="color:#a6e22e">binaryMsg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">Pack</span>(<span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewMsgPackage</span>(<span style="color:#ae81ff">0</span>, []byte(<span style="color:#e6db74">&#34;ZinxV0.5 Client Test Message&#34;</span>)))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Pack error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">binaryMsg</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;write error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}

		<span style="color:#75715e">//服务器应该给我们回复一个message，MsgId:1 pingpingping
</span><span style="color:#75715e"></span>
		<span style="color:#75715e">//先读取流中的head部分 得到ID和 dataLen
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">binaryHead</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">GetHeadLen</span>())
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">binaryHead</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read head error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//将二进制的head拆包到msg结构体中
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">msgHead</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">UnPack</span>(<span style="color:#a6e22e">binaryHead</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client unpack msgHead error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//再根据DataLen进行第二次读取，将data
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">msgHead</span>.<span style="color:#a6e22e">GetMsgLen</span>() &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">msgHead</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">Message</span>)
			<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Data</span> = make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgLen</span>())
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Data</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read msg data error:&#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">return</span>
			}
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Recv Server Msg:Id=&#34;</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Id</span>, <span style="color:#e6db74">&#34; len=&#34;</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">DataLen</span>, <span style="color:#e6db74">&#34; data = &#34;</span>, string(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Data</span>))
		}

		<span style="color:#75715e">//cpu阻塞
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	}
}
</code></pre></div><h2 id="zinxv06-多路由模式">ZinxV0.6-多路由模式</h2>
<p>原先的Zinx只能绑定一个路由的处理业务方法，需要修改成可以添加多路由的方式。</p>
<blockquote>
<p>zinx/ziface/imsgHandler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">ziface</span>

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 消息管理抽象层
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IMsgHandle</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">//调度 / 执行对应的Router消息处理方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">DoMsgHandler</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">IRequest</span>)
	<span style="color:#75715e">//为消息添加具体的处理逻辑
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">AddRouter</span>(<span style="color:#a6e22e">msgId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">router</span> <span style="color:#a6e22e">IRouter</span>)
}
</code></pre></div><blockquote>
<p>zinx/znet/msgHandler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;strconv&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 消息处理模块的实现
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MsgHandle</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//存放每个MsgId所对应的处理方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Apis</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">uint32</span>]<span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>
}

<span style="color:#75715e">//初始化MsgHandle方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewMsgHandle</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">MsgHandle</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">MsgHandle</span>{
		<span style="color:#a6e22e">Apis</span>: make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">uint32</span>]<span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>),
	}
}

<span style="color:#75715e">//实现接口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">mh</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MsgHandle</span>) <span style="color:#a6e22e">DoMsgHandler</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>) {
	<span style="color:#75715e">//1、从Request中找到MsgId
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">handler</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mh</span>.<span style="color:#a6e22e">Apis</span>[<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetMsgId</span>()]
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;api msgId=&#34;</span>, <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetMsgId</span>(), <span style="color:#e6db74">&#34; is NOT FOUND!Nedd Register!&#34;</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//2、根据msgId调度对应的router
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">PreHandle</span>(<span style="color:#a6e22e">request</span>)
	<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">request</span>)
	<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">PostHandle</span>(<span style="color:#a6e22e">request</span>)
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">mh</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MsgHandle</span>) <span style="color:#a6e22e">AddRouter</span>(<span style="color:#a6e22e">msgId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">router</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>) {
	<span style="color:#75715e">//1、判断msg绑定api是否存在
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mh</span>.<span style="color:#a6e22e">Apis</span>[<span style="color:#a6e22e">msgId</span>]; <span style="color:#a6e22e">ok</span> {
		<span style="color:#75715e">//id已经存在
</span><span style="color:#75715e"></span>		panic(<span style="color:#e6db74">&#34;repeat api,msgId = &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(int(<span style="color:#a6e22e">msgId</span>)))
	}
	<span style="color:#75715e">//2、添加msg与Api的绑定关系
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">mh</span>.<span style="color:#a6e22e">Apis</span>[<span style="color:#a6e22e">msgId</span>] = <span style="color:#a6e22e">router</span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Add api MsgId =&#34;</span>, <span style="color:#a6e22e">msgId</span>, <span style="color:#e6db74">&#34; Succ!&#34;</span>)
}
</code></pre></div><blockquote>
<p>zinx/ziface/iserver.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">ziface</span>

<span style="color:#75715e">//定义一个服务器接口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IServer</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">//启动服务器
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Start</span>()
	<span style="color:#75715e">//停止服务器
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Stop</span>()
	<span style="color:#75715e">//运行服务器
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Serve</span>()
	<span style="color:#75715e">//路由功能：给当前的服务注册一个路由方法，供客户端的链接处理使用
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">AddRouter</span>(<span style="color:#a6e22e">msgId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">router</span> <span style="color:#a6e22e">IRouter</span>)
}
</code></pre></div><blockquote>
<p>zinx/znet/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;zinx/utils&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">//Iserver的接口实现，定义一个server的服务模块
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Server</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//服务器名称
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器绑定的ip版本
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IPVersion</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器监听的IP
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IP</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器监听的端口
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Port</span> <span style="color:#66d9ef">int</span>
	<span style="color:#75715e">//当前的Server添加一个router,server注册的链接对应的业务处理
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//Router ziface.IRouter
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//当前server的消息管理模块，用来绑定MsgId和对应的处理业务API关系
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MsgHandle</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IMsgHandle</span>
}

<span style="color:#75715e">//启动服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;[Zinx] Server Name:%s, listenner at Ip:%s , Port:%d is starting\n&#34;</span>,
		<span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Host</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">TcpPort</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;[Zinx] Version %s, MaxConn:%d, MaxPacketSize:%d\n&#34;</span>,
		<span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Version</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">MaxConn</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">MaxPackageSize</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;[Start] Server Listenner at IP:%s, Port %d, is starting\n&#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IP</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Port</span>)

	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#75715e">//1、获取一个TCP的addr
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ResolveTCPAddr</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s:%d&#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IP</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Port</span>))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;resolve tcp addr error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#75715e">//2、监听服务器地址
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">listenner</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ListenTCP</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#a6e22e">addr</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;listen &#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#e6db74">&#34;error :&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;start zinx Server succ &#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#e6db74">&#34; succ, Listenning...&#34;</span>)
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cid</span> <span style="color:#66d9ef">uint32</span>
		<span style="color:#a6e22e">cid</span> = <span style="color:#ae81ff">0</span>
		<span style="color:#75715e">//3、阻塞等待客户端连接，处理客户端连接业务（读写）
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> {
			<span style="color:#75715e">//如果有客户端连接过来，阻塞会返回
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listenner</span>.<span style="color:#a6e22e">AcceptTCP</span>()
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Accept err &#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">continue</span>
			}
			<span style="color:#75715e">//客户端连接已经建立，todosomething
</span><span style="color:#75715e"></span>			<span style="color:#75715e">//将处理新连接的业务方法 和 conn进行绑定 得到我们的链接模块
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">dealConn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewConnection</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">cid</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">MsgHandle</span>)
			<span style="color:#a6e22e">cid</span><span style="color:#f92672">++</span>

			<span style="color:#75715e">//启动当前的链接业务
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">dealConn</span>.<span style="color:#a6e22e">Start</span>()
		}
	}()

}

<span style="color:#75715e">//停止服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Stop</span>() {
	<span style="color:#75715e">// TODO 将一些服务器的资源，状态或者一些已经开辟的链接信息，进行停止 或者回收
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">//运行服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Serve</span>() {
	<span style="color:#75715e">//启动server的服务功能
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Start</span>()

	<span style="color:#75715e">//TODO 做一些启动服务器之后的额外业务
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">//阻塞状态
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">select</span> {}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">AddRouter</span>(<span style="color:#a6e22e">msgId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">router</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>) {
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">MsgHandle</span>.<span style="color:#a6e22e">AddRouter</span>(<span style="color:#a6e22e">msgId</span>, <span style="color:#a6e22e">router</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Add Router Succ!!&#34;</span>)
}

<span style="color:#75715e">/**
</span><span style="color:#75715e">初始化Server模块的方法
</span><span style="color:#75715e">*/</span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IServer</span> {
	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Server</span>{
		<span style="color:#a6e22e">Name</span>:      <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Name</span>,
		<span style="color:#a6e22e">IPVersion</span>: <span style="color:#e6db74">&#34;tcp4&#34;</span>,
		<span style="color:#a6e22e">IP</span>:        <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Host</span>,
		<span style="color:#a6e22e">Port</span>:      <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">TcpPort</span>,
		<span style="color:#75715e">//Router:    nil,
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">MsgHandle</span>: <span style="color:#a6e22e">NewMsgHandle</span>(),
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>
}
</code></pre></div><blockquote>
<p>zinx/ziface/connection.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;errors&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;io&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">//链接模块
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Connection</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//当前链接的Socket TCP套接字
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>
	<span style="color:#75715e">//链接ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ConnId</span> <span style="color:#66d9ef">uint32</span>
	<span style="color:#75715e">//当前的链接状态
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">isClosed</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">//告知当前链接已经退出/停止 channle
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ExitChan</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">//该链接处理的方法Router
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Router</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>
    <span style="color:#75715e">//消息的管理MsgId和对应的处理业务API关系
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MsgHandle</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IMsgHandle</span>
}

<span style="color:#75715e">//初始化链接模块的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewConnection</span>(<span style="color:#a6e22e">conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>, <span style="color:#a6e22e">connId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">router</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span> {
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Connection</span>{
		<span style="color:#a6e22e">Conn</span>:     <span style="color:#a6e22e">conn</span>,
		<span style="color:#a6e22e">ConnId</span>:   <span style="color:#a6e22e">connId</span>,
		<span style="color:#a6e22e">Router</span>:   <span style="color:#a6e22e">router</span>,
		<span style="color:#a6e22e">isClosed</span>: <span style="color:#66d9ef">false</span>,
		<span style="color:#a6e22e">MsgChan</span>:   make(<span style="color:#66d9ef">chan</span> []<span style="color:#66d9ef">byte</span>),
		<span style="color:#a6e22e">ExitChan</span>: make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>, <span style="color:#ae81ff">1</span>),
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>
}

<span style="color:#75715e">//读数据的业务
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">StartReader</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Reader Goroutine is running...&#34;</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;connId = &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>, <span style="color:#e6db74">&#34; Reader is exit, remote addr is &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">RemoteAddr</span>().<span style="color:#a6e22e">String</span>())
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Stop</span>()
	<span style="color:#66d9ef">for</span> {
		<span style="color:#75715e">//读取客户端的数据到buf中，最大512字节
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//buf := make([]byte, utils.GlobalObject.MaxPackageSize)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//_, err := c.Conn.Read(buf)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//if err != nil {
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	fmt.Println(&#34;recv buf err:&#34;, err)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	continue
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//}
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//创建一个拆包解包对象
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDataPack</span>()
		<span style="color:#75715e">//读取客户端的Msg Head 二进制流 8个字节
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">headData</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">GetHeadLen</span>())
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">GetTCPConnection</span>(), <span style="color:#a6e22e">headData</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read msg head error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//拆包，得到MsgId和msgDataLen 放在msg消息中
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">UnPack</span>(<span style="color:#a6e22e">headData</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;unpack error&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//根据DataLen，再次读取Data,放在msg.Data中
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgLen</span>() &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">data</span> = make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgLen</span>())
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">GetTCPConnection</span>(), <span style="color:#a6e22e">data</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read msg data error&#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">break</span>
			}
		}
		<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">SetData</span>(<span style="color:#a6e22e">data</span>)

		<span style="color:#75715e">//得到当前conn数据的Request请求数据
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Request</span>{
			<span style="color:#a6e22e">conn</span>: <span style="color:#a6e22e">c</span>,
			<span style="color:#a6e22e">msg</span>:  <span style="color:#a6e22e">msg</span>,
		}
		<span style="color:#75715e">//从路由中，找到注册绑定的Conn对应的Router调用
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//go func(request ziface.IRequest) {
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	c.Router.PreHandle(request)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	c.Router.Handle(request)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	c.Router.PostHandle(request)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//}(&amp;req)
</span><span style="color:#75715e"></span>
		<span style="color:#75715e">//从路由中，找到注册绑定的Conn对应的router调用
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MsgHandle</span>.<span style="color:#a6e22e">DoMsgHandler</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">req</span>)

	}

}

<span style="color:#75715e">//实现接口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Conn Start().. ConnId=&#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>)

	<span style="color:#75715e">//启动从当前链接的读数据的业务
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">StartReader</span>()

	<span style="color:#75715e">//TODO 启动从当前链接写数据的业务
</span><span style="color:#75715e"></span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Stop</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Conn Stop() .. ConnId = &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>)

	<span style="color:#75715e">//如果当前链接已经关闭
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> = <span style="color:#66d9ef">true</span>
	<span style="color:#75715e">//关闭socket链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#75715e">//回收资源
</span><span style="color:#75715e"></span>	close(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ExitChan</span>)
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">GetTCPConnection</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">GetConnId</span>() <span style="color:#66d9ef">uint32</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">RemoteAddr</span>() <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Addr</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">RemoteAddr</span>()
}

<span style="color:#75715e">// 先将要发送给客户端的数据先进行封包，再发送
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">SendMsg</span>(<span style="color:#a6e22e">msgId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Connection closed when send msg&#34;</span>)
	}
	<span style="color:#75715e">//将data进行封包，格式：msgDatalen|msgId|msgData
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDataPack</span>()

	<span style="color:#a6e22e">binaryMsg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">Pack</span>(<span style="color:#a6e22e">NewMsgPackage</span>(<span style="color:#a6e22e">msgId</span>, <span style="color:#a6e22e">data</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;pack error msg id =&#34;</span>, <span style="color:#a6e22e">msgId</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Pack error msg&#34;</span>)
	}
	<span style="color:#75715e">//将数据发送给客户端
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">binaryMsg</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Write msg id&#34;</span>, <span style="color:#a6e22e">msgId</span>, <span style="color:#e6db74">&#34; error&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;conn Write error&#34;</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

</code></pre></div><p>使用Demo进行测试</p>
<blockquote>
<p>myDemo/zinxv0.6/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e">基于Zinx框架开发的 服务端应用程序
</span><span style="color:#75715e">*/</span>

<span style="color:#75715e">//ping test自定义路由
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PingRouter</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">BaseRouter</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">pr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PingRouter</span>) <span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Call PingRouter Handle...&#34;</span>)
	<span style="color:#75715e">//先读取客户端的数据，在回写ping...ping...ping
</span><span style="color:#75715e"></span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Recv from client:msgId =&#34;</span>, <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetMsgId</span>(), <span style="color:#e6db74">&#34; data = &#34;</span>, string(<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetData</span>()))
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetConnection</span>().<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">1</span>, []byte(<span style="color:#e6db74">&#34;ping...ping...ping&#34;</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
	}
}

<span style="color:#75715e">//自定义Hello zinx test 路由
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HelloZinxRouter</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">BaseRouter</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">pr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">HelloZinxRouter</span>) <span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Call HelloRouter Handle...&#34;</span>)
	<span style="color:#75715e">//先读取客户端的数据，在回写ping...ping...ping
</span><span style="color:#75715e"></span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Recv from client:msgId =&#34;</span>, <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetMsgId</span>(), <span style="color:#e6db74">&#34; data = &#34;</span>, string(<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetData</span>()))
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetConnection</span>().<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">201</span>, []byte(<span style="color:#e6db74">&#34;Hello welcome to zinx&#34;</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//1、创建一个server句柄，使用Zinx的api
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#e6db74">&#34;[zinx V0.6]&#34;</span>)
	<span style="color:#75715e">//2、给当前zinx框架添加自定义的router
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">AddRouter</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">PingRouter</span>{})
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">AddRouter</span>(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">HelloZinxRouter</span>{})
	<span style="color:#75715e">//3、启动server
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Serve</span>()
}
</code></pre></div><blockquote>
<p>myDemo/zinxv0.6/Client.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;io&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e">模拟客户端
</span><span style="color:#75715e">*/</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client0 start&#34;</span>)
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#75715e">//1、直接链接远程服务器，得到一个conn链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;127.0.0.1:7777&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client start err :&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//2、链接调用Write 写数据
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> {
		<span style="color:#75715e">//发送封包的Message消息
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewDataPack</span>()
		<span style="color:#a6e22e">binaryMsg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">Pack</span>(<span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewMsgPackage</span>(<span style="color:#ae81ff">0</span>, []byte(<span style="color:#e6db74">&#34;Zinx Client0 Test Message&#34;</span>)))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Pack error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">binaryMsg</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;write error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}

		<span style="color:#75715e">//服务器应该给我们回复一个message，MsgId:1 pingpingping
</span><span style="color:#75715e"></span>
		<span style="color:#75715e">//先读取流中的head部分 得到ID和 dataLen
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">binaryHead</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">GetHeadLen</span>())
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">binaryHead</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read head error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//将二进制的head拆包到msg结构体中
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">msgHead</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">UnPack</span>(<span style="color:#a6e22e">binaryHead</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client unpack msgHead error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//再根据DataLen进行第二次读取，将data
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">msgHead</span>.<span style="color:#a6e22e">GetMsgLen</span>() &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">msgHead</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">Message</span>)
			<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Data</span> = make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgLen</span>())
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Data</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read msg data error:&#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">return</span>
			}
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Recv Server Msg:Id=&#34;</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Id</span>, <span style="color:#e6db74">&#34; len=&#34;</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">DataLen</span>, <span style="color:#e6db74">&#34; data = &#34;</span>, string(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Data</span>))
		}

		<span style="color:#75715e">//cpu阻塞
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	}
}
</code></pre></div><blockquote>
<p>myDemo/zinxv0.6/Client1.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;io&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e">模拟客户端
</span><span style="color:#75715e">*/</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client1 start&#34;</span>)
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#75715e">//1、直接链接远程服务器，得到一个conn链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;127.0.0.1:7777&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client start err :&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//2、链接调用Write 写数据
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> {
		<span style="color:#75715e">//发送封包的Message消息
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewDataPack</span>()
		<span style="color:#a6e22e">binaryMsg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">Pack</span>(<span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewMsgPackage</span>(<span style="color:#ae81ff">1</span>, []byte(<span style="color:#e6db74">&#34;Zinx Client1 Test Message&#34;</span>)))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Pack error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">binaryMsg</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;write error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}

		<span style="color:#75715e">//服务器应该给我们回复一个message，MsgId:1 pingpingping
</span><span style="color:#75715e"></span>
		<span style="color:#75715e">//先读取流中的head部分 得到ID和 dataLen
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">binaryHead</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">GetHeadLen</span>())
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">binaryHead</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read head error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//将二进制的head拆包到msg结构体中
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">msgHead</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">UnPack</span>(<span style="color:#a6e22e">binaryHead</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client unpack msgHead error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//再根据DataLen进行第二次读取，将data
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">msgHead</span>.<span style="color:#a6e22e">GetMsgLen</span>() &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">msgHead</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">Message</span>)
			<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Data</span> = make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgLen</span>())
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Data</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read msg data error:&#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">return</span>
			}
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Recv Server Msg:Id=&#34;</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Id</span>, <span style="color:#e6db74">&#34; len=&#34;</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">DataLen</span>, <span style="color:#e6db74">&#34; data = &#34;</span>, string(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Data</span>))
		}

		<span style="color:#75715e">//cpu阻塞
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	}
}
</code></pre></div><h2 id="zinxv07-读写分离">ZinxV0.7-读写分离</h2>
<p>与客户端进行数据交互的goroutine分成一个专门读取、和专门写数据的两个goroutine。</p>
<blockquote>
<p>zinx/znet/connection.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;errors&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;io&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">//链接模块
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Connection</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//当前链接的Socket TCP套接字
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>
	<span style="color:#75715e">//链接ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ConnId</span> <span style="color:#66d9ef">uint32</span>
	<span style="color:#75715e">//当前的链接状态
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">isClosed</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">//告知当前链接已经退出/停止 channle
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ExitChan</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">//无缓存的管道，用于读写goroutine之间的消息通信
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MsgChan</span> <span style="color:#66d9ef">chan</span> []<span style="color:#66d9ef">byte</span>

	<span style="color:#75715e">//该链接处理的方法Router
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//Router ziface.IRouter
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//消息的管理MsgId和对应的处理业务API关系
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MsgHandle</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IMsgHandle</span>
}

<span style="color:#75715e">//初始化链接模块的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewConnection</span>(<span style="color:#a6e22e">conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>, <span style="color:#a6e22e">connId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">msgHandler</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IMsgHandle</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span> {
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Connection</span>{
		<span style="color:#a6e22e">Conn</span>:      <span style="color:#a6e22e">conn</span>,
		<span style="color:#a6e22e">ConnId</span>:    <span style="color:#a6e22e">connId</span>,
		<span style="color:#a6e22e">MsgHandle</span>: <span style="color:#a6e22e">msgHandler</span>,
		<span style="color:#a6e22e">isClosed</span>:  <span style="color:#66d9ef">false</span>,
		<span style="color:#a6e22e">MsgChan</span>:   make(<span style="color:#66d9ef">chan</span> []<span style="color:#66d9ef">byte</span>),
		<span style="color:#a6e22e">ExitChan</span>:  make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>, <span style="color:#ae81ff">1</span>),
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>
}

<span style="color:#75715e">//读数据的业务
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">StartReader</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;[Reader Goroutine is running...]&#34;</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;[Reader is exit],  connId = &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>, <span style="color:#e6db74">&#34;  remote addr is &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">RemoteAddr</span>().<span style="color:#a6e22e">String</span>())
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Stop</span>()
	<span style="color:#66d9ef">for</span> {
		<span style="color:#75715e">//读取客户端的数据到buf中，最大512字节
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//buf := make([]byte, utils.GlobalObject.MaxPackageSize)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//_, err := c.Conn.Read(buf)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//if err != nil {
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	fmt.Println(&#34;recv buf err:&#34;, err)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	continue
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//}
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//创建一个拆包解包对象
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDataPack</span>()
		<span style="color:#75715e">//读取客户端的Msg Head 二进制流 8个字节
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">headData</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">GetHeadLen</span>())
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">GetTCPConnection</span>(), <span style="color:#a6e22e">headData</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read msg head error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//拆包，得到MsgId和msgDataLen 放在msg消息中
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">UnPack</span>(<span style="color:#a6e22e">headData</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;unpack error&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//根据DataLen，再次读取Data,放在msg.Data中
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgLen</span>() &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">data</span> = make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgLen</span>())
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">GetTCPConnection</span>(), <span style="color:#a6e22e">data</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read msg data error&#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">break</span>
			}
		}
		<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">SetData</span>(<span style="color:#a6e22e">data</span>)

		<span style="color:#75715e">//得到当前conn数据的Request请求数据
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Request</span>{
			<span style="color:#a6e22e">conn</span>: <span style="color:#a6e22e">c</span>,
			<span style="color:#a6e22e">msg</span>:  <span style="color:#a6e22e">msg</span>,
		}
		<span style="color:#75715e">//从路由中，找到注册绑定的Conn对应的Router调用
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//go func(request ziface.IRequest) {
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	c.Router.PreHandle(request)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	c.Router.Handle(request)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	c.Router.PostHandle(request)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//}(&amp;req)
</span><span style="color:#75715e"></span>
		<span style="color:#75715e">//从路由中，找到注册绑定的Conn对应的router调用
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MsgHandle</span>.<span style="color:#a6e22e">DoMsgHandler</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">req</span>)

	}

}

<span style="color:#75715e">//写数据的业务
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">StartWriter</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;[Writer Goroutine is running...]&#34;</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34; [conn Writer exit!] &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">RemoteAddr</span>().<span style="color:#a6e22e">String</span>())
	<span style="color:#75715e">//不断阻塞等待channel的消息，进行写给客户端
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">data</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MsgChan</span>:
			<span style="color:#75715e">//有数据要写给客户端
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">data</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Send data error,&#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">return</span>
			}
		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ExitChan</span>:
			<span style="color:#75715e">//代表Reader已经退出，此时Writer也要退出
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">return</span>
		}
	}
}

<span style="color:#75715e">//实现接口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Conn Start().. ConnId=&#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>)

	<span style="color:#75715e">//启动从当前链接的读数据的业务
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">StartReader</span>()

	<span style="color:#75715e">//TODO 启动从当前链接写数据的业务
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">StartWriter</span>()

}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Stop</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Conn Stop() .. ConnId = &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>)

	<span style="color:#75715e">//如果当前链接已经关闭
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> = <span style="color:#66d9ef">true</span>
	<span style="color:#75715e">//关闭socket链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#75715e">//告知Writer关闭
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ExitChan</span> <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">true</span>
	<span style="color:#75715e">//回收资源
</span><span style="color:#75715e"></span>	close(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ExitChan</span>)
	close(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MsgChan</span>)
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">GetTCPConnection</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">GetConnId</span>() <span style="color:#66d9ef">uint32</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">RemoteAddr</span>() <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Addr</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">RemoteAddr</span>()
}

<span style="color:#75715e">// 先将要发送给客户端的数据先进行封包，再发送
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">SendMsg</span>(<span style="color:#a6e22e">msgId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Connection closed when send msg&#34;</span>)
	}
	<span style="color:#75715e">//将data进行封包，格式：msgDatalen|msgId|msgData
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDataPack</span>()

	<span style="color:#a6e22e">binaryMsg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">Pack</span>(<span style="color:#a6e22e">NewMsgPackage</span>(<span style="color:#a6e22e">msgId</span>, <span style="color:#a6e22e">data</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;pack error msg id =&#34;</span>, <span style="color:#a6e22e">msgId</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Pack error msg&#34;</span>)
	}
	<span style="color:#75715e">//将数据发送给客户端
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//if _, err := c.Conn.Write(binaryMsg); err != nil {
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//	fmt.Println(&#34;Write msg id&#34;, msgId, &#34; error&#34;, err)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//	return errors.New(&#34;conn Write error&#34;)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//}
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 发给管道
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MsgChan</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">binaryMsg</span>

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>测试和Zinxv0.6一样</p>
<h2 id="zinxv08-消息队列及多任务机制">ZinxV0.8-消息队列及多任务机制</h2>
<p>给Zinx添加消息队列和多任务Worker机制，可以节省goroutine不必要的切换成本</p>
<blockquote>
<p>zinx/ziface/imsgHandler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">ziface</span>

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 消息管理抽象层
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IMsgHandle</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">//调度 / 执行对应的Router消息处理方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">DoMsgHandler</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">IRequest</span>)
	<span style="color:#75715e">//为消息添加具体的处理逻辑
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">AddRouter</span>(<span style="color:#a6e22e">msgId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">router</span> <span style="color:#a6e22e">IRouter</span>)
	<span style="color:#75715e">//启动Worker工作池
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">StartWorkerPool</span>()
	<span style="color:#75715e">//将消息发送给消息任务队列处理
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SendMsgToTaskQueue</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">IRequest</span>)
}
</code></pre></div><blockquote>
<p>zinx/utils/globalobj.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">utils</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;bufio&#34;</span>
	<span style="color:#e6db74">&#34;encoding/json&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 存储一切有关Zinx框架的全局参数，供其他模块使用
</span><span style="color:#75715e"> * 一些参数是可以通过zinx.json由用户进行配置
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">GlobalObj</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//server
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">TcpServer</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IServer</span> <span style="color:#75715e">//当前Zinx全局的Server对象
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Host</span>      <span style="color:#66d9ef">string</span>         <span style="color:#75715e">//当前服务器主机监听的IP
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">TcpPort</span>   <span style="color:#66d9ef">int</span>            <span style="color:#75715e">//当前服务器主机监听的端口
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Name</span>      <span style="color:#66d9ef">string</span>         <span style="color:#75715e">//当前服务器的名称
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">//Zinx
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Version</span>          <span style="color:#66d9ef">string</span> <span style="color:#75715e">//当前Zinx的版本号
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MaxConn</span>          <span style="color:#66d9ef">int</span>    <span style="color:#75715e">//当前服务器主机允许的最大连接数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MaxPackageSize</span>   <span style="color:#66d9ef">uint32</span> <span style="color:#75715e">//当前Zinx框架数据包的最大值
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">WorkerPoolSize</span>   <span style="color:#66d9ef">uint32</span> <span style="color:#75715e">//当前业务工作Worker池的Goroutine数量
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MaxWorkerTaskLen</span> <span style="color:#66d9ef">uint32</span> <span style="color:#75715e">//Zinx框架允许用户最多开辟多少个worker（限定条件）
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">//定义一个全局的对外的GlobalObj
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">GlobalObject</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">GlobalObj</span>

<span style="color:#75715e">// 从zinx.json去加载用于自定义的参数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">g</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">GlobalObj</span>) <span style="color:#a6e22e">Reload</span>() {
	<span style="color:#75715e">/*
</span><span style="color:#75715e">		data, err := ioutil.ReadFile(&#34;./conf/zinx.json&#34;)
</span><span style="color:#75715e">		if err != nil {
</span><span style="color:#75715e">			fmt.Println(&#34;read zinx.json err &#34;, err)
</span><span style="color:#75715e">			return
</span><span style="color:#75715e">		}
</span><span style="color:#75715e">		err = json.Unmarshal(data, &amp;GlobalObject)
</span><span style="color:#75715e">		if err != nil {
</span><span style="color:#75715e">			panic(err)
</span><span style="color:#75715e">		}
</span><span style="color:#75715e">	*/</span>
	<span style="color:#75715e">//file, err := os.Open(&#34;C:\\MySoft\\gocode\\src\\myDemo\\ZinxV0.4\\conf\\zinx.json&#34;)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pwd</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getwd</span>()
	<span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#a6e22e">pwd</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/conf/zinx.json&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Close</span>()

	<span style="color:#a6e22e">reader</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">file</span>)
	<span style="color:#a6e22e">decoder</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">NewDecoder</span>(<span style="color:#a6e22e">reader</span>)
	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">decoder</span>.<span style="color:#a6e22e">Decode</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">GlobalObject</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		panic(<span style="color:#a6e22e">err</span>)
	}
}

<span style="color:#75715e">//提供一个Init方法，初始化当前的GlobalObject
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>() {
	<span style="color:#a6e22e">GlobalObject</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">GlobalObj</span>{
		<span style="color:#a6e22e">Name</span>:             <span style="color:#e6db74">&#34;ZinxServerApp&#34;</span>,
		<span style="color:#a6e22e">Version</span>:          <span style="color:#e6db74">&#34;V0.8&#34;</span>,
		<span style="color:#a6e22e">TcpPort</span>:          <span style="color:#ae81ff">8999</span>,
		<span style="color:#a6e22e">Host</span>:             <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
		<span style="color:#a6e22e">MaxConn</span>:          <span style="color:#ae81ff">1000</span>,
		<span style="color:#a6e22e">MaxPackageSize</span>:   <span style="color:#ae81ff">4096</span>,
		<span style="color:#a6e22e">WorkerPoolSize</span>:   <span style="color:#ae81ff">10</span>,
		<span style="color:#a6e22e">MaxWorkerTaskLen</span>: <span style="color:#ae81ff">1024</span>,
	}
	<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Reload</span>()
}
</code></pre></div><blockquote>
<p>zinx/znet/msgHandler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;strconv&#34;</span>
	<span style="color:#e6db74">&#34;zinx/utils&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 消息处理模块的实现
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MsgHandle</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//存放每个MsgId所对应的处理方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Apis</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">uint32</span>]<span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>
	<span style="color:#75715e">//负责Worker取任务的消息队列
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">TaskQueue</span> []<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>
	<span style="color:#75715e">//worker工作池的数量
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">WorkerPoolSize</span> <span style="color:#66d9ef">uint32</span>
}

<span style="color:#75715e">//初始化MsgHandle方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewMsgHandle</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">MsgHandle</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">MsgHandle</span>{
		<span style="color:#a6e22e">Apis</span>:           make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">uint32</span>]<span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>),
		<span style="color:#a6e22e">WorkerPoolSize</span>: <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">WorkerPoolSize</span>, <span style="color:#75715e">//从全局配置中获取
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">TaskQueue</span>:      make([]<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">WorkerPoolSize</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">MaxWorkerTaskLen</span>),
	}
}

<span style="color:#75715e">//实现接口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">mh</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MsgHandle</span>) <span style="color:#a6e22e">DoMsgHandler</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>) {
	<span style="color:#75715e">//1、从Request中找到MsgId
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">handler</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mh</span>.<span style="color:#a6e22e">Apis</span>[<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetMsgId</span>()]
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;api msgId=&#34;</span>, <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetMsgId</span>(), <span style="color:#e6db74">&#34; is NOT FOUND!Nedd Register!&#34;</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//2、根据msgId调度对应的router
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">PreHandle</span>(<span style="color:#a6e22e">request</span>)
	<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">request</span>)
	<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">PostHandle</span>(<span style="color:#a6e22e">request</span>)
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">mh</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MsgHandle</span>) <span style="color:#a6e22e">AddRouter</span>(<span style="color:#a6e22e">msgId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">router</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>) {
	<span style="color:#75715e">//1、判断msg绑定api是否存在
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mh</span>.<span style="color:#a6e22e">Apis</span>[<span style="color:#a6e22e">msgId</span>]; <span style="color:#a6e22e">ok</span> {
		<span style="color:#75715e">//id已经存在
</span><span style="color:#75715e"></span>		panic(<span style="color:#e6db74">&#34;repeat api,msgId = &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(int(<span style="color:#a6e22e">msgId</span>)))
	}
	<span style="color:#75715e">//2、添加msg与Api的绑定关系
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">mh</span>.<span style="color:#a6e22e">Apis</span>[<span style="color:#a6e22e">msgId</span>] = <span style="color:#a6e22e">router</span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Add api MsgId =&#34;</span>, <span style="color:#a6e22e">msgId</span>, <span style="color:#e6db74">&#34; Succ!&#34;</span>)
}

<span style="color:#75715e">//启动一个Worker工作池 (开启工作池的动作只能发生一次，一个Zinx框架只能有一个worker工作池)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">mh</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MsgHandle</span>) <span style="color:#a6e22e">StartWorkerPool</span>() {
	<span style="color:#75715e">//根据poolSize 分别开启Worker，每个WOrker用一个go来承载
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; int(<span style="color:#a6e22e">mh</span>.<span style="color:#a6e22e">WorkerPoolSize</span>); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#75715e">//一个Worker被启动
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//1、给当前的worker对应的channel消息队列开辟空间
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">mh</span>.<span style="color:#a6e22e">TaskQueue</span>[<span style="color:#a6e22e">i</span>] = make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">MaxWorkerTaskLen</span>)
		<span style="color:#75715e">//2、启动当前的worker,阻塞等待消息从channel传递进来
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">mh</span>.<span style="color:#a6e22e">StartOneWorker</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">mh</span>.<span style="color:#a6e22e">TaskQueue</span>[<span style="color:#a6e22e">i</span>])
	}
}

<span style="color:#75715e">//启动一个Worker工作流程
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">mh</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MsgHandle</span>) <span style="color:#a6e22e">StartOneWorker</span>(<span style="color:#a6e22e">workerId</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">taskQueue</span> <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Worker ID=&#34;</span>, <span style="color:#a6e22e">workerId</span>, <span style="color:#e6db74">&#34; is started...&#34;</span>)

	<span style="color:#75715e">//不断的阻塞等待对应消息队列的消息
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
		<span style="color:#75715e">//如果有消息过来，出列的就是一个客户端的Request,执行当前Request所绑定的业务
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">request</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">taskQueue</span>:
			<span style="color:#a6e22e">mh</span>.<span style="color:#a6e22e">DoMsgHandler</span>(<span style="color:#a6e22e">request</span>)
		}
	}
}

<span style="color:#75715e">//将消息交给TaskQueue，由worker进行处理
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">mh</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MsgHandle</span>) <span style="color:#a6e22e">SendMsgToTaskQueue</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>) {
	<span style="color:#75715e">//1、将消息平均分配给不同的worker
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//根据客户端建立的ConnId来进行分配
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">workerID</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetConnection</span>().<span style="color:#a6e22e">GetConnId</span>() <span style="color:#f92672">%</span> <span style="color:#a6e22e">mh</span>.<span style="color:#a6e22e">WorkerPoolSize</span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Add ConnID = &#34;</span>, <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetConnection</span>().<span style="color:#a6e22e">GetConnId</span>(),
		<span style="color:#e6db74">&#34; reqeust MsgId = &#34;</span>, <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetMsgId</span>(), <span style="color:#e6db74">&#34;to WorkID=&#34;</span>, <span style="color:#a6e22e">workerID</span>)

	<span style="color:#75715e">//2、将消息发送给对应的Worker的TaskQueue即可
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">mh</span>.<span style="color:#a6e22e">TaskQueue</span>[<span style="color:#a6e22e">workerID</span>] <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">request</span>
}
</code></pre></div><blockquote>
<p>zinx/znet/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;zinx/utils&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">//Iserver的接口实现，定义一个server的服务模块
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Server</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//服务器名称
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器绑定的ip版本
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IPVersion</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器监听的IP
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IP</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器监听的端口
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Port</span> <span style="color:#66d9ef">int</span>
	<span style="color:#75715e">//当前的Server添加一个router,server注册的链接对应的业务处理
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//Router ziface.IRouter
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//当前server的消息管理模块，用来绑定MsgId和对应的处理业务API关系
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MsgHandle</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IMsgHandle</span>
}

<span style="color:#75715e">//启动服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;[Zinx] Server Name:%s, listenner at Ip:%s , Port:%d is starting\n&#34;</span>,
		<span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Host</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">TcpPort</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;[Zinx] Version %s, MaxConn:%d, MaxPacketSize:%d\n&#34;</span>,
		<span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Version</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">MaxConn</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">MaxPackageSize</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;[Start] Server Listenner at IP:%s, Port %d, is starting\n&#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IP</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Port</span>)

	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#75715e">//0、开启消息队列及Worker工作池
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">MsgHandle</span>.<span style="color:#a6e22e">StartWorkerPool</span>()

		<span style="color:#75715e">//1、获取一个TCP的addr
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ResolveTCPAddr</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s:%d&#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IP</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Port</span>))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;resolve tcp addr error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#75715e">//2、监听服务器地址
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">listenner</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ListenTCP</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#a6e22e">addr</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;listen &#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#e6db74">&#34;error :&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;start zinx Server succ &#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#e6db74">&#34; succ, Listenning...&#34;</span>)
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cid</span> <span style="color:#66d9ef">uint32</span>
		<span style="color:#a6e22e">cid</span> = <span style="color:#ae81ff">0</span>
		<span style="color:#75715e">//3、阻塞等待客户端连接，处理客户端连接业务（读写）
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> {
			<span style="color:#75715e">//如果有客户端连接过来，阻塞会返回
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listenner</span>.<span style="color:#a6e22e">AcceptTCP</span>()
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Accept err &#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">continue</span>
			}
			<span style="color:#75715e">//客户端连接已经建立，todosomething
</span><span style="color:#75715e"></span>			<span style="color:#75715e">//将处理新连接的业务方法 和 conn进行绑定 得到我们的链接模块
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">dealConn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewConnection</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">cid</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">MsgHandle</span>)
			<span style="color:#a6e22e">cid</span><span style="color:#f92672">++</span>

			<span style="color:#75715e">//启动当前的链接业务
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">dealConn</span>.<span style="color:#a6e22e">Start</span>()
		}
	}()

}

<span style="color:#75715e">//停止服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Stop</span>() {
	<span style="color:#75715e">// TODO 将一些服务器的资源，状态或者一些已经开辟的链接信息，进行停止 或者回收
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">//运行服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Serve</span>() {
	<span style="color:#75715e">//启动server的服务功能
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Start</span>()

	<span style="color:#75715e">//TODO 做一些启动服务器之后的额外业务
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">//阻塞状态
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">select</span> {}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">AddRouter</span>(<span style="color:#a6e22e">msgId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">router</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>) {
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">MsgHandle</span>.<span style="color:#a6e22e">AddRouter</span>(<span style="color:#a6e22e">msgId</span>, <span style="color:#a6e22e">router</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Add Router Succ!!&#34;</span>)
}

<span style="color:#75715e">/**
</span><span style="color:#75715e">初始化Server模块的方法
</span><span style="color:#75715e">*/</span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IServer</span> {
	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Server</span>{
		<span style="color:#a6e22e">Name</span>:      <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Name</span>,
		<span style="color:#a6e22e">IPVersion</span>: <span style="color:#e6db74">&#34;tcp4&#34;</span>,
		<span style="color:#a6e22e">IP</span>:        <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Host</span>,
		<span style="color:#a6e22e">Port</span>:      <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">TcpPort</span>,
		<span style="color:#75715e">//Router:    nil,
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">MsgHandle</span>: <span style="color:#a6e22e">NewMsgHandle</span>(),
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>
}
</code></pre></div><blockquote>
<p>zinx/znet/connection.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;errors&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;io&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;zinx/utils&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">//链接模块
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Connection</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//当前链接的Socket TCP套接字
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>
	<span style="color:#75715e">//链接ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ConnId</span> <span style="color:#66d9ef">uint32</span>
	<span style="color:#75715e">//当前的链接状态
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">isClosed</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">//告知当前链接已经退出/停止 channle
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ExitChan</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">//无缓存的管道，用于读写goroutine之间的消息通信
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MsgChan</span> <span style="color:#66d9ef">chan</span> []<span style="color:#66d9ef">byte</span>

	<span style="color:#75715e">//该链接处理的方法Router
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//Router ziface.IRouter
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//消息的管理MsgId和对应的处理业务API关系
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MsgHandle</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IMsgHandle</span>
}

<span style="color:#75715e">//初始化链接模块的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewConnection</span>(<span style="color:#a6e22e">conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>, <span style="color:#a6e22e">connId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">msgHandler</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IMsgHandle</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span> {
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Connection</span>{
		<span style="color:#a6e22e">Conn</span>:      <span style="color:#a6e22e">conn</span>,
		<span style="color:#a6e22e">ConnId</span>:    <span style="color:#a6e22e">connId</span>,
		<span style="color:#a6e22e">MsgHandle</span>: <span style="color:#a6e22e">msgHandler</span>,
		<span style="color:#a6e22e">isClosed</span>:  <span style="color:#66d9ef">false</span>,
		<span style="color:#a6e22e">MsgChan</span>:   make(<span style="color:#66d9ef">chan</span> []<span style="color:#66d9ef">byte</span>),
		<span style="color:#a6e22e">ExitChan</span>:  make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>, <span style="color:#ae81ff">1</span>),
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>
}

<span style="color:#75715e">//读数据的业务
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">StartReader</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;[Reader Goroutine is running...]&#34;</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;[Reader is exit],  connId = &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>, <span style="color:#e6db74">&#34;  remote addr is &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">RemoteAddr</span>().<span style="color:#a6e22e">String</span>())
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Stop</span>()
	<span style="color:#66d9ef">for</span> {
		<span style="color:#75715e">//读取客户端的数据到buf中，最大512字节
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//buf := make([]byte, utils.GlobalObject.MaxPackageSize)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//_, err := c.Conn.Read(buf)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//if err != nil {
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	fmt.Println(&#34;recv buf err:&#34;, err)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	continue
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//}
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//创建一个拆包解包对象
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDataPack</span>()
		<span style="color:#75715e">//读取客户端的Msg Head 二进制流 8个字节
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">headData</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">GetHeadLen</span>())
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">GetTCPConnection</span>(), <span style="color:#a6e22e">headData</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read msg head error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//拆包，得到MsgId和msgDataLen 放在msg消息中
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">UnPack</span>(<span style="color:#a6e22e">headData</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;unpack error&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//根据DataLen，再次读取Data,放在msg.Data中
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgLen</span>() &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">data</span> = make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgLen</span>())
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">GetTCPConnection</span>(), <span style="color:#a6e22e">data</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read msg data error&#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">break</span>
			}
		}
		<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">SetData</span>(<span style="color:#a6e22e">data</span>)

		<span style="color:#75715e">//得到当前conn数据的Request请求数据
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Request</span>{
			<span style="color:#a6e22e">conn</span>: <span style="color:#a6e22e">c</span>,
			<span style="color:#a6e22e">msg</span>:  <span style="color:#a6e22e">msg</span>,
		}
		<span style="color:#75715e">//从路由中，找到注册绑定的Conn对应的Router调用
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//go func(request ziface.IRequest) {
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	c.Router.PreHandle(request)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	c.Router.Handle(request)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	c.Router.PostHandle(request)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//}(&amp;req)
</span><span style="color:#75715e"></span>
		<span style="color:#75715e">//从路由中，找到注册绑定的Conn对应的router调用
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//go c.MsgHandle.DoMsgHandler(&amp;req)
</span><span style="color:#75715e"></span>
		<span style="color:#75715e">//判断是否开启了工作池
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">WorkerPoolSize</span> &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#75715e">//已经开启了工作池，将消息发送给工作池处理
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MsgHandle</span>.<span style="color:#a6e22e">SendMsgToTaskQueue</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">req</span>)
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#75715e">//还是使用旧的方法，直接发给对应的go处理
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MsgHandle</span>.<span style="color:#a6e22e">DoMsgHandler</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">req</span>)
		}

	}

}

<span style="color:#75715e">//写数据的业务
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">StartWriter</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;[Writer Goroutine is running...]&#34;</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34; [conn Writer exit!] &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">RemoteAddr</span>().<span style="color:#a6e22e">String</span>())
	<span style="color:#75715e">//不断阻塞等待channel的消息，进行写给客户端
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">data</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MsgChan</span>:
			<span style="color:#75715e">//有数据要写给客户端
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">data</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Send data error,&#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">return</span>
			}
		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ExitChan</span>:
			<span style="color:#75715e">//代表Reader已经退出，此时Writer也要退出
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">return</span>
		}
	}
}

<span style="color:#75715e">//实现接口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Conn Start().. ConnId=&#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>)

	<span style="color:#75715e">//启动从当前链接的读数据的业务
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">StartReader</span>()

	<span style="color:#75715e">//TODO 启动从当前链接写数据的业务
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">StartWriter</span>()

}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Stop</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Conn Stop() .. ConnId = &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>)

	<span style="color:#75715e">//如果当前链接已经关闭
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> = <span style="color:#66d9ef">true</span>
	<span style="color:#75715e">//关闭socket链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#75715e">//告知Writer关闭
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ExitChan</span> <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">true</span>
	<span style="color:#75715e">//回收资源
</span><span style="color:#75715e"></span>	close(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ExitChan</span>)
	close(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MsgChan</span>)
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">GetTCPConnection</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">GetConnId</span>() <span style="color:#66d9ef">uint32</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">RemoteAddr</span>() <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Addr</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">RemoteAddr</span>()
}

<span style="color:#75715e">// 先将要发送给客户端的数据先进行封包，再发送
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">SendMsg</span>(<span style="color:#a6e22e">msgId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Connection closed when send msg&#34;</span>)
	}
	<span style="color:#75715e">//将data进行封包，格式：msgDatalen|msgId|msgData
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDataPack</span>()

	<span style="color:#a6e22e">binaryMsg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">Pack</span>(<span style="color:#a6e22e">NewMsgPackage</span>(<span style="color:#a6e22e">msgId</span>, <span style="color:#a6e22e">data</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;pack error msg id =&#34;</span>, <span style="color:#a6e22e">msgId</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Pack error msg&#34;</span>)
	}
	<span style="color:#75715e">//将数据发送给客户端
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//if _, err := c.Conn.Write(binaryMsg); err != nil {
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//	fmt.Println(&#34;Write msg id&#34;, msgId, &#34; error&#34;, err)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//	return errors.New(&#34;conn Write error&#34;)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//}
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 发给管道
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MsgChan</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">binaryMsg</span>

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>测试Demo和V0.6一样</p>
<h2 id="zinxv09-链接管理">ZinxV0.9-链接管理</h2>
<p>为框架增加链接个数的限定。</p>
<blockquote>
<p>zinx/ziface/iconnmanager.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">ziface</span>

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 链接管理层模块 抽象层
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IConnManger</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">//添加链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">IConnection</span>)
	<span style="color:#75715e">//删除链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Remove</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">IConnection</span>)
	<span style="color:#75715e">//根据ConnId获取链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">connID</span> <span style="color:#66d9ef">uint32</span>) (<span style="color:#a6e22e">IConnection</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#75715e">//得到当前的链接总数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Len</span>() <span style="color:#66d9ef">int</span>
	<span style="color:#75715e">//清除并终止所有链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ClearConn</span>()
}
</code></pre></div><blockquote>
<p>zinx/znet/connmanager.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;errors&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;sync&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 链接管理模块实现
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ConnManager</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//管理的链接集合
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">connections</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">uint32</span>]<span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>
	<span style="color:#75715e">//保护链接集合的读写锁
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">connLock</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">RWMutex</span>
}

<span style="color:#75715e">//创建当前链接的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewConnManager</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">ConnManager</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ConnManager</span>{
		<span style="color:#a6e22e">connections</span>: make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">uint32</span>]<span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>),
	}
}

<span style="color:#75715e">//接口实现
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//添加链接
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">cm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ConnManager</span>) <span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>) {
	<span style="color:#75715e">//保护共享资源
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">connLock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">connLock</span>.<span style="color:#a6e22e">Unlock</span>()
	<span style="color:#75715e">//将conn加入到connManager中
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">connections</span>[<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">GetConnId</span>()] = <span style="color:#a6e22e">conn</span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;connID=&#34;</span>, <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">GetConnId</span>(), <span style="color:#e6db74">&#34; connection add to ConnManager successfully:conn num=&#34;</span>, <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Len</span>())
}

<span style="color:#75715e">//删除链接
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">cm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ConnManager</span>) <span style="color:#a6e22e">Remove</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>) {
	<span style="color:#75715e">//保护共享资源
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">connLock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">connLock</span>.<span style="color:#a6e22e">Unlock</span>()
	<span style="color:#75715e">//删除链接信息
</span><span style="color:#75715e"></span>	delete(<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">connections</span>, <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">GetConnId</span>())
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;connID=&#34;</span>, <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">GetConnId</span>(), <span style="color:#e6db74">&#34; remove  from ConnManager successfully:conn num=&#34;</span>, <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Len</span>())
}

<span style="color:#75715e">//根据ConnId获取链接
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">cm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ConnManager</span>) <span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">connID</span> <span style="color:#66d9ef">uint32</span>) (<span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#75715e">//保护共享资源,加读锁
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">connLock</span>.<span style="color:#a6e22e">RLock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">connLock</span>.<span style="color:#a6e22e">RUnlock</span>()
	<span style="color:#75715e">//查看是否存在
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">connections</span>[<span style="color:#a6e22e">connID</span>]; <span style="color:#a6e22e">ok</span> {
		<span style="color:#75715e">//找到了
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">conn</span>, <span style="color:#66d9ef">nil</span>
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;connection not FOUND!&#34;</span>)
	}
}

<span style="color:#75715e">//得到当前的链接总数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">cm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ConnManager</span>) <span style="color:#a6e22e">Len</span>() <span style="color:#66d9ef">int</span> {
	<span style="color:#66d9ef">return</span> len(<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">connections</span>)
}

<span style="color:#75715e">//清除并终止所有链接
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">cm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ConnManager</span>) <span style="color:#a6e22e">ClearConn</span>() {
	<span style="color:#75715e">//保护共享资源
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">connLock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">connLock</span>.<span style="color:#a6e22e">Unlock</span>()
	<span style="color:#75715e">//删除conn并停止conn工作
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">connID</span>, <span style="color:#a6e22e">conn</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">connections</span> {
		<span style="color:#75715e">//停止
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Stop</span>()
		<span style="color:#75715e">//删除
</span><span style="color:#75715e"></span>		delete(<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">connections</span>, <span style="color:#a6e22e">connID</span>)
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Clear All Connections succ! conn num = &#34;</span>, <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">Len</span>())
}
</code></pre></div><p>集成到zinx中</p>
<blockquote>
<p>zinx/ziface/iserver.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">ziface</span>

<span style="color:#75715e">//定义一个服务器接口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IServer</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">//启动服务器
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Start</span>()
	<span style="color:#75715e">//停止服务器
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Stop</span>()
	<span style="color:#75715e">//运行服务器
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Serve</span>()
	<span style="color:#75715e">//路由功能：给当前的服务注册一个路由方法，供客户端的链接处理使用
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">AddRouter</span>(<span style="color:#a6e22e">msgId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">router</span> <span style="color:#a6e22e">IRouter</span>)
	<span style="color:#75715e">//获取当前server的链接管理器
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetConnMgr</span>() <span style="color:#a6e22e">IConnManger</span>
	<span style="color:#75715e">//注册OnConnStart钩子函数的方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SetOnConnStart</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">connection</span> <span style="color:#a6e22e">IConnection</span>))
	<span style="color:#75715e">//注册OnConnStop钩子函数的方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SetOnConnStop</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">connection</span> <span style="color:#a6e22e">IConnection</span>))
	<span style="color:#75715e">//调用OnConnStart钩子函数的方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">CallOnConnStart</span>(<span style="color:#a6e22e">connection</span> <span style="color:#a6e22e">IConnection</span>)
	<span style="color:#75715e">//调用OnConnStop钩子函数的方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">CallOnConnStop</span>(<span style="color:#a6e22e">connection</span> <span style="color:#a6e22e">IConnection</span>)
}
</code></pre></div><blockquote>
<p>zinx/znet/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;zinx/utils&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">//Iserver的接口实现，定义一个server的服务模块
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Server</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//服务器名称
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器绑定的ip版本
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IPVersion</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器监听的IP
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IP</span> <span style="color:#66d9ef">string</span>
	<span style="color:#75715e">//服务器监听的端口
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Port</span> <span style="color:#66d9ef">int</span>
	<span style="color:#75715e">//当前的Server添加一个router,server注册的链接对应的业务处理
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//Router ziface.IRouter
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//当前server的消息管理模块，用来绑定MsgId和对应的处理业务API关系
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MsgHandle</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IMsgHandle</span>
	<span style="color:#75715e">//该server的链接管理器
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ConnMgr</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnManger</span>
	<span style="color:#75715e">//该server创建链接之后自动调用的Hook函数--OnConnStart
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">OnConnStart</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>)
	<span style="color:#75715e">//该Server销毁之前自动调用的Hook函数--OnConnStop
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">OnConnStop</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>)
}

<span style="color:#75715e">//启动服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;[Zinx] Server Name:%s, listenner at Ip:%s , Port:%d is starting\n&#34;</span>,
		<span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Host</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">TcpPort</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;[Zinx] Version %s, MaxConn:%d, MaxPacketSize:%d\n&#34;</span>,
		<span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Version</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">MaxConn</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">MaxPackageSize</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;[Start] Server Listenner at IP:%s, Port %d, is starting\n&#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IP</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Port</span>)

	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#75715e">//0、开启消息队列及Worker工作池
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">MsgHandle</span>.<span style="color:#a6e22e">StartWorkerPool</span>()

		<span style="color:#75715e">//1、获取一个TCP的addr
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ResolveTCPAddr</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s:%d&#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IP</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Port</span>))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;resolve tcp addr error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#75715e">//2、监听服务器地址
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">listenner</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ListenTCP</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#a6e22e">addr</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;listen &#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">IPVersion</span>, <span style="color:#e6db74">&#34;error :&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;start zinx Server succ &#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#e6db74">&#34; succ, Listenning...&#34;</span>)
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cid</span> <span style="color:#66d9ef">uint32</span>
		<span style="color:#a6e22e">cid</span> = <span style="color:#ae81ff">0</span>
		<span style="color:#75715e">//3、阻塞等待客户端连接，处理客户端连接业务（读写）
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> {
			<span style="color:#75715e">//如果有客户端连接过来，阻塞会返回
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listenner</span>.<span style="color:#a6e22e">AcceptTCP</span>()
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Accept err &#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">continue</span>
			}
			<span style="color:#75715e">//设置最大链接个数的判断，如果超过最大链接，则关闭此链接
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ConnMgr</span>.<span style="color:#a6e22e">Len</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">MaxConn</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;================&gt;Too Many Connections MaxConn = &#34;</span>, <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">MaxConn</span>)
				<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
				<span style="color:#66d9ef">continue</span>
			}

			<span style="color:#75715e">//客户端连接已经建立，todosomething
</span><span style="color:#75715e"></span>			<span style="color:#75715e">//将处理新连接的业务方法 和 conn进行绑定 得到我们的链接模块
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">dealConn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewConnection</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">cid</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">MsgHandle</span>)
			<span style="color:#a6e22e">cid</span><span style="color:#f92672">++</span>

			<span style="color:#75715e">//启动当前的链接业务
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">dealConn</span>.<span style="color:#a6e22e">Start</span>()
		}
	}()

}

<span style="color:#75715e">//停止服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Stop</span>() {
	<span style="color:#75715e">// TODO 将一些服务器的资源，状态或者一些已经开辟的链接信息，进行停止 或者回收
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;[STOP] Zinx server name&#34;</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Name</span>)
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ConnMgr</span>.<span style="color:#a6e22e">ClearConn</span>()
}

<span style="color:#75715e">//运行服务器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Serve</span>() {
	<span style="color:#75715e">//启动server的服务功能
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Start</span>()

	<span style="color:#75715e">//TODO 做一些启动服务器之后的额外业务
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">//阻塞状态
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">select</span> {}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">AddRouter</span>(<span style="color:#a6e22e">msgId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">router</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRouter</span>) {
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">MsgHandle</span>.<span style="color:#a6e22e">AddRouter</span>(<span style="color:#a6e22e">msgId</span>, <span style="color:#a6e22e">router</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Add Router Succ!!&#34;</span>)
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">GetConnMgr</span>() <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnManger</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ConnMgr</span>
}

<span style="color:#75715e">/**
</span><span style="color:#75715e">初始化Server模块的方法
</span><span style="color:#75715e">*/</span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IServer</span> {
	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Server</span>{
		<span style="color:#a6e22e">Name</span>:      <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Name</span>,
		<span style="color:#a6e22e">IPVersion</span>: <span style="color:#e6db74">&#34;tcp4&#34;</span>,
		<span style="color:#a6e22e">IP</span>:        <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">Host</span>,
		<span style="color:#a6e22e">Port</span>:      <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">TcpPort</span>,
		<span style="color:#75715e">//Router:    nil,
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">MsgHandle</span>: <span style="color:#a6e22e">NewMsgHandle</span>(),
		<span style="color:#a6e22e">ConnMgr</span>:   <span style="color:#a6e22e">NewConnManager</span>(),
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>
}

<span style="color:#75715e">//注册OnConnStart钩子函数的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">SetOnConnStart</span>(<span style="color:#a6e22e">hookFunc</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">connection</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>)) {
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">OnConnStart</span> = <span style="color:#a6e22e">hookFunc</span>
}

<span style="color:#75715e">//注册OnConnStop钩子函数的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">SetOnConnStop</span>(<span style="color:#a6e22e">hookFunc</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">connection</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>)) {
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">OnConnStop</span> = <span style="color:#a6e22e">hookFunc</span>
}

<span style="color:#75715e">//调用OnConnStart钩子函数的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">CallOnConnStart</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">OnConnStart</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;---&gt;Call OnConnStart()...&#34;</span>)
		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">OnConnStart</span>(<span style="color:#a6e22e">conn</span>)
	}
}

<span style="color:#75715e">//调用OnConnStop钩子函数的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">CallOnConnStop</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">OnConnStop</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;---&gt;Call OnConnStop()...&#34;</span>)
		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">OnConnStop</span>(<span style="color:#a6e22e">conn</span>)
	}
}
</code></pre></div><blockquote>
<p>zinx/znet/connection.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;errors&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;io&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;zinx/utils&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">//链接模块
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Connection</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//当前Conn隶属于哪个Server
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">TcpServer</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IServer</span>
	<span style="color:#75715e">//当前链接的Socket TCP套接字
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>
	<span style="color:#75715e">//链接ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ConnId</span> <span style="color:#66d9ef">uint32</span>
	<span style="color:#75715e">//当前的链接状态
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">isClosed</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">//告知当前链接已经退出/停止 channle
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ExitChan</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">//无缓存的管道，用于读写goroutine之间的消息通信
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MsgChan</span> <span style="color:#66d9ef">chan</span> []<span style="color:#66d9ef">byte</span>

	<span style="color:#75715e">//该链接处理的方法Router
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//Router ziface.IRouter
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//消息的管理MsgId和对应的处理业务API关系
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MsgHandle</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IMsgHandle</span>
}

<span style="color:#75715e">//初始化链接模块的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewConnection</span>(<span style="color:#a6e22e">server</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IServer</span>, <span style="color:#a6e22e">conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>, <span style="color:#a6e22e">connId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">msgHandler</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IMsgHandle</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span> {
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Connection</span>{
		<span style="color:#a6e22e">TcpServer</span>: <span style="color:#a6e22e">server</span>,
		<span style="color:#a6e22e">Conn</span>:      <span style="color:#a6e22e">conn</span>,
		<span style="color:#a6e22e">ConnId</span>:    <span style="color:#a6e22e">connId</span>,
		<span style="color:#a6e22e">MsgHandle</span>: <span style="color:#a6e22e">msgHandler</span>,
		<span style="color:#a6e22e">isClosed</span>:  <span style="color:#66d9ef">false</span>,
		<span style="color:#a6e22e">MsgChan</span>:   make(<span style="color:#66d9ef">chan</span> []<span style="color:#66d9ef">byte</span>),
		<span style="color:#a6e22e">ExitChan</span>:  make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>, <span style="color:#ae81ff">1</span>),
	}
	<span style="color:#75715e">//将conn加入到ConnManager中
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">TcpServer</span>.<span style="color:#a6e22e">GetConnMgr</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">c</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>
}

<span style="color:#75715e">//读数据的业务
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">StartReader</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;[Reader Goroutine is running...]&#34;</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;[Reader is exit],  connId = &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>, <span style="color:#e6db74">&#34;  remote addr is &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">RemoteAddr</span>().<span style="color:#a6e22e">String</span>())
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Stop</span>()
	<span style="color:#66d9ef">for</span> {
		<span style="color:#75715e">//读取客户端的数据到buf中，最大512字节
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//buf := make([]byte, utils.GlobalObject.MaxPackageSize)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//_, err := c.Conn.Read(buf)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//if err != nil {
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	fmt.Println(&#34;recv buf err:&#34;, err)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	continue
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//}
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//创建一个拆包解包对象
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDataPack</span>()
		<span style="color:#75715e">//读取客户端的Msg Head 二进制流 8个字节
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">headData</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">GetHeadLen</span>())
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">GetTCPConnection</span>(), <span style="color:#a6e22e">headData</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read msg head error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//拆包，得到MsgId和msgDataLen 放在msg消息中
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">UnPack</span>(<span style="color:#a6e22e">headData</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;unpack error&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//根据DataLen，再次读取Data,放在msg.Data中
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgLen</span>() &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">data</span> = make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgLen</span>())
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">GetTCPConnection</span>(), <span style="color:#a6e22e">data</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read msg data error&#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">break</span>
			}
		}
		<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">SetData</span>(<span style="color:#a6e22e">data</span>)

		<span style="color:#75715e">//得到当前conn数据的Request请求数据
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Request</span>{
			<span style="color:#a6e22e">conn</span>: <span style="color:#a6e22e">c</span>,
			<span style="color:#a6e22e">msg</span>:  <span style="color:#a6e22e">msg</span>,
		}
		<span style="color:#75715e">//从路由中，找到注册绑定的Conn对应的Router调用
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//go func(request ziface.IRequest) {
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	c.Router.PreHandle(request)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	c.Router.Handle(request)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	c.Router.PostHandle(request)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//}(&amp;req)
</span><span style="color:#75715e"></span>
		<span style="color:#75715e">//从路由中，找到注册绑定的Conn对应的router调用
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//go c.MsgHandle.DoMsgHandler(&amp;req)
</span><span style="color:#75715e"></span>
		<span style="color:#75715e">//判断是否开启了工作池
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">WorkerPoolSize</span> &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#75715e">//已经开启了工作池，将消息发送给工作池处理
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MsgHandle</span>.<span style="color:#a6e22e">SendMsgToTaskQueue</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">req</span>)
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#75715e">//还是使用旧的方法，直接发给对应的go处理
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MsgHandle</span>.<span style="color:#a6e22e">DoMsgHandler</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">req</span>)
		}

	}

}

<span style="color:#75715e">//写数据的业务
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">StartWriter</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;[Writer Goroutine is running...]&#34;</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34; [conn Writer exit!] &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">RemoteAddr</span>().<span style="color:#a6e22e">String</span>())
	<span style="color:#75715e">//不断阻塞等待channel的消息，进行写给客户端
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">data</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MsgChan</span>:
			<span style="color:#75715e">//有数据要写给客户端
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">data</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Send data error,&#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">return</span>
			}
		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ExitChan</span>:
			<span style="color:#75715e">//代表Reader已经退出，此时Writer也要退出
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">return</span>
		}
	}
}

<span style="color:#75715e">//实现接口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Conn Start().. ConnId=&#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>)

	<span style="color:#75715e">//启动从当前链接的读数据的业务
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">StartReader</span>()

	<span style="color:#75715e">//TODO 启动从当前链接写数据的业务
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">StartWriter</span>()

	<span style="color:#75715e">//按照开发者传递进来的 创建链接之后需要调用的处理业务，执行对应的Hook函数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">TcpServer</span>.<span style="color:#a6e22e">CallOnConnStart</span>(<span style="color:#a6e22e">c</span>)

}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Stop</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Conn Stop() .. ConnId = &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>)

	<span style="color:#75715e">//如果当前链接已经关闭
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> = <span style="color:#66d9ef">true</span>

	<span style="color:#75715e">//按照开发者传递进来的 销毁链接之前需要调用的处理业务，执行对应的Hook函数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">TcpServer</span>.<span style="color:#a6e22e">CallOnConnStop</span>(<span style="color:#a6e22e">c</span>)

	<span style="color:#75715e">//关闭socket链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#75715e">//告知Writer关闭
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ExitChan</span> <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">true</span>

	<span style="color:#75715e">//将当前链接从connMgr中摘除掉
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">TcpServer</span>.<span style="color:#a6e22e">GetConnMgr</span>().<span style="color:#a6e22e">Remove</span>(<span style="color:#a6e22e">c</span>)

	<span style="color:#75715e">//回收资源
</span><span style="color:#75715e"></span>	close(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ExitChan</span>)
	close(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MsgChan</span>)
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">GetTCPConnection</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">GetConnId</span>() <span style="color:#66d9ef">uint32</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">RemoteAddr</span>() <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Addr</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">RemoteAddr</span>()
}

<span style="color:#75715e">// 先将要发送给客户端的数据先进行封包，再发送
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">SendMsg</span>(<span style="color:#a6e22e">msgId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Connection closed when send msg&#34;</span>)
	}
	<span style="color:#75715e">//将data进行封包，格式：msgDatalen|msgId|msgData
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDataPack</span>()

	<span style="color:#a6e22e">binaryMsg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">Pack</span>(<span style="color:#a6e22e">NewMsgPackage</span>(<span style="color:#a6e22e">msgId</span>, <span style="color:#a6e22e">data</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;pack error msg id =&#34;</span>, <span style="color:#a6e22e">msgId</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Pack error msg&#34;</span>)
	}
	<span style="color:#75715e">//将数据发送给客户端
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//if _, err := c.Conn.Write(binaryMsg); err != nil {
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//	fmt.Println(&#34;Write msg id&#34;, msgId, &#34; error&#34;, err)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//	return errors.New(&#34;conn Write error&#34;)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//}
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 发给管道
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MsgChan</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">binaryMsg</span>

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>使用Demo测试</p>
<blockquote>
<p>myDemo/zinxv0.9/conf/zinx.json</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;Zinx v0.9 demoServerApp&#34;</span>,
  <span style="color:#f92672">&#34;Host&#34;</span>: <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>,
  <span style="color:#f92672">&#34;TcpPort&#34;</span>: <span style="color:#ae81ff">7777</span>,
  <span style="color:#f92672">&#34;MaxConn&#34;</span>: <span style="color:#ae81ff">3</span>,
  <span style="color:#f92672">&#34;WorkerPoolSize&#34;</span>: <span style="color:#ae81ff">10</span>
}
</code></pre></div><blockquote>
<p>myDemo/zinxv0.9/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e">基于Zinx框架开发的 服务端应用程序
</span><span style="color:#75715e">*/</span>

<span style="color:#75715e">//ping test自定义路由
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PingRouter</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">BaseRouter</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">pr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PingRouter</span>) <span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Call PingRouter Handle...&#34;</span>)
	<span style="color:#75715e">//先读取客户端的数据，在回写ping...ping...ping
</span><span style="color:#75715e"></span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Recv from client:msgId =&#34;</span>, <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetMsgId</span>(), <span style="color:#e6db74">&#34; data = &#34;</span>, string(<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetData</span>()))
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetConnection</span>().<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">1</span>, []byte(<span style="color:#e6db74">&#34;ping...ping...ping&#34;</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
	}
}

<span style="color:#75715e">//自定义Hello zinx test 路由
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HelloZinxRouter</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">BaseRouter</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">pr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">HelloZinxRouter</span>) <span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Call HelloRouter Handle...&#34;</span>)
	<span style="color:#75715e">//先读取客户端的数据，在回写ping...ping...ping
</span><span style="color:#75715e"></span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Recv from client:msgId =&#34;</span>, <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetMsgId</span>(), <span style="color:#e6db74">&#34; data = &#34;</span>, string(<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetData</span>()))
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetConnection</span>().<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">201</span>, []byte(<span style="color:#e6db74">&#34;Hello welcome to zinx&#34;</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
	}
}

<span style="color:#75715e">//创建链接之后执行钩子函数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DoConnectionBegin</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;==&gt; DoConnectionBegin is Called...&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">202</span>, []byte(<span style="color:#e6db74">&#34;DoConnection BEGIN&#34;</span>)); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
	}
}

<span style="color:#75715e">//链接断开前需要执行的钩子函数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DoConnectionStop</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;==&gt;DoConnectionStop is Called...&#34;</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;conn ID = &#34;</span>, <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">GetConnId</span>(), <span style="color:#e6db74">&#34; is lost...&#34;</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//1、创建一个server句柄，使用Zinx的api
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#e6db74">&#34;[zinx V0.7]&#34;</span>)

	<span style="color:#75715e">//2、注册链接Hook钩子函数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">SetOnConnStart</span>(<span style="color:#a6e22e">DoConnectionBegin</span>)
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">SetOnConnStop</span>(<span style="color:#a6e22e">DoConnectionStop</span>)

	<span style="color:#75715e">//3、给当前zinx框架添加自定义的router
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">AddRouter</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">PingRouter</span>{})
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">AddRouter</span>(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">HelloZinxRouter</span>{})

	<span style="color:#75715e">//4、启动server
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Serve</span>()
}
</code></pre></div><p>client没有变化</p>
<blockquote>
<p>myDemo/zinxv0.9/Client.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;io&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e">模拟客户端
</span><span style="color:#75715e">*/</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client0 start&#34;</span>)
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#75715e">//1、直接链接远程服务器，得到一个conn链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;127.0.0.1:7777&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client start err :&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//2、链接调用Write 写数据
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> {
		<span style="color:#75715e">//发送封包的Message消息
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewDataPack</span>()
		<span style="color:#a6e22e">binaryMsg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">Pack</span>(<span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewMsgPackage</span>(<span style="color:#ae81ff">0</span>, []byte(<span style="color:#e6db74">&#34;Zinx Client0 Test Message&#34;</span>)))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Pack error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">binaryMsg</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;write error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}

		<span style="color:#75715e">//服务器应该给我们回复一个message，MsgId:1 pingpingping
</span><span style="color:#75715e"></span>
		<span style="color:#75715e">//先读取流中的head部分 得到ID和 dataLen
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">binaryHead</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">GetHeadLen</span>())
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">binaryHead</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read head error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//将二进制的head拆包到msg结构体中
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">msgHead</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">UnPack</span>(<span style="color:#a6e22e">binaryHead</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client unpack msgHead error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//再根据DataLen进行第二次读取，将data
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">msgHead</span>.<span style="color:#a6e22e">GetMsgLen</span>() &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">msgHead</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">Message</span>)
			<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Data</span> = make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgLen</span>())
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Data</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read msg data error:&#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">return</span>
			}
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Recv Server Msg:Id=&#34;</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Id</span>, <span style="color:#e6db74">&#34; len=&#34;</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">DataLen</span>, <span style="color:#e6db74">&#34; data = &#34;</span>, string(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Data</span>))
		}

		<span style="color:#75715e">//cpu阻塞
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	}
}
</code></pre></div><h2 id="zinxv10链接属性设置">ZinxV1.0链接属性设置</h2>
<p>在处理链接的时候，可以给链接绑定一些用户的数据或者参数。</p>
<blockquote>
<p>zinx/ziface/iconnection.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">ziface</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;net&#34;</span>

<span style="color:#75715e">//定义链接模块的抽象层
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IConnection</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">//启动链接 让当前的链接准备开始工作
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Start</span>()
	<span style="color:#75715e">//停止链接 结束当前链接的工作
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Stop</span>()
	<span style="color:#75715e">//获取当前链接绑定socket conn
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetTCPConnection</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>
	<span style="color:#75715e">//获取当前链接模块的链接ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetConnId</span>() <span style="color:#66d9ef">uint32</span>
	<span style="color:#75715e">//获取远程客户端的TCP状态IP PORT
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">RemoteAddr</span>() <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Addr</span>
	<span style="color:#75715e">//发送数据，将数据发送给远程的客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SendMsg</span>(<span style="color:#a6e22e">msgid</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#66d9ef">error</span>
	<span style="color:#75715e">//设置连接属性
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SetProperty</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">interface</span>{})
	<span style="color:#75715e">//获取连接属性
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetProperty</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>)
	<span style="color:#75715e">//移除连接属性
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">RemoveProperty</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>)
}

<span style="color:#75715e">//定义一个处理业务的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HandleFunc</span> <span style="color:#66d9ef">func</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>, []<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">error</span>
</code></pre></div><p>在connection中实现设置、获取、移除链接属性的方法。</p>
<blockquote>
<p>zinx/znet/connection.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">znet</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;errors&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;io&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;sync&#34;</span>
	<span style="color:#e6db74">&#34;zinx/utils&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">//链接模块
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Connection</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//当前Conn隶属于哪个Server
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">TcpServer</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IServer</span>
	<span style="color:#75715e">//当前链接的Socket TCP套接字
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>
	<span style="color:#75715e">//链接ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ConnId</span> <span style="color:#66d9ef">uint32</span>
	<span style="color:#75715e">//当前的链接状态
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">isClosed</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">//告知当前链接已经退出/停止 channle
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ExitChan</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">//无缓存的管道，用于读写goroutine之间的消息通信
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MsgChan</span> <span style="color:#66d9ef">chan</span> []<span style="color:#66d9ef">byte</span>

	<span style="color:#75715e">//该链接处理的方法Router
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//Router ziface.IRouter
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//消息的管理MsgId和对应的处理业务API关系
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MsgHandle</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IMsgHandle</span>
	<span style="color:#75715e">//连接属性集合
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">property</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{}
	<span style="color:#75715e">//保护连接属性的锁
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">propertyLock</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">RWMutex</span>
}

<span style="color:#75715e">//初始化链接模块的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewConnection</span>(<span style="color:#a6e22e">server</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IServer</span>, <span style="color:#a6e22e">conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span>, <span style="color:#a6e22e">connId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">msgHandler</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IMsgHandle</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span> {
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Connection</span>{
		<span style="color:#a6e22e">TcpServer</span>: <span style="color:#a6e22e">server</span>,
		<span style="color:#a6e22e">Conn</span>:      <span style="color:#a6e22e">conn</span>,
		<span style="color:#a6e22e">ConnId</span>:    <span style="color:#a6e22e">connId</span>,
		<span style="color:#a6e22e">MsgHandle</span>: <span style="color:#a6e22e">msgHandler</span>,
		<span style="color:#a6e22e">isClosed</span>:  <span style="color:#66d9ef">false</span>,
		<span style="color:#a6e22e">MsgChan</span>:   make(<span style="color:#66d9ef">chan</span> []<span style="color:#66d9ef">byte</span>),
		<span style="color:#a6e22e">ExitChan</span>:  make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>, <span style="color:#ae81ff">1</span>),
		<span style="color:#a6e22e">property</span>:  make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{}),
	}
	<span style="color:#75715e">//将conn加入到ConnManager中
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">TcpServer</span>.<span style="color:#a6e22e">GetConnMgr</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">c</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>
}

<span style="color:#75715e">//读数据的业务
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">StartReader</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;[Reader Goroutine is running...]&#34;</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;[Reader is exit],  connId = &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>, <span style="color:#e6db74">&#34;  remote addr is &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">RemoteAddr</span>().<span style="color:#a6e22e">String</span>())
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Stop</span>()
	<span style="color:#66d9ef">for</span> {
		<span style="color:#75715e">//读取客户端的数据到buf中，最大512字节
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//buf := make([]byte, utils.GlobalObject.MaxPackageSize)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//_, err := c.Conn.Read(buf)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//if err != nil {
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	fmt.Println(&#34;recv buf err:&#34;, err)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	continue
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//}
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//创建一个拆包解包对象
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDataPack</span>()
		<span style="color:#75715e">//读取客户端的Msg Head 二进制流 8个字节
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">headData</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">GetHeadLen</span>())
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">GetTCPConnection</span>(), <span style="color:#a6e22e">headData</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read msg head error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//拆包，得到MsgId和msgDataLen 放在msg消息中
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">UnPack</span>(<span style="color:#a6e22e">headData</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;unpack error&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//根据DataLen，再次读取Data,放在msg.Data中
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgLen</span>() &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">data</span> = make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgLen</span>())
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">GetTCPConnection</span>(), <span style="color:#a6e22e">data</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read msg data error&#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">break</span>
			}
		}
		<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">SetData</span>(<span style="color:#a6e22e">data</span>)

		<span style="color:#75715e">//得到当前conn数据的Request请求数据
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Request</span>{
			<span style="color:#a6e22e">conn</span>: <span style="color:#a6e22e">c</span>,
			<span style="color:#a6e22e">msg</span>:  <span style="color:#a6e22e">msg</span>,
		}
		<span style="color:#75715e">//从路由中，找到注册绑定的Conn对应的Router调用
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//go func(request ziface.IRequest) {
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	c.Router.PreHandle(request)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	c.Router.Handle(request)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	c.Router.PostHandle(request)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//}(&amp;req)
</span><span style="color:#75715e"></span>
		<span style="color:#75715e">//从路由中，找到注册绑定的Conn对应的router调用
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//go c.MsgHandle.DoMsgHandler(&amp;req)
</span><span style="color:#75715e"></span>
		<span style="color:#75715e">//判断是否开启了工作池
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">GlobalObject</span>.<span style="color:#a6e22e">WorkerPoolSize</span> &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#75715e">//已经开启了工作池，将消息发送给工作池处理
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MsgHandle</span>.<span style="color:#a6e22e">SendMsgToTaskQueue</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">req</span>)
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#75715e">//还是使用旧的方法，直接发给对应的go处理
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MsgHandle</span>.<span style="color:#a6e22e">DoMsgHandler</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">req</span>)
		}

	}

}

<span style="color:#75715e">//写数据的业务
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">StartWriter</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;[Writer Goroutine is running...]&#34;</span>)
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34; [conn Writer exit!] &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">RemoteAddr</span>().<span style="color:#a6e22e">String</span>())
	<span style="color:#75715e">//不断阻塞等待channel的消息，进行写给客户端
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">data</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MsgChan</span>:
			<span style="color:#75715e">//有数据要写给客户端
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">data</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Send data error,&#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">return</span>
			}
		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ExitChan</span>:
			<span style="color:#75715e">//代表Reader已经退出，此时Writer也要退出
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">return</span>
		}
	}
}

<span style="color:#75715e">//实现接口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Conn Start().. ConnId=&#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>)

	<span style="color:#75715e">//启动从当前链接的读数据的业务
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">StartReader</span>()

	<span style="color:#75715e">//TODO 启动从当前链接写数据的业务
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">StartWriter</span>()

	<span style="color:#75715e">//按照开发者传递进来的 创建链接之后需要调用的处理业务，执行对应的Hook函数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">TcpServer</span>.<span style="color:#a6e22e">CallOnConnStart</span>(<span style="color:#a6e22e">c</span>)

}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">Stop</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Conn Stop() .. ConnId = &#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>)

	<span style="color:#75715e">//如果当前链接已经关闭
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> = <span style="color:#66d9ef">true</span>

	<span style="color:#75715e">//按照开发者传递进来的 销毁链接之前需要调用的处理业务，执行对应的Hook函数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">TcpServer</span>.<span style="color:#a6e22e">CallOnConnStop</span>(<span style="color:#a6e22e">c</span>)

	<span style="color:#75715e">//关闭socket链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">Close</span>()
	<span style="color:#75715e">//告知Writer关闭
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ExitChan</span> <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">true</span>

	<span style="color:#75715e">//将当前链接从connMgr中摘除掉
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">TcpServer</span>.<span style="color:#a6e22e">GetConnMgr</span>().<span style="color:#a6e22e">Remove</span>(<span style="color:#a6e22e">c</span>)

	<span style="color:#75715e">//回收资源
</span><span style="color:#75715e"></span>	close(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ExitChan</span>)
	close(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MsgChan</span>)
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">GetTCPConnection</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPConn</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">GetConnId</span>() <span style="color:#66d9ef">uint32</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ConnId</span>
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">RemoteAddr</span>() <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Addr</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">RemoteAddr</span>()
}

<span style="color:#75715e">// 先将要发送给客户端的数据先进行封包，再发送
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">SendMsg</span>(<span style="color:#a6e22e">msgId</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">isClosed</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Connection closed when send msg&#34;</span>)
	}
	<span style="color:#75715e">//将data进行封包，格式：msgDatalen|msgId|msgData
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDataPack</span>()

	<span style="color:#a6e22e">binaryMsg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">Pack</span>(<span style="color:#a6e22e">NewMsgPackage</span>(<span style="color:#a6e22e">msgId</span>, <span style="color:#a6e22e">data</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;pack error msg id =&#34;</span>, <span style="color:#a6e22e">msgId</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Pack error msg&#34;</span>)
	}
	<span style="color:#75715e">//将数据发送给客户端
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//if _, err := c.Conn.Write(binaryMsg); err != nil {
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//	fmt.Println(&#34;Write msg id&#34;, msgId, &#34; error&#34;, err)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//	return errors.New(&#34;conn Write error&#34;)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//}
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 发给管道
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">MsgChan</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">binaryMsg</span>

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">//设置连接属性
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">SetProperty</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">value</span> <span style="color:#66d9ef">interface</span>{}) {
	<span style="color:#75715e">//保护数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">propertyLock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">propertyLock</span>.<span style="color:#a6e22e">Unlock</span>()
	<span style="color:#75715e">//添加一个属性
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">property</span>[<span style="color:#a6e22e">key</span>] = <span style="color:#a6e22e">value</span>
}

<span style="color:#75715e">//获取连接属性
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">GetProperty</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
	<span style="color:#75715e">//保护数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">propertyLock</span>.<span style="color:#a6e22e">RLock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">propertyLock</span>.<span style="color:#a6e22e">RUnlock</span>()
	<span style="color:#75715e">//获取属性
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">value</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">property</span>[<span style="color:#a6e22e">key</span>]; <span style="color:#a6e22e">ok</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">value</span>, <span style="color:#66d9ef">nil</span>
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;no property FOUND!&#34;</span>)
	}
}

<span style="color:#75715e">//移除连接属性
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Connection</span>) <span style="color:#a6e22e">RemoveProperty</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>) {
	<span style="color:#75715e">//保护数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">propertyLock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">propertyLock</span>.<span style="color:#a6e22e">Unlock</span>()
	<span style="color:#75715e">//删除属性
</span><span style="color:#75715e"></span>	delete(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">property</span>, <span style="color:#a6e22e">key</span>)
}
</code></pre></div><p>使用Demo测试</p>
<blockquote>
<p>myDemo/zinxv1.0/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e">基于Zinx框架开发的 服务端应用程序
</span><span style="color:#75715e">*/</span>

<span style="color:#75715e">//ping test自定义路由
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PingRouter</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">BaseRouter</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">pr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PingRouter</span>) <span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Call PingRouter Handle...&#34;</span>)
	<span style="color:#75715e">//先读取客户端的数据，在回写ping...ping...ping
</span><span style="color:#75715e"></span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Recv from client:msgId =&#34;</span>, <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetMsgId</span>(), <span style="color:#e6db74">&#34; data = &#34;</span>, string(<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetData</span>()))
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetConnection</span>().<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">1</span>, []byte(<span style="color:#e6db74">&#34;ping...ping...ping&#34;</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
	}
}

<span style="color:#75715e">//自定义Hello zinx test 路由
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HelloZinxRouter</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">BaseRouter</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">pr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">HelloZinxRouter</span>) <span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Call HelloRouter Handle...&#34;</span>)
	<span style="color:#75715e">//先读取客户端的数据，在回写ping...ping...ping
</span><span style="color:#75715e"></span>
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Recv from client:msgId =&#34;</span>, <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetMsgId</span>(), <span style="color:#e6db74">&#34; data = &#34;</span>, string(<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetData</span>()))
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetConnection</span>().<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">201</span>, []byte(<span style="color:#e6db74">&#34;Hello welcome to zinx&#34;</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
	}
}

<span style="color:#75715e">//创建链接之后执行钩子函数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DoConnectionBegin</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;==&gt; DoConnectionBegin is Called...&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">202</span>, []byte(<span style="color:#e6db74">&#34;DoConnection BEGIN&#34;</span>)); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#75715e">//设置property
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Set property...&#34;</span>)
	<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">SetProperty</span>(<span style="color:#e6db74">&#34;Name&#34;</span>, <span style="color:#e6db74">&#34;abin&#34;</span>)
	<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">SetProperty</span>(<span style="color:#e6db74">&#34;GitHub&#34;</span>, <span style="color:#e6db74">&#34;http://github.com/kevinbin123&#34;</span>)
}

<span style="color:#75715e">//链接断开前需要执行的钩子函数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DoConnectionStop</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>) {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;==&gt;DoConnectionStop is Called...&#34;</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;conn ID = &#34;</span>, <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">GetConnId</span>(), <span style="color:#e6db74">&#34; is lost...&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">value</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">GetProperty</span>(<span style="color:#e6db74">&#34;Name&#34;</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Name=&#34;</span>, <span style="color:#a6e22e">value</span>)
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">value</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">GetProperty</span>(<span style="color:#e6db74">&#34;GitHub&#34;</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;GitHub=&#34;</span>, <span style="color:#a6e22e">value</span>)
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//1、创建一个server句柄，使用Zinx的api
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#e6db74">&#34;[zinx V0.7]&#34;</span>)

	<span style="color:#75715e">//2、注册链接Hook钩子函数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">SetOnConnStart</span>(<span style="color:#a6e22e">DoConnectionBegin</span>)
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">SetOnConnStop</span>(<span style="color:#a6e22e">DoConnectionStop</span>)

	<span style="color:#75715e">//3、给当前zinx框架添加自定义的router
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">AddRouter</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">PingRouter</span>{})
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">AddRouter</span>(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">HelloZinxRouter</span>{})

	<span style="color:#75715e">//4、启动server
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Serve</span>()
}
</code></pre></div><p>client没有变化</p>
<blockquote>
<p>myDemo/zinxv1.0/Client.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;io&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e">模拟客户端
</span><span style="color:#75715e">*/</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client0 start&#34;</span>)
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#75715e">//1、直接链接远程服务器，得到一个conn链接
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;127.0.0.1:7777&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client start err :&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//2、链接调用Write 写数据
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> {
		<span style="color:#75715e">//发送封包的Message消息
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewDataPack</span>()
		<span style="color:#a6e22e">binaryMsg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">Pack</span>(<span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewMsgPackage</span>(<span style="color:#ae81ff">0</span>, []byte(<span style="color:#e6db74">&#34;Zinx Client0 Test Message&#34;</span>)))
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Pack error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">binaryMsg</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;write error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}

		<span style="color:#75715e">//服务器应该给我们回复一个message，MsgId:1 pingpingping
</span><span style="color:#75715e"></span>
		<span style="color:#75715e">//先读取流中的head部分 得到ID和 dataLen
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">binaryHead</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">GetHeadLen</span>())
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">binaryHead</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read head error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//将二进制的head拆包到msg结构体中
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">msgHead</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">UnPack</span>(<span style="color:#a6e22e">binaryHead</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;client unpack msgHead error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">//再根据DataLen进行第二次读取，将data
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">msgHead</span>.<span style="color:#a6e22e">GetMsgLen</span>() &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">msgHead</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">Message</span>)
			<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Data</span> = make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgLen</span>())
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Data</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read msg data error:&#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">return</span>
			}
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Recv Server Msg:Id=&#34;</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Id</span>, <span style="color:#e6db74">&#34; len=&#34;</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">DataLen</span>, <span style="color:#e6db74">&#34; data = &#34;</span>, string(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Data</span>))
		}

		<span style="color:#75715e">//cpu阻塞
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	}
}
</code></pre></div><h2 id="基于zinx的应用案例">基于Zinx的应用案例</h2>
<p>基于Zinx完成一个服务端的应用程序，该程序使用带unity3d 客户端，实现mmo游戏的基础模块AOI（基于兴趣范围的广播），世界聊天等。</p>
<h3 id="aoi相关">AOI相关</h3>
<p>地图大概如下设计</p>
<p>
        <img class="mx-auto" alt="image-20220411150947872" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/202204111509981.png" />   
    </p>
<p>实现AOI格子结构：</p>
<blockquote>
<p>mmo_game_zinx/core/grid.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">core</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;sync&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * AOI格子
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Grid</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//格子ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GID</span> <span style="color:#66d9ef">int</span>
	<span style="color:#75715e">//左边界坐标
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MinX</span> <span style="color:#66d9ef">int</span>
	<span style="color:#75715e">//右边界坐标
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MaxX</span> <span style="color:#66d9ef">int</span>
	<span style="color:#75715e">//上边界坐标
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MinY</span> <span style="color:#66d9ef">int</span>
	<span style="color:#75715e">//下边界坐标
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MaxY</span> <span style="color:#66d9ef">int</span>
	<span style="color:#75715e">//当前所有玩家集合
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">playerIDs</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#66d9ef">bool</span>
	<span style="color:#75715e">//保护当前集合的锁
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pIDLock</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">RWMutex</span>
}

<span style="color:#75715e">//初始化当前格子的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewGrid</span>(<span style="color:#a6e22e">gid</span>, <span style="color:#a6e22e">minx</span>, <span style="color:#a6e22e">maxx</span>, <span style="color:#a6e22e">miny</span>, <span style="color:#a6e22e">maxy</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Grid</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Grid</span>{
		<span style="color:#a6e22e">GID</span>:       <span style="color:#a6e22e">gid</span>,
		<span style="color:#a6e22e">MinX</span>:      <span style="color:#a6e22e">minx</span>,
		<span style="color:#a6e22e">MaxX</span>:      <span style="color:#a6e22e">maxx</span>,
		<span style="color:#a6e22e">MinY</span>:      <span style="color:#a6e22e">miny</span>,
		<span style="color:#a6e22e">MaxY</span>:      <span style="color:#a6e22e">maxy</span>,
		<span style="color:#a6e22e">playerIDs</span>: make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#66d9ef">bool</span>),
	}
}

<span style="color:#75715e">//给格子添加一个玩家
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">g</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Grid</span>) <span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">playerID</span> <span style="color:#66d9ef">int</span>) {
	<span style="color:#75715e">//保护数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">pIDLock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">pIDLock</span>.<span style="color:#a6e22e">Unlock</span>()
	<span style="color:#75715e">//添加数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">playerIDs</span>[<span style="color:#a6e22e">playerID</span>] = <span style="color:#66d9ef">true</span>
}

<span style="color:#75715e">//从格子中删除一个玩家
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">g</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Grid</span>) <span style="color:#a6e22e">Remove</span>(<span style="color:#a6e22e">playerID</span> <span style="color:#66d9ef">int</span>) {
	<span style="color:#75715e">//保护数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">pIDLock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">pIDLock</span>.<span style="color:#a6e22e">Unlock</span>()
	<span style="color:#75715e">//删除数据
</span><span style="color:#75715e"></span>	delete(<span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">playerIDs</span>, <span style="color:#a6e22e">playerID</span>)
}

<span style="color:#75715e">//得到当前格子的所有玩家
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">g</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Grid</span>) <span style="color:#a6e22e">GetPlayerIDs</span>() (<span style="color:#a6e22e">playerIDS</span> []<span style="color:#66d9ef">int</span>) {
	<span style="color:#75715e">//保护数据，加读锁
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">pIDLock</span>.<span style="color:#a6e22e">RLock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">pIDLock</span>.<span style="color:#a6e22e">RUnlock</span>()
	<span style="color:#75715e">//将数据读出来，添加到切片中
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">player</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">playerIDs</span> {
		<span style="color:#a6e22e">playerIDS</span> = append(<span style="color:#a6e22e">playerIDS</span>, <span style="color:#a6e22e">player</span>)
	}
	<span style="color:#66d9ef">return</span>
}

<span style="color:#75715e">//调试使用-打印出格子的基本信息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">g</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Grid</span>) <span style="color:#a6e22e">String</span>() <span style="color:#66d9ef">string</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Grid id:%d, minX:%d, maxX:%d, minY:%d, maxY:%d, playerIDs:%v&#34;</span>,
		<span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">GID</span>, <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">MinX</span>, <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">MaxX</span>, <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">MinY</span>, <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">MaxY</span>, <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">playerIDs</span>)
}
</code></pre></div><p>实现AOI管理模块</p>
<blockquote>
<p>mmo_game_zinx/core/aoi.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">core</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * aoi管理
</span><span style="color:#75715e"> */</span>

<span style="color:#75715e">//定义一些AOI的边界值
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> (
	<span style="color:#a6e22e">AOI_MIN_X</span>  <span style="color:#66d9ef">int</span> = <span style="color:#ae81ff">85</span>
	<span style="color:#a6e22e">AOI_MAX_X</span>  <span style="color:#66d9ef">int</span> = <span style="color:#ae81ff">410</span>
	<span style="color:#a6e22e">AOI_MIN_Y</span>  <span style="color:#66d9ef">int</span> = <span style="color:#ae81ff">75</span>
	<span style="color:#a6e22e">AOI_MAX_Y</span>  <span style="color:#66d9ef">int</span> = <span style="color:#ae81ff">400</span>
	<span style="color:#a6e22e">AOI_CNTS_X</span> <span style="color:#66d9ef">int</span> = <span style="color:#ae81ff">10</span>
	<span style="color:#a6e22e">AOI_CNTS_Y</span> <span style="color:#66d9ef">int</span> = <span style="color:#ae81ff">20</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">AOIManager</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//区域左边界坐标
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MinX</span> <span style="color:#66d9ef">int</span>
	<span style="color:#75715e">//区域右边界坐标
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MaxX</span> <span style="color:#66d9ef">int</span>
	<span style="color:#75715e">//区域x轴上格子的数量
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">CntsX</span> <span style="color:#66d9ef">int</span>
	<span style="color:#75715e">//区域上边界坐标
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MinY</span> <span style="color:#66d9ef">int</span>
	<span style="color:#75715e">//区域下边界坐标
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MaxY</span> <span style="color:#66d9ef">int</span>
	<span style="color:#75715e">//区域y轴上格子的数量
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">CntsY</span> <span style="color:#66d9ef">int</span>
	<span style="color:#75715e">//当前区域中有哪些格子
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">grids</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">Grid</span>
}

<span style="color:#75715e">//初始化一个AOI管理模块
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewAOIManager</span>(<span style="color:#a6e22e">minx</span>, <span style="color:#a6e22e">maxx</span>, <span style="color:#a6e22e">cntsx</span>, <span style="color:#a6e22e">miny</span>, <span style="color:#a6e22e">maxy</span>, <span style="color:#a6e22e">cntsy</span> <span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">AOIManager</span> {
	<span style="color:#a6e22e">aoiMgr</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">AOIManager</span>{
		<span style="color:#a6e22e">MinX</span>:  <span style="color:#a6e22e">minx</span>,
		<span style="color:#a6e22e">MaxX</span>:  <span style="color:#a6e22e">maxx</span>,
		<span style="color:#a6e22e">CntsX</span>: <span style="color:#a6e22e">cntsx</span>,
		<span style="color:#a6e22e">MinY</span>:  <span style="color:#a6e22e">miny</span>,
		<span style="color:#a6e22e">MaxY</span>:  <span style="color:#a6e22e">maxy</span>,
		<span style="color:#a6e22e">CntsY</span>: <span style="color:#a6e22e">cntsx</span>,
		<span style="color:#a6e22e">grids</span>: make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">Grid</span>)}
	<span style="color:#75715e">//将所有的grid添加到aoi中
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">y</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">y</span> &lt; <span style="color:#a6e22e">cntsy</span>; <span style="color:#a6e22e">y</span><span style="color:#f92672">++</span> {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">x</span> &lt; <span style="color:#a6e22e">cntsx</span>; <span style="color:#a6e22e">x</span><span style="color:#f92672">++</span> {
			<span style="color:#75715e">//计算每一个grid.GID: y*cntsX+x
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">gid</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">y</span><span style="color:#f92672">*</span><span style="color:#a6e22e">cntsx</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">x</span>
			<span style="color:#75715e">//计算每一个grid.Minx:MinX + x*getWidth()
</span><span style="color:#75715e"></span>			<span style="color:#75715e">//计算每一个grid.Maxx:MinX + (x+1) * getWidth()
</span><span style="color:#75715e"></span>			<span style="color:#75715e">//计算每一个grid.Miny:MinY+ y*getLength()
</span><span style="color:#75715e"></span>			<span style="color:#75715e">//计算每一个grid.Maxy:MinY+(y+1)*getLength()
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">aoiMgr</span>.<span style="color:#a6e22e">grids</span>[<span style="color:#a6e22e">gid</span>] = <span style="color:#a6e22e">NewGrid</span>(<span style="color:#a6e22e">gid</span>,
				<span style="color:#a6e22e">aoiMgr</span>.<span style="color:#a6e22e">MinX</span><span style="color:#f92672">+</span><span style="color:#a6e22e">x</span><span style="color:#f92672">*</span><span style="color:#a6e22e">aoiMgr</span>.<span style="color:#a6e22e">GridWidth</span>(),
				<span style="color:#a6e22e">aoiMgr</span>.<span style="color:#a6e22e">MinX</span><span style="color:#f92672">+</span>(<span style="color:#a6e22e">x</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span><span style="color:#a6e22e">aoiMgr</span>.<span style="color:#a6e22e">GridWidth</span>(),
				<span style="color:#a6e22e">aoiMgr</span>.<span style="color:#a6e22e">MinY</span><span style="color:#f92672">+</span><span style="color:#a6e22e">y</span><span style="color:#f92672">*</span><span style="color:#a6e22e">aoiMgr</span>.<span style="color:#a6e22e">GridLength</span>(),
				<span style="color:#a6e22e">aoiMgr</span>.<span style="color:#a6e22e">MinY</span><span style="color:#f92672">+</span>(<span style="color:#a6e22e">y</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span><span style="color:#a6e22e">aoiMgr</span>.<span style="color:#a6e22e">GridLength</span>())
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">aoiMgr</span>
}

<span style="color:#75715e">//调试使用-打印当前AOI模块
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AOIManager</span>) <span style="color:#a6e22e">String</span>() <span style="color:#66d9ef">string</span> {
	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;AOIManager:\n MinX:%d, MaxX:%d, CntsX:%d, MinY:%d, MaxY:%d, CntsY:%d\n Grids in AOIManager:&#34;</span>,
		<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">MinX</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">MaxX</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">CntsX</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">MinY</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">MaxY</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">CntsY</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">grid</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">grids</span> {
		<span style="color:#a6e22e">s</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintln</span>(<span style="color:#a6e22e">grid</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>
}

<span style="color:#75715e">//获得x轴上每个区域的宽度
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AOIManager</span>) <span style="color:#a6e22e">GridWidth</span>() <span style="color:#66d9ef">int</span> {
	<span style="color:#66d9ef">return</span> (<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">MaxX</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">MinX</span>) <span style="color:#f92672">/</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">CntsX</span>
}

<span style="color:#75715e">//获取y轴上每个区域的高度
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AOIManager</span>) <span style="color:#a6e22e">GridLength</span>() <span style="color:#66d9ef">int</span> {
	<span style="color:#66d9ef">return</span> (<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">MaxY</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">MinY</span>) <span style="color:#f92672">/</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">CntsY</span>
}

<span style="color:#75715e">//根据格子GID得到周边九宫格格子的集合
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AOIManager</span>) <span style="color:#a6e22e">GetSurroundGridsByGid</span>(<span style="color:#a6e22e">gID</span> <span style="color:#66d9ef">int</span>) (<span style="color:#a6e22e">grids</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">Grid</span>) {
	<span style="color:#75715e">//判断gID是否在AOIManager中
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">grids</span>[<span style="color:#a6e22e">gID</span>]; !<span style="color:#a6e22e">ok</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//初始化grids返回值切片, 将gID本身将入到九宫格切片
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">grids</span> = append(<span style="color:#a6e22e">grids</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">grids</span>[<span style="color:#a6e22e">gID</span>])
	<span style="color:#75715e">//需要gID左边是否有格子，右边是否有格子
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//需要通过gID得到当前格子X的编号 idx = id % nx
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">idx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gID</span> <span style="color:#f92672">%</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">CntsX</span>

	<span style="color:#75715e">//判断左边是否还有格子 idx&gt;0 ;
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">idx</span> &gt; <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">grids</span> = append(<span style="color:#a6e22e">grids</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">grids</span>[<span style="color:#a6e22e">gID</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
	}

	<span style="color:#75715e">//判断右边是否还有格子 idx&lt; nx;
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">idx</span> &lt; <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">CntsX</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> {
		<span style="color:#a6e22e">grids</span> = append(<span style="color:#a6e22e">grids</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">grids</span>[<span style="color:#a6e22e">gID</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
	}
	<span style="color:#75715e">//将x轴的格子都取出来，进行遍历
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">gridX</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">grids</span>))
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">grids</span> {
		<span style="color:#a6e22e">gridX</span> = append(<span style="color:#a6e22e">gridX</span>, <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">GID</span>)
	}
	<span style="color:#75715e">//遍历gidX结合中每个格子的gid
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">gridX</span> {
		<span style="color:#75715e">//得到当前格子Y轴的编号
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">idy</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">CntsY</span>
		<span style="color:#75715e">//判断上边是否还有格子
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">idy</span> &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">grids</span> = append(<span style="color:#a6e22e">grids</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">grids</span>[<span style="color:#a6e22e">v</span><span style="color:#f92672">-</span><span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">CntsX</span>])
		}
		<span style="color:#75715e">//判断下边是否有格子
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">idy</span> &lt; <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">CntsY</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> {
			<span style="color:#a6e22e">grids</span> = append(<span style="color:#a6e22e">grids</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">grids</span>[<span style="color:#a6e22e">v</span><span style="color:#f92672">+</span><span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">CntsX</span>])
		}
	}
	<span style="color:#66d9ef">return</span>
}

<span style="color:#75715e">//通过横纵坐标得到当前GID
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AOIManager</span>) <span style="color:#a6e22e">GetGIDByPos</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span> <span style="color:#66d9ef">float32</span>) (<span style="color:#a6e22e">GID</span> <span style="color:#66d9ef">int</span>) {
	<span style="color:#a6e22e">idx</span> <span style="color:#f92672">:=</span> (int(<span style="color:#a6e22e">x</span>) <span style="color:#f92672">-</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">MinX</span>) <span style="color:#f92672">/</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">GridWidth</span>()
	<span style="color:#a6e22e">idy</span> <span style="color:#f92672">:=</span> (int(<span style="color:#a6e22e">y</span>) <span style="color:#f92672">-</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">MinY</span>) <span style="color:#f92672">/</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">GridLength</span>()
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">idy</span><span style="color:#f92672">*</span><span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">CntsX</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">idx</span>
}

<span style="color:#75715e">//通过横纵坐标得到周边九宫格内全部的PlayerIDs
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AOIManager</span>) <span style="color:#a6e22e">GetPidsByPos</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span> <span style="color:#66d9ef">float32</span>) (<span style="color:#a6e22e">playerIDs</span> []<span style="color:#66d9ef">int</span>) {
	<span style="color:#75715e">//得到当前玩家的GID格子id
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">gID</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">GetGIDByPos</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span>)
	<span style="color:#75715e">//通过GID得到周边九宫格信息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">grids</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">GetSurroundGridsByGid</span>(<span style="color:#a6e22e">gID</span>)
	<span style="color:#75715e">//将九宫格的信息里面的全部的Player的id，累加到playerIDs中
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">grids</span> {
		<span style="color:#a6e22e">playerIDs</span> = append(<span style="color:#a6e22e">playerIDs</span>, <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">GetPlayerIDs</span>()<span style="color:#f92672">...</span>)
	}
	<span style="color:#66d9ef">return</span>

}

<span style="color:#75715e">//添加一个PlayerID到一个格子中
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AOIManager</span>) <span style="color:#a6e22e">AddPidToGrid</span>(<span style="color:#a6e22e">pID</span>, <span style="color:#a6e22e">gID</span> <span style="color:#66d9ef">int</span>) {
	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">grids</span>[<span style="color:#a6e22e">gID</span>].<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">pID</span>)
}

<span style="color:#75715e">//移除一个格子中的PlayerID
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AOIManager</span>) <span style="color:#a6e22e">RemovePidFromGrid</span>(<span style="color:#a6e22e">pID</span>, <span style="color:#a6e22e">gID</span> <span style="color:#66d9ef">int</span>) {
	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">grids</span>[<span style="color:#a6e22e">gID</span>].<span style="color:#a6e22e">Remove</span>(<span style="color:#a6e22e">pID</span>)
}

<span style="color:#75715e">//通过GID获取全部的PlayerID
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AOIManager</span>) <span style="color:#a6e22e">GetPidsByGrid</span>(<span style="color:#a6e22e">gID</span> <span style="color:#66d9ef">int</span>) (<span style="color:#a6e22e">playerIDs</span> []<span style="color:#66d9ef">int</span>) {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">grids</span>[<span style="color:#a6e22e">gID</span>].<span style="color:#a6e22e">GetPlayerIDs</span>()
}

<span style="color:#75715e">//通过坐标将playerID添加到一个格子中
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AOIManager</span>) <span style="color:#a6e22e">AddToGridByPos</span>(<span style="color:#a6e22e">pID</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span> <span style="color:#66d9ef">float32</span>) {
	<span style="color:#a6e22e">gid</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">GetGIDByPos</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span>)
	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">grids</span>[<span style="color:#a6e22e">gid</span>].<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">pID</span>)
}

<span style="color:#75715e">//通过坐标将playerId从一个格子中移除
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AOIManager</span>) <span style="color:#a6e22e">RemoveFromGridbyPos</span>(<span style="color:#a6e22e">pID</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span> <span style="color:#66d9ef">float32</span>) {
	<span style="color:#a6e22e">gid</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">GetGIDByPos</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span>)
	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">grids</span>[<span style="color:#a6e22e">gid</span>].<span style="color:#a6e22e">Remove</span>(<span style="color:#a6e22e">pID</span>)
}
</code></pre></div><p>AOI模块单元测试</p>
<blockquote>
<p>mmo_game_zinx/core/aoi_test.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">core</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;testing&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestNewAOIManager</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#75715e">//初始化
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">aoi</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewAOIManager</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">250</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">250</span>, <span style="color:#ae81ff">5</span>)
	<span style="color:#75715e">//打印
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">aoi</span>)

}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestAOIManager_GetSurroundGridsByGid</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#75715e">//初始化
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">aoi</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewAOIManager</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">250</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">250</span>, <span style="color:#ae81ff">5</span>)

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">gid</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">aoi</span>.<span style="color:#a6e22e">grids</span> {
		<span style="color:#a6e22e">grids</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">aoi</span>.<span style="color:#a6e22e">GetSurroundGridsByGid</span>(<span style="color:#a6e22e">gid</span>)
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;gid:&#34;</span>, <span style="color:#a6e22e">gid</span>, <span style="color:#e6db74">&#34; grids len=&#34;</span>, len(<span style="color:#a6e22e">grids</span>))
		<span style="color:#a6e22e">gIDs</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">grids</span>))
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">grid</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">grids</span> {
			<span style="color:#a6e22e">gIDs</span> = append(<span style="color:#a6e22e">gIDs</span>, <span style="color:#a6e22e">grid</span>.<span style="color:#a6e22e">GID</span>)
		}
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;surrounding grid IDs are &#34;</span>, <span style="color:#a6e22e">gIDs</span>)
	}
}
</code></pre></div><h3 id="mmo使用的proto3协议">MMO使用的proto3协议</h3>
<p>同步玩家本次登录的ID(用来标识玩家)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">MsgID<span style="color:#f92672">:</span><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">SyncPid</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#66d9ef">int32</span> Pid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>世界聊天</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">MsgID<span style="color:#f92672">:</span><span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">Talk</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#66d9ef">string</span> Content<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>移动</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">MsgID<span style="color:#f92672">:</span><span style="color:#ae81ff">3</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">Position</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#66d9ef">float</span> X<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#66d9ef">float</span> Y<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#66d9ef">float</span> Z<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#66d9ef">float</span> V<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>广播消息(Tp 1 世界聊天 2 坐标(出生点同步) 3 动作 4 移动之后坐标信息更新)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">MsgID<span style="color:#f92672">:</span><span style="color:#ae81ff">200</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">BroadCast</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#66d9ef">int32</span> Pid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#66d9ef">int32</span> Tp<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#66d9ef">oneof</span> Data {<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>        <span style="color:#66d9ef">string</span> Content<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>        Position P<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>		<span style="color:#66d9ef">int32</span> ActionData<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    }<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>广播消息 掉线/aoi消失在视野</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">MsgID<span style="color:#f92672">:</span><span style="color:#ae81ff">201</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">SyncPid</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#66d9ef">int32</span> Pid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>同步周围的人位置信息(包括自己)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">MsgID<span style="color:#f92672">:</span><span style="color:#ae81ff">202</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">SyncPlayers</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#66d9ef">repeated</span> Player ps<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">Player</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#66d9ef">int32</span> Pid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>	Position P<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>定义proto文件</p>
<blockquote>
<p>mmo_game_zinx/pb/msg.proto</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">syntax<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;proto3&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> pb;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">option</span> csharp_namespace<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Pb&#34;</span>; <span style="color:#75715e">//给C#提供的选项
</span><span style="color:#75715e"></span><span style="color:#66d9ef">option</span> go_package <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./;&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">//同步玩家ID
</span><span style="color:#75715e"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">SyncPid</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">int32</span> Pid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">//服务器新生成玩家ID
</span><span style="color:#75715e"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">//位置信息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">Position</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">float</span> X<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">float</span> Y<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">float</span> Z<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">float</span> V<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">//广播消息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">BroadCast</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">int32</span> Pid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">int32</span> Tp<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>; <span style="color:#75715e">//TP-1世界聊天 2-玩家位置 3-动作 4-移动之后的坐标信息更新
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">oneof</span> Data{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">string</span> Content<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>; <span style="color:#75715e">//玩家的聊天信息
</span><span style="color:#75715e"></span>    Position P<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>;     <span style="color:#75715e">//广播玩家的位置
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int32</span> ActionData<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>; <span style="color:#75715e">//玩家具体的位置
</span><span style="color:#75715e"></span>  }<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">//世界聊天
</span><span style="color:#75715e"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">Talk</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> Content<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">//同步玩家的显示数据
</span><span style="color:#75715e"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">SyncPlayers</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">repeated</span> Player ps<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">//玩家信息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">Player</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">int32</span> Pid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  Position P<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><h3 id="构建项目">构建项目</h3>
<p>core：存放核心算法，游戏控制模块</p>
<p>conf：存放配置文件，比如zinx.json</p>
<p>api：注册一些路由业务</p>
<p>pb：存放protobuf协议文件和生成的go文件</p>
<p>创建main文件</p>
<blockquote>
<p>mmo_game_zinx/main.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)



<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//创建zinx server句柄
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#e6db74">&#34;MMO Game Zinx&#34;</span>)

	<span style="color:#75715e">//链接创建和销毁的HOOK钩子函数
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//注册一些路由业务
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//启动服务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Serve</span>()
}

</code></pre></div><p>在conf文件夹添加zinx.conf</p>
<blockquote>
<p>mmo_game_zinx/conf/zinx.json</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;MMo Game Zinx&#34;</span>,
  <span style="color:#f92672">&#34;Host&#34;</span>: <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
  <span style="color:#f92672">&#34;TcpPort&#34;</span>: <span style="color:#ae81ff">8999</span>,
  <span style="color:#f92672">&#34;MaxConn&#34;</span>: <span style="color:#ae81ff">3000</span>,
  <span style="color:#f92672">&#34;WorkerPoolSize&#34;</span>: <span style="color:#ae81ff">10</span>
}
</code></pre></div><p>在pb文件夹下添加pb文件</p>
<blockquote>
<p>mmo_game_zinx/pb/msg.proto</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf">syntax<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;proto3&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> pb;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">option</span> csharp_namespace<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Pb&#34;</span>; <span style="color:#75715e">//给C#提供的选项
</span><span style="color:#75715e"></span><span style="color:#66d9ef">option</span> go_package <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./;&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">//同步玩家ID
</span><span style="color:#75715e"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">SyncPid</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">int32</span> Pid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">//服务器新生成玩家ID
</span><span style="color:#75715e"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">//位置信息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">Position</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">float</span> X<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">float</span> Y<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">float</span> Z<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">float</span> V<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">//广播消息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">BroadCast</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">int32</span> Pid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">int32</span> Tp<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>; <span style="color:#75715e">//TP-1世界聊天 2-玩家位置 3-动作 4-移动之后的坐标信息更新
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">oneof</span> Data{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">string</span> Content<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>; <span style="color:#75715e">//玩家的聊天信息
</span><span style="color:#75715e"></span>    Position P<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>;     <span style="color:#75715e">//广播玩家的位置
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int32</span> ActionData<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>; <span style="color:#75715e">//玩家具体的位置
</span><span style="color:#75715e"></span>  }<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">//世界聊天
</span><span style="color:#75715e"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">Talk</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> Content<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">//同步玩家的显示数据
</span><span style="color:#75715e"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">SyncPlayers</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">repeated</span> Player ps<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">//玩家信息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">Player</span>{<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">int32</span> Pid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  Position P<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>使用protoc生成文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">protoc</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">go_out</span>=. <span style="color:#f92672">*</span>.<span style="color:#a6e22e">proto</span>
</code></pre></div><h4 id="用户上线">用户上线</h4>
<p>创建player玩家模块</p>
<blockquote>
<p>mmo_game_zinx/core/player.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">core</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/golang/protobuf/proto&#34;</span>
	<span style="color:#e6db74">&#34;math/rand&#34;</span>
	<span style="color:#a6e22e">pb</span> <span style="color:#e6db74">&#34;mmo_game_zinx/pb&#34;</span>
	<span style="color:#e6db74">&#34;sync&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * player玩家
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Player</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Pid</span>  <span style="color:#66d9ef">int32</span>              <span style="color:#75715e">//玩家ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span> <span style="color:#75715e">//当前玩家的链接(用于和客户端的链接)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">X</span>    <span style="color:#66d9ef">float32</span>            <span style="color:#75715e">//平面的X坐标
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Y</span>    <span style="color:#66d9ef">float32</span>            <span style="color:#75715e">//高度
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Z</span>    <span style="color:#66d9ef">float32</span>            <span style="color:#75715e">//平面的y坐标
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">V</span>    <span style="color:#66d9ef">float32</span>            <span style="color:#75715e">//旋转的角度 0 -360
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">//PlayerID 生成器
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">PidGen</span> <span style="color:#66d9ef">int32</span> = <span style="color:#ae81ff">1</span>  <span style="color:#75715e">//用来生产玩家ID
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">IdLock</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span> <span style="color:#75715e">//保护PidGen的互斥锁
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//初始化玩家信息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewPlayer</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span> {
	<span style="color:#75715e">//生成玩家ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IdLock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">PidGen</span>
	<span style="color:#a6e22e">PidGen</span><span style="color:#f92672">++</span>
	<span style="color:#a6e22e">IdLock</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Player</span>{
		<span style="color:#a6e22e">Pid</span>:  <span style="color:#a6e22e">id</span>,
		<span style="color:#a6e22e">Conn</span>: <span style="color:#a6e22e">conn</span>,
		<span style="color:#a6e22e">X</span>:    float32(<span style="color:#ae81ff">160</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">10</span>)), <span style="color:#75715e">//随机生成X坐标
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Y</span>:    <span style="color:#ae81ff">0</span>,
		<span style="color:#a6e22e">Z</span>:    float32(<span style="color:#ae81ff">140</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">20</span>)), <span style="color:#75715e">//随机生产Y坐标
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">V</span>:    <span style="color:#ae81ff">0</span>,
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>
}


<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 提供一个发送给客户端消息的方法
</span><span style="color:#75715e"> * 主要将pb的protobuf数据格式序列化之后，调用zinx的SendMsg方法
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">SendMsg</span>(<span style="color:#a6e22e">msgid</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">data</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Message</span>) {
	<span style="color:#75715e">//将protobuf数据 转成二进制
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">data</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;proto message marsal error&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>

	}
	<span style="color:#75715e">//调用zinx的SendMsg方法
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Conn</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;connection  in player is nil&#34;</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#a6e22e">msgid</span>, <span style="color:#a6e22e">msg</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Player SendMsg error&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
}

<span style="color:#75715e">//实现SyncPid功能
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">SyncPid</span>() {
	<span style="color:#75715e">//构建protobuf message格式
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">SyncPid</span>{
		<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>,
	}
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">proto_msg</span>)
}
<span style="color:#75715e">//实现BroadCastStartPostion功能
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">BroadCastStartPostion</span>() {
	<span style="color:#75715e">//构建格式
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast</span>{
		<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>,
		<span style="color:#a6e22e">Tp</span>:  <span style="color:#ae81ff">2</span>,
		<span style="color:#a6e22e">Data</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast_P</span>{
			<span style="color:#a6e22e">P</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Position</span>{
				<span style="color:#a6e22e">X</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">X</span>,
				<span style="color:#a6e22e">Y</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Y</span>,
				<span style="color:#a6e22e">Z</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Z</span>,
				<span style="color:#a6e22e">V</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">V</span>,
			},
		},
	}

	<span style="color:#75715e">//发送数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">proto_msg</span>)
}
</code></pre></div><p>在main入口，绑定一个hook方法</p>
<blockquote>
<p>mmo_game_zinx/main.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;mmo_game_zinx/core&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)

<span style="color:#75715e">//客户端建立之后的hook函数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">OnConnectionAdd</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>) {
	<span style="color:#75715e">//创建一个对象
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">core</span>.<span style="color:#a6e22e">NewPlayer</span>(<span style="color:#a6e22e">conn</span>)
	<span style="color:#75715e">//发送msg:1的消息，同步当前player的id给客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">SyncPid</span>()
	<span style="color:#75715e">//发送msg:200的消息，同步当前player的初始位置客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">BroadCastStartPostion</span>()
	
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;=============&gt;Player pid =&#34;</span>, <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Pid</span>, <span style="color:#e6db74">&#34; is arrived &lt;=============&#34;</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//创建zinx server句柄
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#e6db74">&#34;MMO Game Zinx&#34;</span>)

	<span style="color:#75715e">//链接创建和销毁的HOOK钩子函数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">SetOnConnStart</span>(<span style="color:#a6e22e">OnConnectionAdd</span>)
	<span style="color:#75715e">//启动服务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Serve</span>()
}
</code></pre></div><h4 id="世界聊天">世界聊天</h4>
<p>创建一个管理所有玩家的管理器</p>
<blockquote>
<p>mmo_game_zinx/core/world_mananger.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">core</span>

<span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;sync&#34;</span>

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 当前游戏的世界总管理模块
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">WorldManager</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">//当前AOI的管理模块
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">AoiMgr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AOIManager</span>
	<span style="color:#75715e">//当前全部在线的player集合
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Players</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int32</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>
	<span style="color:#75715e">//保护player集合的锁
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pLock</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">RWMutex</span>
}

<span style="color:#75715e">//初始化方法，创建一个，唯一的，全局的对外的世界管理模块
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">WorldMgrObj</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">WorldManager</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">init</span>() {
	<span style="color:#a6e22e">WorldMgrObj</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">WorldManager</span>{
		<span style="color:#a6e22e">AoiMgr</span>:  <span style="color:#a6e22e">NewAOIManager</span>(<span style="color:#a6e22e">AOI_MIN_X</span>, <span style="color:#a6e22e">AOI_MAX_X</span>, <span style="color:#a6e22e">AOI_CNTS_X</span>, <span style="color:#a6e22e">AOI_MIN_Y</span>, <span style="color:#a6e22e">AOI_MAX_Y</span>, <span style="color:#a6e22e">AOI_CNTS_Y</span>),
		<span style="color:#a6e22e">Players</span>: make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int32</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>),
	}
}

<span style="color:#75715e">//添加一个玩家
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">wm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">WorldManager</span>) <span style="color:#a6e22e">AddPlayer</span>(<span style="color:#a6e22e">player</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) {
	<span style="color:#a6e22e">wm</span>.<span style="color:#a6e22e">pLock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#a6e22e">wm</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Pid</span>] = <span style="color:#a6e22e">player</span>
	<span style="color:#a6e22e">wm</span>.<span style="color:#a6e22e">pLock</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#75715e">//将当前player添加到AOIManager中
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">wm</span>.<span style="color:#a6e22e">AoiMgr</span>.<span style="color:#a6e22e">AddToGridByPos</span>(int(<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Pid</span>), <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">X</span>, <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Z</span>)
}

<span style="color:#75715e">//删除一个玩家
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">wm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">WorldManager</span>) <span style="color:#a6e22e">RemovePlayerByPid</span>(<span style="color:#a6e22e">pid</span> <span style="color:#66d9ef">int32</span>) {
	<span style="color:#75715e">//得到当前玩家
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">wm</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#a6e22e">pid</span>]
	<span style="color:#75715e">//将玩家从AOIManager中删除
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">wm</span>.<span style="color:#a6e22e">AoiMgr</span>.<span style="color:#a6e22e">RemoveFromGridbyPos</span>(int(<span style="color:#a6e22e">pid</span>), <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">X</span>, <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Z</span>)
	<span style="color:#75715e">//将玩家从世界管理中删除
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">wm</span>.<span style="color:#a6e22e">pLock</span>.<span style="color:#a6e22e">Lock</span>()
	delete(<span style="color:#a6e22e">wm</span>.<span style="color:#a6e22e">Players</span>, <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Pid</span>)
	<span style="color:#a6e22e">wm</span>.<span style="color:#a6e22e">pLock</span>.<span style="color:#a6e22e">Unlock</span>()
}

<span style="color:#75715e">//通过玩家ID查询player对象
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">wm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">WorldManager</span>) <span style="color:#a6e22e">GetPlayerByPid</span>(<span style="color:#a6e22e">pid</span> <span style="color:#66d9ef">int32</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span> {
	<span style="color:#a6e22e">wm</span>.<span style="color:#a6e22e">pLock</span>.<span style="color:#a6e22e">RLock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wm</span>.<span style="color:#a6e22e">pLock</span>.<span style="color:#a6e22e">RUnlock</span>()
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">wm</span>.<span style="color:#a6e22e">Players</span>[<span style="color:#a6e22e">pid</span>]
}

<span style="color:#75715e">//获取全部在线玩家
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">wm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">WorldManager</span>) <span style="color:#a6e22e">GetALLPlayers</span>() []<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span> {
	<span style="color:#a6e22e">wm</span>.<span style="color:#a6e22e">pLock</span>.<span style="color:#a6e22e">RLock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wm</span>.<span style="color:#a6e22e">pLock</span>.<span style="color:#a6e22e">RUnlock</span>()
	<span style="color:#a6e22e">players</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>, <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">wm</span>.<span style="color:#a6e22e">Players</span> {
		<span style="color:#a6e22e">players</span> = append(<span style="color:#a6e22e">players</span>, <span style="color:#a6e22e">v</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">players</span>
}
</code></pre></div><p>在上线的时候，将玩家添加到世界管理中</p>
<blockquote>
<p>mmo_game_zinx/main.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;mmo_game_zinx/core&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)

<span style="color:#75715e">//客户端建立之后的hook函数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">OnConnectionAdd</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>) {
	<span style="color:#75715e">//创建一个对象
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">core</span>.<span style="color:#a6e22e">NewPlayer</span>(<span style="color:#a6e22e">conn</span>)
	<span style="color:#75715e">//发送msg:1的消息，同步当前player的id给客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">SyncPid</span>()
	<span style="color:#75715e">//发送msg:200的消息，同步当前player的初始位置客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">BroadCastStartPostion</span>()
	<span style="color:#75715e">//新上线的玩家添加到worldmanager中
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">core</span>.<span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">AddPlayer</span>(<span style="color:#a6e22e">player</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;=============&gt;Player pid =&#34;</span>, <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Pid</span>, <span style="color:#e6db74">&#34; is arrived &lt;=============&#34;</span>)
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//创建zinx server句柄
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#e6db74">&#34;MMO Game Zinx&#34;</span>)

	<span style="color:#75715e">//链接创建和销毁的HOOK钩子函数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">SetOnConnStart</span>(<span style="color:#a6e22e">OnConnectionAdd</span>)
	<span style="color:#75715e">//注册一些路由业务
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//启动服务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Serve</span>()
}
</code></pre></div><p>创建聊天业务</p>
<blockquote>
<p>mmo_game_zinx/api_world_chat.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">apis</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/golang/protobuf/proto&#34;</span>
	<span style="color:#e6db74">&#34;mmo_game_zinx/core&#34;</span>
	<span style="color:#a6e22e">pb</span> <span style="color:#e6db74">&#34;mmo_game_zinx/pb&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)

<span style="color:#75715e">//世界聊天 路由业务
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">WorldChatApi</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">BaseRouter</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">wc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">WorldChatApi</span>) <span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>) {
	<span style="color:#75715e">//1、解析客户端传进来的proto
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Talk</span>{}
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetData</span>(), <span style="color:#a6e22e">proto_msg</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Talk Unmarshal error:&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//2、当前的聊天数据是属于哪个玩家发送的
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pid</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetConnection</span>().<span style="color:#a6e22e">GetProperty</span>(<span style="color:#e6db74">&#34;pid&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;get pid error&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//3、根据pid获取到player对象
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">core</span>.<span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">GetPlayerByPid</span>(<span style="color:#a6e22e">pid</span>.(<span style="color:#66d9ef">int32</span>))
	<span style="color:#75715e">//4、将消息广播给其他全部在线的玩家
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Talk</span>(<span style="color:#a6e22e">proto_msg</span>.<span style="color:#a6e22e">Content</span>)
}
</code></pre></div><p>实现player的talk方法；在此之前需要在创建连接的hook方法中绑定一下pid</p>
<blockquote>
<p>mmo_game_zinx/main.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;mmo_game_zinx/apis&#34;</span>
	<span style="color:#e6db74">&#34;mmo_game_zinx/core&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)

<span style="color:#75715e">//客户端建立之后的hook函数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">OnConnectionAdd</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>) {
	<span style="color:#75715e">//创建一个对象
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">core</span>.<span style="color:#a6e22e">NewPlayer</span>(<span style="color:#a6e22e">conn</span>)
	<span style="color:#75715e">//发送msg:1的消息，同步当前player的id给客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">SyncPid</span>()
	<span style="color:#75715e">//发送msg:200的消息，同步当前player的初始位置客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">BroadCastStartPostion</span>()
	<span style="color:#75715e">//新上线的玩家添加到worldmanager中
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">core</span>.<span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">AddPlayer</span>(<span style="color:#a6e22e">player</span>)
	<span style="color:#75715e">//将该链接绑定一个pid玩家
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">SetProperty</span>(<span style="color:#e6db74">&#34;pid&#34;</span>, <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Pid</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;=============&gt;Player pid =&#34;</span>, <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Pid</span>, <span style="color:#e6db74">&#34; is arrived &lt;=============&#34;</span>)
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//创建zinx server句柄
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#e6db74">&#34;MMO Game Zinx&#34;</span>)

	<span style="color:#75715e">//链接创建和销毁的HOOK钩子函数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">SetOnConnStart</span>(<span style="color:#a6e22e">OnConnectionAdd</span>)
	<span style="color:#75715e">//注册一些路由业务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">AddRouter</span>(<span style="color:#ae81ff">2</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">apis</span>.<span style="color:#a6e22e">WorldChatApi</span>{})
	<span style="color:#75715e">//启动服务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Serve</span>()
}
</code></pre></div><p>在player中实现Talk方法</p>
<blockquote>
<p>mmo_game_zinx/core/player.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">core</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/golang/protobuf/proto&#34;</span>
	<span style="color:#e6db74">&#34;math/rand&#34;</span>
	<span style="color:#a6e22e">pb</span> <span style="color:#e6db74">&#34;mmo_game_zinx/pb&#34;</span>
	<span style="color:#e6db74">&#34;sync&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * player玩家
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Player</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Pid</span>  <span style="color:#66d9ef">int32</span>              <span style="color:#75715e">//玩家ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span> <span style="color:#75715e">//当前玩家的链接(用于和客户端的链接)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">X</span>    <span style="color:#66d9ef">float32</span>            <span style="color:#75715e">//平面的X坐标
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Y</span>    <span style="color:#66d9ef">float32</span>            <span style="color:#75715e">//高度
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Z</span>    <span style="color:#66d9ef">float32</span>            <span style="color:#75715e">//平面的y坐标
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">V</span>    <span style="color:#66d9ef">float32</span>            <span style="color:#75715e">//旋转的角度 0 -360
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">//PlayerID 生成器
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">PidGen</span> <span style="color:#66d9ef">int32</span> = <span style="color:#ae81ff">1</span>  <span style="color:#75715e">//用来生产玩家ID
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">IdLock</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span> <span style="color:#75715e">//保护PidGen的互斥锁
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//初始化玩家信息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewPlayer</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span> {
	<span style="color:#75715e">//生成玩家ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IdLock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">PidGen</span>
	<span style="color:#a6e22e">PidGen</span><span style="color:#f92672">++</span>
	<span style="color:#a6e22e">IdLock</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Player</span>{
		<span style="color:#a6e22e">Pid</span>:  <span style="color:#a6e22e">id</span>,
		<span style="color:#a6e22e">Conn</span>: <span style="color:#a6e22e">conn</span>,
		<span style="color:#a6e22e">X</span>:    float32(<span style="color:#ae81ff">160</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">10</span>)), <span style="color:#75715e">//随机生成X坐标
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Y</span>:    <span style="color:#ae81ff">0</span>,
		<span style="color:#a6e22e">Z</span>:    float32(<span style="color:#ae81ff">140</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">20</span>)), <span style="color:#75715e">//随机生产Y坐标
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">V</span>:    <span style="color:#ae81ff">0</span>,
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>
}

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 提供一个发送给客户端消息的方法
</span><span style="color:#75715e"> * 主要将pb的protobuf数据格式序列化之后，调用zinx的SendMsg方法
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">SendMsg</span>(<span style="color:#a6e22e">msgid</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">data</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Message</span>) {
	<span style="color:#75715e">//将protobuf数据 转成二进制
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">data</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;proto message marsal error&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>

	}
	<span style="color:#75715e">//调用zinx的SendMsg方法
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Conn</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;connection  in player is nil&#34;</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#a6e22e">msgid</span>, <span style="color:#a6e22e">msg</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Player SendMsg error&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
}

<span style="color:#75715e">//实现SyncPid功能
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">SyncPid</span>() {
	<span style="color:#75715e">//构建protobuf message格式
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">SyncPid</span>{
		<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>,
	}
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">proto_msg</span>)
}

<span style="color:#75715e">//实现BroadCastStartPostion功能
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">BroadCastStartPostion</span>() {
	<span style="color:#75715e">//构建格式
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast</span>{
		<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>,
		<span style="color:#a6e22e">Tp</span>:  <span style="color:#ae81ff">2</span>,
		<span style="color:#a6e22e">Data</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast_P</span>{
			<span style="color:#a6e22e">P</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Position</span>{
				<span style="color:#a6e22e">X</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">X</span>,
				<span style="color:#a6e22e">Y</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Y</span>,
				<span style="color:#a6e22e">Z</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Z</span>,
				<span style="color:#a6e22e">V</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">V</span>,
			},
		},
	}

	<span style="color:#75715e">//发送数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">proto_msg</span>)
}

<span style="color:#75715e">//玩家广播世界聊天消息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">Talk</span>(<span style="color:#a6e22e">content</span> <span style="color:#66d9ef">string</span>) {
	<span style="color:#75715e">//1、组件MsgId:200 的protobuf数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast</span>{
		<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>,
		<span style="color:#a6e22e">Tp</span>:  <span style="color:#ae81ff">1</span>,
		<span style="color:#a6e22e">Data</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast_Content</span>{
			<span style="color:#a6e22e">Content</span>: <span style="color:#a6e22e">content</span>,
		},
	}
	<span style="color:#75715e">//2、得到当前世界所有的在线玩家
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">players</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">GetALLPlayers</span>()
	<span style="color:#75715e">//3、向所有的玩家，包括自己发送200消息
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">players</span> {
		<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">proto_msg</span>)
	}
}
</code></pre></div><h4 id="上线位置同步">上线位置同步</h4>
<p>在player提供同步位置的方法</p>
<blockquote>
<p>mmo_game_zinx/core/player.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">core</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/golang/protobuf/proto&#34;</span>
	<span style="color:#e6db74">&#34;math/rand&#34;</span>
	<span style="color:#a6e22e">pb</span> <span style="color:#e6db74">&#34;mmo_game_zinx/pb&#34;</span>
	<span style="color:#e6db74">&#34;sync&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * player玩家
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Player</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Pid</span>  <span style="color:#66d9ef">int32</span>              <span style="color:#75715e">//玩家ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span> <span style="color:#75715e">//当前玩家的链接(用于和客户端的链接)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">X</span>    <span style="color:#66d9ef">float32</span>            <span style="color:#75715e">//平面的X坐标
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Y</span>    <span style="color:#66d9ef">float32</span>            <span style="color:#75715e">//高度
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Z</span>    <span style="color:#66d9ef">float32</span>            <span style="color:#75715e">//平面的y坐标
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">V</span>    <span style="color:#66d9ef">float32</span>            <span style="color:#75715e">//旋转的角度 0 -360
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">//PlayerID 生成器
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">PidGen</span> <span style="color:#66d9ef">int32</span> = <span style="color:#ae81ff">1</span>  <span style="color:#75715e">//用来生产玩家ID
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">IdLock</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span> <span style="color:#75715e">//保护PidGen的互斥锁
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//初始化玩家信息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewPlayer</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span> {
	<span style="color:#75715e">//生成玩家ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IdLock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">PidGen</span>
	<span style="color:#a6e22e">PidGen</span><span style="color:#f92672">++</span>
	<span style="color:#a6e22e">IdLock</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Player</span>{
		<span style="color:#a6e22e">Pid</span>:  <span style="color:#a6e22e">id</span>,
		<span style="color:#a6e22e">Conn</span>: <span style="color:#a6e22e">conn</span>,
		<span style="color:#a6e22e">X</span>:    float32(<span style="color:#ae81ff">160</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">10</span>)), <span style="color:#75715e">//随机生成X坐标
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Y</span>:    <span style="color:#ae81ff">0</span>,
		<span style="color:#a6e22e">Z</span>:    float32(<span style="color:#ae81ff">140</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">20</span>)), <span style="color:#75715e">//随机生产Y坐标
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">V</span>:    <span style="color:#ae81ff">0</span>,
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>
}

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 提供一个发送给客户端消息的方法
</span><span style="color:#75715e"> * 主要将pb的protobuf数据格式序列化之后，调用zinx的SendMsg方法
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">SendMsg</span>(<span style="color:#a6e22e">msgid</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">data</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Message</span>) {
	<span style="color:#75715e">//将protobuf数据 转成二进制
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">data</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;proto message marsal error&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>

	}
	<span style="color:#75715e">//调用zinx的SendMsg方法
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Conn</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;connection  in player is nil&#34;</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#a6e22e">msgid</span>, <span style="color:#a6e22e">msg</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Player SendMsg error&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
}

<span style="color:#75715e">//实现SyncPid功能
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">SyncPid</span>() {
	<span style="color:#75715e">//构建protobuf message格式
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">SyncPid</span>{
		<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>,
	}
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">proto_msg</span>)
}

<span style="color:#75715e">//实现BroadCastStartPostion功能
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">BroadCastStartPostion</span>() {
	<span style="color:#75715e">//构建格式
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast</span>{
		<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>,
		<span style="color:#a6e22e">Tp</span>:  <span style="color:#ae81ff">2</span>,
		<span style="color:#a6e22e">Data</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast_P</span>{
			<span style="color:#a6e22e">P</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Position</span>{
				<span style="color:#a6e22e">X</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">X</span>,
				<span style="color:#a6e22e">Y</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Y</span>,
				<span style="color:#a6e22e">Z</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Z</span>,
				<span style="color:#a6e22e">V</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">V</span>,
			},
		},
	}

	<span style="color:#75715e">//发送数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">proto_msg</span>)
}

<span style="color:#75715e">//玩家广播世界聊天消息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">Talk</span>(<span style="color:#a6e22e">content</span> <span style="color:#66d9ef">string</span>) {
	<span style="color:#75715e">//1、组件MsgId:200 的protobuf数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast</span>{
		<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>,
		<span style="color:#a6e22e">Tp</span>:  <span style="color:#ae81ff">1</span>,
		<span style="color:#a6e22e">Data</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast_Content</span>{
			<span style="color:#a6e22e">Content</span>: <span style="color:#a6e22e">content</span>,
		},
	}
	<span style="color:#75715e">//2、得到当前世界所有的在线玩家
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">players</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">GetALLPlayers</span>()
	<span style="color:#75715e">//3、向所有的玩家，包括自己发送200消息
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">players</span> {
		<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">proto_msg</span>)
	}
}

<span style="color:#75715e">//同步玩家上线的位置信息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">SyncSurrounding</span>() {
	<span style="color:#75715e">//1、获取当前玩家所在九宫格的所有玩家
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pids</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">AoiMgr</span>.<span style="color:#a6e22e">GetPidsByPos</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">X</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Z</span>)
	<span style="color:#a6e22e">players</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">pids</span>))
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">pid</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">pids</span> {
		<span style="color:#a6e22e">players</span> = append(<span style="color:#a6e22e">players</span>, <span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">GetPlayerByPid</span>(int32(<span style="color:#a6e22e">pid</span>)))
	}
	<span style="color:#75715e">//2、将当前玩家的位置信息通过MsgID:200 发给周围的玩家（让其他玩家看到自己）
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//2.1组建proto数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast</span>{
		<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>,
		<span style="color:#a6e22e">Tp</span>:  <span style="color:#ae81ff">2</span>,
		<span style="color:#a6e22e">Data</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast_P</span>{
			<span style="color:#a6e22e">P</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Position</span>{
				<span style="color:#a6e22e">X</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">X</span>,
				<span style="color:#a6e22e">Y</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Y</span>,
				<span style="color:#a6e22e">Z</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Z</span>,
				<span style="color:#a6e22e">V</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">V</span>,
			},
		},
	}
	<span style="color:#75715e">//2.2全部周围的玩家都向各自的客户端发送200消息，proto_msg
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">players</span> {
		<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">proto_msg</span>)
	}
	<span style="color:#75715e">//3、将周围的全部玩家的位置信息发送给当前玩家MsgID:202
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//3.1 组建 MsgID:202的proto数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">players_proto_msg</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Player</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">players</span>))
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">players</span> {
		<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Player</span>{
			<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Pid</span>,
			<span style="color:#a6e22e">P</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Position</span>{
				<span style="color:#a6e22e">X</span>: <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">X</span>,
				<span style="color:#a6e22e">Y</span>: <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Y</span>,
				<span style="color:#a6e22e">Z</span>: <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Z</span>,
				<span style="color:#a6e22e">V</span>: <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">V</span>,
			},
		}
		<span style="color:#a6e22e">players_proto_msg</span> = append(<span style="color:#a6e22e">players_proto_msg</span>, <span style="color:#a6e22e">p</span>)
	}
	<span style="color:#75715e">//封装syncPlayer消息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SyncPlayer_proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">SyncPlayers</span>{
		<span style="color:#a6e22e">Ps</span>: <span style="color:#a6e22e">players_proto_msg</span>[:],
	}
	<span style="color:#75715e">//3.2发送
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">202</span>, <span style="color:#a6e22e">SyncPlayer_proto_msg</span>)
}
</code></pre></div><p>在创建客户端的hook中同步周边玩家上线信息</p>
<blockquote>
<p>mmo_game_zinx/main.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;mmo_game_zinx/core&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)

<span style="color:#75715e">//客户端建立之后的hook函数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">OnConnectionAdd</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>) {
	<span style="color:#75715e">//创建一个对象
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">core</span>.<span style="color:#a6e22e">NewPlayer</span>(<span style="color:#a6e22e">conn</span>)
	<span style="color:#75715e">//发送msg:1的消息，同步当前player的id给客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">SyncPid</span>()
	<span style="color:#75715e">//发送msg:200的消息，同步当前player的初始位置客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">BroadCastStartPostion</span>()
	<span style="color:#75715e">//新上线的玩家添加到worldmanager中
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">core</span>.<span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">AddPlayer</span>(<span style="color:#a6e22e">player</span>)
	<span style="color:#75715e">//将该链接绑定一个pid玩家
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">SetProperty</span>(<span style="color:#e6db74">&#34;pid&#34;</span>, <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Pid</span>)
	<span style="color:#75715e">//将位置同步
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">SyncSurrounding</span>()
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;=============&gt;Player pid =&#34;</span>, <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Pid</span>, <span style="color:#e6db74">&#34; is arrived &lt;=============&#34;</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//创建zinx server句柄
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#e6db74">&#34;MMO Game Zinx&#34;</span>)

	<span style="color:#75715e">//链接创建和销毁的HOOK钩子函数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">SetOnConnStart</span>(<span style="color:#a6e22e">OnConnectionAdd</span>)
	<span style="color:#75715e">//注册一些路由业务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">AddRouter</span>(<span style="color:#ae81ff">2</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">apis</span>.<span style="color:#a6e22e">WorldChatApi</span>{})
	<span style="color:#75715e">//启动服务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Serve</span>()
}
</code></pre></div><h4 id="移动位置与aoi广播">移动位置与AOI广播</h4>
<p>创建移动的api接口move</p>
<blockquote>
<p>mmo_game_zinx/api/move.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">apis</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/golang/protobuf/proto&#34;</span>
	<span style="color:#e6db74">&#34;mmo_game_zinx/core&#34;</span>
	<span style="color:#a6e22e">pb</span> <span style="color:#e6db74">&#34;mmo_game_zinx/pb&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MoveApi</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">BaseRouter</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">ma</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MoveApi</span>) <span style="color:#a6e22e">Handle</span>(<span style="color:#a6e22e">request</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IRequest</span>) {
	<span style="color:#75715e">//接收请求
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Position</span>{}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetData</span>(), <span style="color:#a6e22e">proto_msg</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Move Msg Unmarsl error&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//获取当前发送消息的用户ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pid</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">GetConnection</span>().<span style="color:#a6e22e">GetProperty</span>(<span style="color:#e6db74">&#34;pid&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;get pid error&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#75715e">//根据pid获取player
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">core</span>.<span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">GetPlayerByPid</span>(<span style="color:#a6e22e">pid</span>.(<span style="color:#66d9ef">int32</span>))
	<span style="color:#75715e">//发送广播消息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">UpdatePos</span>(<span style="color:#a6e22e">proto_msg</span>.<span style="color:#a6e22e">X</span>, <span style="color:#a6e22e">proto_msg</span>.<span style="color:#a6e22e">Y</span>, <span style="color:#a6e22e">proto_msg</span>.<span style="color:#a6e22e">Z</span>, <span style="color:#a6e22e">proto_msg</span>.<span style="color:#a6e22e">V</span>)

}
</code></pre></div><p>在main中注册路由</p>
<blockquote>
<p>mmo_game_zinx/main.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;mmo_game_zinx/apis&#34;</span>
	<span style="color:#e6db74">&#34;mmo_game_zinx/core&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)

<span style="color:#75715e">//客户端建立之后的hook函数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">OnConnectionAdd</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>) {
	<span style="color:#75715e">//创建一个对象
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">core</span>.<span style="color:#a6e22e">NewPlayer</span>(<span style="color:#a6e22e">conn</span>)
	<span style="color:#75715e">//发送msg:1的消息，同步当前player的id给客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">SyncPid</span>()
	<span style="color:#75715e">//发送msg:200的消息，同步当前player的初始位置客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">BroadCastStartPostion</span>()
	<span style="color:#75715e">//新上线的玩家添加到worldmanager中
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">core</span>.<span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">AddPlayer</span>(<span style="color:#a6e22e">player</span>)
	<span style="color:#75715e">//将该链接绑定一个pid玩家
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">SetProperty</span>(<span style="color:#e6db74">&#34;pid&#34;</span>, <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Pid</span>)
	<span style="color:#75715e">//将位置同步
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">SyncSurrounding</span>()
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;=============&gt;Player pid =&#34;</span>, <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Pid</span>, <span style="color:#e6db74">&#34; is arrived &lt;=============&#34;</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//创建zinx server句柄
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#e6db74">&#34;MMO Game Zinx&#34;</span>)

	<span style="color:#75715e">//链接创建和销毁的HOOK钩子函数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">SetOnConnStart</span>(<span style="color:#a6e22e">OnConnectionAdd</span>)
	<span style="color:#75715e">//注册一些路由业务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">AddRouter</span>(<span style="color:#ae81ff">2</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">apis</span>.<span style="color:#a6e22e">WorldChatApi</span>{})
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">AddRouter</span>(<span style="color:#ae81ff">3</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">apis</span>.<span style="color:#a6e22e">MoveApi</span>{})
	<span style="color:#75715e">//启动服务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Serve</span>()
}

</code></pre></div><p>在player中添加UpdatePos方法</p>
<blockquote>
<p>mmo_game_zinx/core/player.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">core</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/golang/protobuf/proto&#34;</span>
	<span style="color:#e6db74">&#34;math/rand&#34;</span>
	<span style="color:#a6e22e">pb</span> <span style="color:#e6db74">&#34;mmo_game_zinx/pb&#34;</span>
	<span style="color:#e6db74">&#34;sync&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * player玩家
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Player</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Pid</span>  <span style="color:#66d9ef">int32</span>              <span style="color:#75715e">//玩家ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span> <span style="color:#75715e">//当前玩家的链接(用于和客户端的链接)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">X</span>    <span style="color:#66d9ef">float32</span>            <span style="color:#75715e">//平面的X坐标
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Y</span>    <span style="color:#66d9ef">float32</span>            <span style="color:#75715e">//高度
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Z</span>    <span style="color:#66d9ef">float32</span>            <span style="color:#75715e">//平面的y坐标
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">V</span>    <span style="color:#66d9ef">float32</span>            <span style="color:#75715e">//旋转的角度 0 -360
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">//PlayerID 生成器
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">PidGen</span> <span style="color:#66d9ef">int32</span> = <span style="color:#ae81ff">1</span>  <span style="color:#75715e">//用来生产玩家ID
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">IdLock</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span> <span style="color:#75715e">//保护PidGen的互斥锁
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//初始化玩家信息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewPlayer</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span> {
	<span style="color:#75715e">//生成玩家ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IdLock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">PidGen</span>
	<span style="color:#a6e22e">PidGen</span><span style="color:#f92672">++</span>
	<span style="color:#a6e22e">IdLock</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Player</span>{
		<span style="color:#a6e22e">Pid</span>:  <span style="color:#a6e22e">id</span>,
		<span style="color:#a6e22e">Conn</span>: <span style="color:#a6e22e">conn</span>,
		<span style="color:#a6e22e">X</span>:    float32(<span style="color:#ae81ff">160</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">10</span>)), <span style="color:#75715e">//随机生成X坐标
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Y</span>:    <span style="color:#ae81ff">0</span>,
		<span style="color:#a6e22e">Z</span>:    float32(<span style="color:#ae81ff">140</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">20</span>)), <span style="color:#75715e">//随机生产Y坐标
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">V</span>:    <span style="color:#ae81ff">0</span>,
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>
}

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 提供一个发送给客户端消息的方法
</span><span style="color:#75715e"> * 主要将pb的protobuf数据格式序列化之后，调用zinx的SendMsg方法
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">SendMsg</span>(<span style="color:#a6e22e">msgid</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">data</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Message</span>) {
	<span style="color:#75715e">//将protobuf数据 转成二进制
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">data</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;proto message marsal error&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>

	}
	<span style="color:#75715e">//调用zinx的SendMsg方法
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Conn</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;connection  in player is nil&#34;</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#a6e22e">msgid</span>, <span style="color:#a6e22e">msg</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Player SendMsg error&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
}

<span style="color:#75715e">//实现SyncPid功能
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">SyncPid</span>() {
	<span style="color:#75715e">//构建protobuf message格式
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">SyncPid</span>{
		<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>,
	}
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">proto_msg</span>)
}

<span style="color:#75715e">//实现BroadCastStartPostion功能
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">BroadCastStartPostion</span>() {
	<span style="color:#75715e">//构建格式
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast</span>{
		<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>,
		<span style="color:#a6e22e">Tp</span>:  <span style="color:#ae81ff">2</span>,
		<span style="color:#a6e22e">Data</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast_P</span>{
			<span style="color:#a6e22e">P</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Position</span>{
				<span style="color:#a6e22e">X</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">X</span>,
				<span style="color:#a6e22e">Y</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Y</span>,
				<span style="color:#a6e22e">Z</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Z</span>,
				<span style="color:#a6e22e">V</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">V</span>,
			},
		},
	}

	<span style="color:#75715e">//发送数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">proto_msg</span>)
}

<span style="color:#75715e">//玩家广播世界聊天消息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">Talk</span>(<span style="color:#a6e22e">content</span> <span style="color:#66d9ef">string</span>) {
	<span style="color:#75715e">//1、组件MsgId:200 的protobuf数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast</span>{
		<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>,
		<span style="color:#a6e22e">Tp</span>:  <span style="color:#ae81ff">1</span>,
		<span style="color:#a6e22e">Data</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast_Content</span>{
			<span style="color:#a6e22e">Content</span>: <span style="color:#a6e22e">content</span>,
		},
	}
	<span style="color:#75715e">//2、得到当前世界所有的在线玩家
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">players</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">GetALLPlayers</span>()
	<span style="color:#75715e">//3、向所有的玩家，包括自己发送200消息
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">players</span> {
		<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">proto_msg</span>)
	}
}

<span style="color:#75715e">//同步玩家上线的位置信息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">SyncSurrounding</span>() {
	<span style="color:#75715e">//1、获取当前玩家所在九宫格的所有玩家
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pids</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">AoiMgr</span>.<span style="color:#a6e22e">GetPidsByPos</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">X</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Z</span>)
	<span style="color:#a6e22e">players</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">pids</span>))
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">pid</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">pids</span> {
		<span style="color:#a6e22e">players</span> = append(<span style="color:#a6e22e">players</span>, <span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">GetPlayerByPid</span>(int32(<span style="color:#a6e22e">pid</span>)))
	}
	<span style="color:#75715e">//2、将当前玩家的位置信息通过MsgID:200 发给周围的玩家（让其他玩家看到自己）
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//2.1组建proto数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast</span>{
		<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>,
		<span style="color:#a6e22e">Tp</span>:  <span style="color:#ae81ff">2</span>,
		<span style="color:#a6e22e">Data</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast_P</span>{
			<span style="color:#a6e22e">P</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Position</span>{
				<span style="color:#a6e22e">X</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">X</span>,
				<span style="color:#a6e22e">Y</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Y</span>,
				<span style="color:#a6e22e">Z</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Z</span>,
				<span style="color:#a6e22e">V</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">V</span>,
			},
		},
	}
	<span style="color:#75715e">//2.2全部周围的玩家都向各自的客户端发送200消息，proto_msg
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">players</span> {
		<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">proto_msg</span>)
	}
	<span style="color:#75715e">//3、将周围的全部玩家的位置信息发送给当前玩家MsgID:202
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//3.1 组建 MsgID:202的proto数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">players_proto_msg</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Player</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">players</span>))
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">players</span> {
		<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Player</span>{
			<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Pid</span>,
			<span style="color:#a6e22e">P</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Position</span>{
				<span style="color:#a6e22e">X</span>: <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">X</span>,
				<span style="color:#a6e22e">Y</span>: <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Y</span>,
				<span style="color:#a6e22e">Z</span>: <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Z</span>,
				<span style="color:#a6e22e">V</span>: <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">V</span>,
			},
		}
		<span style="color:#a6e22e">players_proto_msg</span> = append(<span style="color:#a6e22e">players_proto_msg</span>, <span style="color:#a6e22e">p</span>)
	}
	<span style="color:#75715e">//封装syncPlayer消息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SyncPlayer_proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">SyncPlayers</span>{
		<span style="color:#a6e22e">Ps</span>: <span style="color:#a6e22e">players_proto_msg</span>[:],
	}
	<span style="color:#75715e">//3.2发送
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">202</span>, <span style="color:#a6e22e">SyncPlayer_proto_msg</span>)
}

<span style="color:#75715e">//给用户发送移动位置的消息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">UpdatePos</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span>, <span style="color:#a6e22e">z</span>, <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">float32</span>) {
	<span style="color:#75715e">//更新当前玩家坐标
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">X</span> = <span style="color:#a6e22e">x</span>
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Y</span> = <span style="color:#a6e22e">y</span>
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Z</span> = <span style="color:#a6e22e">z</span>
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">V</span> = <span style="color:#a6e22e">v</span>
	<span style="color:#75715e">//组建msgId:200 tp-4的消息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast</span>{
		<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>,
		<span style="color:#a6e22e">Tp</span>:  <span style="color:#ae81ff">4</span>,
		<span style="color:#a6e22e">Data</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast_P</span>{
			<span style="color:#a6e22e">P</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Position</span>{
				<span style="color:#a6e22e">X</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">X</span>,
				<span style="color:#a6e22e">Y</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Y</span>,
				<span style="color:#a6e22e">Z</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Z</span>,
				<span style="color:#a6e22e">V</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">V</span>,
			},
		},
	}
	<span style="color:#75715e">//获取周围的所有玩家
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">players</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">GetSurroundingPlayers</span>()
	<span style="color:#75715e">//发送更新坐标的信息
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">players</span> {
		<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">proto_msg</span>)
	}
}

<span style="color:#75715e">//获取周围的所有玩家
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">GetSurroundingPlayers</span>() []<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span> {
	<span style="color:#75715e">//得到周围的所有pid
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pids</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">AoiMgr</span>.<span style="color:#a6e22e">GetPidsByPos</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">X</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Z</span>)
	<span style="color:#75715e">//根据pid得到player
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">players</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">pids</span>))
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">pid</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">pids</span> {
		<span style="color:#a6e22e">players</span> = append(<span style="color:#a6e22e">players</span>, <span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">GetPlayerByPid</span>(int32(<span style="color:#a6e22e">pid</span>)))
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">players</span>
}
</code></pre></div><h4 id="下线通知">下线通知</h4>
<p>在main中注册客户端断开连接时候的hook函数</p>
<blockquote>
<p>mmo_game_zinx/main.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;mmo_game_zinx/apis&#34;</span>
	<span style="color:#e6db74">&#34;mmo_game_zinx/core&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
	<span style="color:#e6db74">&#34;zinx/znet&#34;</span>
)

<span style="color:#75715e">//客户端建立之后的hook函数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">OnConnectionAdd</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>) {
	<span style="color:#75715e">//创建一个对象
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">core</span>.<span style="color:#a6e22e">NewPlayer</span>(<span style="color:#a6e22e">conn</span>)
	<span style="color:#75715e">//发送msg:1的消息，同步当前player的id给客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">SyncPid</span>()
	<span style="color:#75715e">//发送msg:200的消息，同步当前player的初始位置客户端
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">BroadCastStartPostion</span>()
	<span style="color:#75715e">//新上线的玩家添加到worldmanager中
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">core</span>.<span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">AddPlayer</span>(<span style="color:#a6e22e">player</span>)
	<span style="color:#75715e">//将该链接绑定一个pid玩家
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">SetProperty</span>(<span style="color:#e6db74">&#34;pid&#34;</span>, <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Pid</span>)
	<span style="color:#75715e">//将位置同步
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">SyncSurrounding</span>()
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;=============&gt;Player pid =&#34;</span>, <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Pid</span>, <span style="color:#e6db74">&#34; is arrived &lt;=============&#34;</span>)
}

<span style="color:#75715e">//客户端断开之前的hook函数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">OnConnectionLost</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>) {
	<span style="color:#75715e">//获取是哪个玩家
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pid</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">GetProperty</span>(<span style="color:#e6db74">&#34;pid&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;get pid error &#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">core</span>.<span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">GetPlayerByPid</span>(<span style="color:#a6e22e">pid</span>.(<span style="color:#66d9ef">int32</span>))
	<span style="color:#75715e">//调用下线方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">OffLine</span>()
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">//创建zinx server句柄
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">znet</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#e6db74">&#34;MMO Game Zinx&#34;</span>)

	<span style="color:#75715e">//链接创建和销毁的HOOK钩子函数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">SetOnConnStart</span>(<span style="color:#a6e22e">OnConnectionAdd</span>)
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">SetOnConnStop</span>(<span style="color:#a6e22e">OnConnectionLost</span>)
	<span style="color:#75715e">//注册一些路由业务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">AddRouter</span>(<span style="color:#ae81ff">2</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">apis</span>.<span style="color:#a6e22e">WorldChatApi</span>{})
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">AddRouter</span>(<span style="color:#ae81ff">3</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">apis</span>.<span style="color:#a6e22e">MoveApi</span>{})
	<span style="color:#75715e">//启动服务
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Serve</span>()
}
</code></pre></div><p>给player添加一个下线方法</p>
<blockquote>
<p>mmo_game_zinx/core/player.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">core</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/golang/protobuf/proto&#34;</span>
	<span style="color:#e6db74">&#34;math/rand&#34;</span>
	<span style="color:#a6e22e">pb</span> <span style="color:#e6db74">&#34;mmo_game_zinx/pb&#34;</span>
	<span style="color:#e6db74">&#34;sync&#34;</span>
	<span style="color:#e6db74">&#34;zinx/ziface&#34;</span>
)

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * player玩家
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Player</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Pid</span>  <span style="color:#66d9ef">int32</span>              <span style="color:#75715e">//玩家ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span> <span style="color:#75715e">//当前玩家的链接(用于和客户端的链接)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">X</span>    <span style="color:#66d9ef">float32</span>            <span style="color:#75715e">//平面的X坐标
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Y</span>    <span style="color:#66d9ef">float32</span>            <span style="color:#75715e">//高度
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Z</span>    <span style="color:#66d9ef">float32</span>            <span style="color:#75715e">//平面的y坐标
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">V</span>    <span style="color:#66d9ef">float32</span>            <span style="color:#75715e">//旋转的角度 0 -360
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">//PlayerID 生成器
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">PidGen</span> <span style="color:#66d9ef">int32</span> = <span style="color:#ae81ff">1</span>  <span style="color:#75715e">//用来生产玩家ID
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">IdLock</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span> <span style="color:#75715e">//保护PidGen的互斥锁
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//初始化玩家信息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewPlayer</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IConnection</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span> {
	<span style="color:#75715e">//生成玩家ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IdLock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">PidGen</span>
	<span style="color:#a6e22e">PidGen</span><span style="color:#f92672">++</span>
	<span style="color:#a6e22e">IdLock</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Player</span>{
		<span style="color:#a6e22e">Pid</span>:  <span style="color:#a6e22e">id</span>,
		<span style="color:#a6e22e">Conn</span>: <span style="color:#a6e22e">conn</span>,
		<span style="color:#a6e22e">X</span>:    float32(<span style="color:#ae81ff">160</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">10</span>)), <span style="color:#75715e">//随机生成X坐标
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Y</span>:    <span style="color:#ae81ff">0</span>,
		<span style="color:#a6e22e">Z</span>:    float32(<span style="color:#ae81ff">140</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">20</span>)), <span style="color:#75715e">//随机生产Y坐标
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">V</span>:    <span style="color:#ae81ff">0</span>,
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>
}

<span style="color:#75715e">/**
</span><span style="color:#75715e"> * 提供一个发送给客户端消息的方法
</span><span style="color:#75715e"> * 主要将pb的protobuf数据格式序列化之后，调用zinx的SendMsg方法
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">SendMsg</span>(<span style="color:#a6e22e">msgid</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">data</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Message</span>) {
	<span style="color:#75715e">//将protobuf数据 转成二进制
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">data</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;proto message marsal error&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>

	}
	<span style="color:#75715e">//调用zinx的SendMsg方法
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Conn</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;connection  in player is nil&#34;</span>)
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Conn</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#a6e22e">msgid</span>, <span style="color:#a6e22e">msg</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Player SendMsg error&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}
}

<span style="color:#75715e">//实现SyncPid功能
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">SyncPid</span>() {
	<span style="color:#75715e">//构建protobuf message格式
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">SyncPid</span>{
		<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>,
	}
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">proto_msg</span>)
}

<span style="color:#75715e">//实现BroadCastStartPostion功能
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">BroadCastStartPostion</span>() {
	<span style="color:#75715e">//构建格式
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast</span>{
		<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>,
		<span style="color:#a6e22e">Tp</span>:  <span style="color:#ae81ff">2</span>,
		<span style="color:#a6e22e">Data</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast_P</span>{
			<span style="color:#a6e22e">P</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Position</span>{
				<span style="color:#a6e22e">X</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">X</span>,
				<span style="color:#a6e22e">Y</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Y</span>,
				<span style="color:#a6e22e">Z</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Z</span>,
				<span style="color:#a6e22e">V</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">V</span>,
			},
		},
	}

	<span style="color:#75715e">//发送数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">proto_msg</span>)
}

<span style="color:#75715e">//玩家广播世界聊天消息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">Talk</span>(<span style="color:#a6e22e">content</span> <span style="color:#66d9ef">string</span>) {
	<span style="color:#75715e">//1、组件MsgId:200 的protobuf数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast</span>{
		<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>,
		<span style="color:#a6e22e">Tp</span>:  <span style="color:#ae81ff">1</span>,
		<span style="color:#a6e22e">Data</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast_Content</span>{
			<span style="color:#a6e22e">Content</span>: <span style="color:#a6e22e">content</span>,
		},
	}
	<span style="color:#75715e">//2、得到当前世界所有的在线玩家
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">players</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">GetALLPlayers</span>()
	<span style="color:#75715e">//3、向所有的玩家，包括自己发送200消息
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">players</span> {
		<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">proto_msg</span>)
	}
}

<span style="color:#75715e">//同步玩家上线的位置信息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">SyncSurrounding</span>() {
	<span style="color:#75715e">//1、获取当前玩家所在九宫格的所有玩家
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pids</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">AoiMgr</span>.<span style="color:#a6e22e">GetPidsByPos</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">X</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Z</span>)
	<span style="color:#a6e22e">players</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">pids</span>))
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">pid</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">pids</span> {
		<span style="color:#a6e22e">players</span> = append(<span style="color:#a6e22e">players</span>, <span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">GetPlayerByPid</span>(int32(<span style="color:#a6e22e">pid</span>)))
	}
	<span style="color:#75715e">//2、将当前玩家的位置信息通过MsgID:200 发给周围的玩家（让其他玩家看到自己）
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//2.1组建proto数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast</span>{
		<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>,
		<span style="color:#a6e22e">Tp</span>:  <span style="color:#ae81ff">2</span>,
		<span style="color:#a6e22e">Data</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast_P</span>{
			<span style="color:#a6e22e">P</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Position</span>{
				<span style="color:#a6e22e">X</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">X</span>,
				<span style="color:#a6e22e">Y</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Y</span>,
				<span style="color:#a6e22e">Z</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Z</span>,
				<span style="color:#a6e22e">V</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">V</span>,
			},
		},
	}
	<span style="color:#75715e">//2.2全部周围的玩家都向各自的客户端发送200消息，proto_msg
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">players</span> {
		<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">proto_msg</span>)
	}
	<span style="color:#75715e">//3、将周围的全部玩家的位置信息发送给当前玩家MsgID:202
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//3.1 组建 MsgID:202的proto数据
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">players_proto_msg</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Player</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">players</span>))
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">players</span> {
		<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Player</span>{
			<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Pid</span>,
			<span style="color:#a6e22e">P</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Position</span>{
				<span style="color:#a6e22e">X</span>: <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">X</span>,
				<span style="color:#a6e22e">Y</span>: <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Y</span>,
				<span style="color:#a6e22e">Z</span>: <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">Z</span>,
				<span style="color:#a6e22e">V</span>: <span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">V</span>,
			},
		}
		<span style="color:#a6e22e">players_proto_msg</span> = append(<span style="color:#a6e22e">players_proto_msg</span>, <span style="color:#a6e22e">p</span>)
	}
	<span style="color:#75715e">//封装syncPlayer消息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SyncPlayer_proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">SyncPlayers</span>{
		<span style="color:#a6e22e">Ps</span>: <span style="color:#a6e22e">players_proto_msg</span>[:],
	}
	<span style="color:#75715e">//3.2发送
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">202</span>, <span style="color:#a6e22e">SyncPlayer_proto_msg</span>)
}

<span style="color:#75715e">//给用户发送移动位置的消息
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">UpdatePos</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span>, <span style="color:#a6e22e">z</span>, <span style="color:#a6e22e">v</span> <span style="color:#66d9ef">float32</span>) {
	<span style="color:#75715e">//更新当前玩家坐标
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">X</span> = <span style="color:#a6e22e">x</span>
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Y</span> = <span style="color:#a6e22e">y</span>
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Z</span> = <span style="color:#a6e22e">z</span>
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">V</span> = <span style="color:#a6e22e">v</span>
	<span style="color:#75715e">//组建msgId:200 tp-4的消息
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast</span>{
		<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>,
		<span style="color:#a6e22e">Tp</span>:  <span style="color:#ae81ff">4</span>,
		<span style="color:#a6e22e">Data</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">BroadCast_P</span>{
			<span style="color:#a6e22e">P</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Position</span>{
				<span style="color:#a6e22e">X</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">X</span>,
				<span style="color:#a6e22e">Y</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Y</span>,
				<span style="color:#a6e22e">Z</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Z</span>,
				<span style="color:#a6e22e">V</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">V</span>,
			},
		},
	}
	<span style="color:#75715e">//获取周围的所有玩家
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">players</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">GetSurroundingPlayers</span>()
	<span style="color:#75715e">//发送更新坐标的信息
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">players</span> {
		<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">200</span>, <span style="color:#a6e22e">proto_msg</span>)
	}
}

<span style="color:#75715e">//获取周围的所有玩家
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">GetSurroundingPlayers</span>() []<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span> {
	<span style="color:#75715e">//得到周围的所有pid
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pids</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">AoiMgr</span>.<span style="color:#a6e22e">GetPidsByPos</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">X</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Z</span>)
	<span style="color:#75715e">//根据pid得到player
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">players</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">pids</span>))
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">pid</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">pids</span> {
		<span style="color:#a6e22e">players</span> = append(<span style="color:#a6e22e">players</span>, <span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">GetPlayerByPid</span>(int32(<span style="color:#a6e22e">pid</span>)))
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">players</span>
}

<span style="color:#75715e">//调用下线方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Player</span>) <span style="color:#a6e22e">OffLine</span>() {
	<span style="color:#75715e">//获取当前九宫格所有的玩家
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">players</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">GetSurroundingPlayers</span>()
	<span style="color:#75715e">//组建MsgID:201的proto格式
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proto_msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">SyncPid</span>{
		<span style="color:#a6e22e">Pid</span>: <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>,
	}
	<span style="color:#75715e">//给所有的玩家发送下线消息
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">player</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">players</span> {
		<span style="color:#a6e22e">player</span>.<span style="color:#a6e22e">SendMsg</span>(<span style="color:#ae81ff">201</span>, <span style="color:#a6e22e">proto_msg</span>)
	}
	<span style="color:#75715e">//从世界管理中删除当前用户
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">AoiMgr</span>.<span style="color:#a6e22e">RemoveFromGridbyPos</span>(int(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>), <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">X</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Z</span>)
	<span style="color:#a6e22e">WorldMgrObj</span>.<span style="color:#a6e22e">RemovePlayerByPid</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Pid</span>)
}
</code></pre></div><h3 id="效果演示">效果演示</h3>
<p>上线以及位置同步：</p>
<p>
        <img class="mx-auto" alt="image-20220411163547061" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/202204111635503.png" />   
    </p>
<p>聊天：</p>
<p>
        <img class="mx-auto" alt="image-20220411163854943" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/202204111638308.png" />   
    </p>
<p>移动：</p>
<p>玩家在移动的时候，会不停的给服务端发送MsgId=3的消息</p>
<p>
        <img class="mx-auto" alt="image-20220411164154944" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/202204111641158.png" />   
    </p>
<p>下线：</p>
<p>player2下线，能够正常在player1的视野中消失。</p>
<p>
        <img class="mx-auto" alt="image-20220411164215673" src="https://cdn.jsdelivr.net/gh/kevinbin123/pics/imgs/202204111642979.png" />   
    </p>

        </div>

        


        

<div class="post-archive">
    <h2>相关文章</h2>
    <ul class="listing">
        
        <li><a href="/post/Golang%E5%B0%8F%E6%A1%88%E4%BE%8B-%E7%88%AC%E5%8F%96%E8%B1%86%E7%93%A3%E7%94%B5%E5%BD%B1/">Golang小案例 爬取豆瓣电影</a></li>
        
        <li><a href="/post/go-micro%E6%A1%88%E4%BE%8B/">Go Micro案例</a></li>
        
        <li><a href="/post/go-micro%E7%AC%94%E8%AE%B0/">Go Micro笔记</a></li>
        
        <li><a href="/post/grpc%E7%AC%94%E8%AE%B0/">Grpc笔记</a></li>
        
        <li><a href="/post/RPC%E7%AC%94%E8%AE%B0/">RPC笔记</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/Golang' target="_blank">Golang</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    
    

</div>

                    <footer id="footer">
    <div class="container">
        &copy; 2023 <a href="https://kevinbin123.github.io/">abin の 成长之路 By abin</a>.本站博客未经授权禁止转载.
		<br>
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="http://www.flysnow.org/" target="_blank">Theme</a> based on <a href="https://github.com/rujews/maupassant-hugo" target="_blank">maupassant</a>
		       
    </div>
</footer>


    
    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>
<style type="text/css">
div.highlight {
    position: relative;
    margin: 1em 0px;
}

.copy-code {
    display: none;
    position: absolute;
    top: 4px;
    right: 4px;
    color: rgba(255, 255, 255, 0.8);
    background: rgba(78, 78, 78, 0.8);
    border-radius: var(--radius);
    padding: 0 5px;
    font: inherit;
    user-select: none;
    cursor: pointer;
    border: 0;
    --radius: 8px;
}

div.highlight:hover .copy-code,pre:hover .copy-code {
    display: block;
}

</style>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>


    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




    <script src='/js/bootstrap.min.js'></script>

    <script src='/js/post_category.1.js'></script>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://kevinbin123.github.io/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://kevinbin123.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>

    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://kevinbin123.github.io/post/%E7%AE%80%E5%8D%95%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/" title="简单分布式系统" target="_blank">简单分布式系统</a>
    </li>
    
    <li>
        <a href="https://kevinbin123.github.io/post/fyne%E6%A1%88%E4%BE%8B%E4%B9%8B%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8/" title="Fyne案例之音乐播放器" target="_blank">Fyne案例之音乐播放器</a>
    </li>
    
    <li>
        <a href="https://kevinbin123.github.io/post/fyne%E6%A1%88%E4%BE%8B%E4%B9%8B%E6%8E%A5%E4%BD%8F%E4%BD%A0%E5%B0%8F%E6%B8%B8%E6%88%8F/" title="Fyne案例之接住你小游戏" target="_blank">Fyne案例之接住你小游戏</a>
    </li>
    
    <li>
        <a href="https://kevinbin123.github.io/post/gin&#43;vue2%E5%8D%9A%E5%AE%A2%E7%AC%94%E8%AE%B0%E5%89%8D%E7%AB%AF/" title="Gin&#43;vue2博客笔记（前端）" target="_blank">Gin&#43;vue2博客笔记（前端）</a>
    </li>
    
    <li>
        <a href="https://kevinbin123.github.io/post/gin&#43;vue2%E5%8D%9A%E5%AE%A2%E7%AC%94%E8%AE%B0%E5%90%8E%E7%AB%AF/" title="Gin&#43;vue2博客笔记（后端）" target="_blank">Gin&#43;vue2博客笔记（后端）</a>
    </li>
    
    <li>
        <a href="https://kevinbin123.github.io/post/PWA%E7%AC%94%E8%AE%B0/" title="PWA笔记" target="_blank">PWA笔记</a>
    </li>
    
    <li>
        <a href="https://kevinbin123.github.io/post/Golang%E6%A1%88%E4%BE%8B-zinx%E8%BD%BB%E9%87%8F%E7%BA%A7%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Golang案例 Zinx轻量级服务器框架学习笔记" target="_blank">Golang案例 Zinx轻量级服务器框架学习笔记</a>
    </li>
    
    <li>
        <a href="https://kevinbin123.github.io/post/Golang%E5%B0%8F%E6%A1%88%E4%BE%8B-%E7%88%AC%E5%8F%96%E8%B1%86%E7%93%A3%E7%94%B5%E5%BD%B1/" title="Golang小案例 爬取豆瓣电影" target="_blank">Golang小案例 爬取豆瓣电影</a>
    </li>
    
    <li>
        <a href="https://kevinbin123.github.io/post/go-micro%E6%A1%88%E4%BE%8B/" title="Go Micro案例" target="_blank">Go Micro案例</a>
    </li>
    
    <li>
        <a href="https://kevinbin123.github.io/post/go-micro%E7%AC%94%E8%AE%B0/" title="Go Micro笔记" target="_blank">Go Micro笔记</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://kevinbin123.github.io/categories/DB/">DB (2)</a></li>
    
    <li><a href="https://kevinbin123.github.io/categories/Golang/">Golang (19)</a></li>
    
    <li><a href="https://kevinbin123.github.io/categories/JavaScript/">JavaScript (1)</a></li>
    
    <li><a href="https://kevinbin123.github.io/categories/Network/">Network (1)</a></li>
    
    <li><a href="https://kevinbin123.github.io/categories/container/">container (1)</a></li>
    
    <li><a href="https://kevinbin123.github.io/categories/other/">other (5)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://kevinbin123.github.io/tags/DB/">DB</a>
    
    <a href="https://kevinbin123.github.io/tags/Golang/">Golang</a>
    
    <a href="https://kevinbin123.github.io/tags/JavaScript/">JavaScript</a>
    
    <a href="https://kevinbin123.github.io/tags/Network/">Network</a>
    
    <a href="https://kevinbin123.github.io/tags/container/">container</a>
    
    <a href="https://kevinbin123.github.io/tags/other/">other</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://www.liwenzhou.com/" title="go语言学习之路">李文周的博客</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://kevinbin123.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>